<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <title>试卷预览</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="author" content="nop">
  <meta name="generator" content="wkhtmltopdf">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
  <link rel="shortcut icon" href="./static/favicon.ico" />
  <!-- <link rel="stylesheet" href="./css/paperView.css"> -->
  <style>
    .calc-con {
      visibility: hidden;
    }
    .nop-page>.nop-page-content table {
      word-break: normal;
    }
    
    /* svg 样式 */
    .svg-con {
      display: block !important;
      width: 210mm;
      margin: 0 auto;
    }

    .svg-con svg {
      margin-bottom: 8px;
      background-color: #fff;
    }
  </style>
</head>

<body>
  <div id="content-box" style="display: none">
   
    
    <div data-op-type="new-page"></div>
    <div data-op-type="mix-box">
      <div class="nop-fill-box paper-con"></div>
    </div>

  </div>
  <div class="calc-con"></div>
  <div class="svg-con" id="svgCon"></div>
  <div class="model-con">试卷预览生成中，请稍后</div>
  

  <script src="./static/pdfrender/jquery.min.js"></script>
  <script src="./static/pdfrender/patch.min.js"></script>
  <script src="./static/pdfrender/lodash.min.js"></script>
  <script src="./static/pdfrender/pdfjs/latest/bookjs-eazy.min.js"></script>

  <script type="text/javascript" src="./js/jquery.base64.js"></script>
  <script type="text/javascript" src="./js/uritdate.js"></script>
  <script type="text/javascript" src="./js/bamboo.core.base.js"></script>
  <script type="text/javascript" src="./js/Pub_ViewComp.js"></script>
  <script type="text/javascript" src="./js/Pub_ViewProj.js"></script>
  <script type="text/javascript" src="./static/tinymce/tkDate.js"></script>
  <script type="text/javascript" src="./js/previewCom.js" id="previewComScript"></script>
  <!-- <script type="text/javascript" src="./js/paperCom.js"></script> -->
  <script type="text/javascript" src="./js/TkDomPosition.js"></script>
  
  <script>
    loadConfigFile()
    // bookjs 配置
    bookConfig = {
      "pageSize": pageMap.paper.name,
      "orientation": "portrait",// portrait/landscape 定义纸张是竖屏/横屏放置
      // pageSizeOption : {
      //   width : '210mm', // 自定义宽高
      //   height : '297mm',
      // },
      // 可选,高度修复选项。
      // 不同的浏览器在打印时PDF有可能出现每页都多出空白页
      // 常用于自定义未适配的纸张。 
      // 通过此值调节修正
      pageFixedHeightOffset: 0, // 单位mm,一般为负值
      "padding": pageMap.padding,
      // 可选，文本内容在跨页差分时，不会出现在段首的字符，所列选项为默认值
      textNoBreakChars: ['，', '。', '：', '”', '！', '？', '、', '；', '》', '】', '…', '.', ',', '!', ']', '}', '｝'],
      "simpleCatalog": {
        "positionSelector": ".pendant-title:first",
        "showCatalog": false,
      },
      "simplePageNum": {
        "pageBegin": 0,   // 从第几页开始编号，默认0为第一页开始
        "pageEnd": -1,// 从第几页结束编号，默认-1为最后一页结束
        "pendant": "<div style=\"height: 4cm; \" class=\"page-num-simple\"><span style=\"color: #000;\">试题卷第${PAGE}页（共${TOTAL_PAGE}页）</span></div>"
      },

      // 目录/书签插件，可选（默认未开启），所列选项为开启时的默认值
      simpleCatalog: {
        // 当前版本，如果需要生成PDF书签，toolBar.serverPrint.wkHtmlToPdf 必须为true
        // titlesSelector不要修改，使用h1-h6标记书签
        // titlesSelector : 'h1,h2,h3,h4,h5,h6', // 可选，作为目录标题的选择器，按目录级别依次


        /** 目录相关选项 **/
        showCatalog: false, // 可选，是否在页面中插入目录，默认，插入目录到页面
        header: '<div class="catalog-title">目 录</div>', // 可选，目录页Header部分，放入你想加入的一切
        itemFillChar: '…', // 可选，目录项填充字符, ""空字符串，不填充，使用自定义makeItem时，忽略该选项配置
        positionSelector: '.nop-page-item-pagenum-1', //可选，目录位置会插入在匹配页的之前，默认为第一个编号页前
        // 可选，自定义目录项。
        makeItem: function (itemEl, itemInfo) {
          /** 
            * @var itemEl jQuery Element 
            * @var object itemInfo PS: {title, pageNum, level,linkId}
            **/
          return '<div>自定义的目录项html内容，根据itemInfo自己构造</div>';
        },

        /** 侧边栏（PDF书签）相关选项 **/
        showSlide: false, // 可选，是否显示侧边栏，目录导航，工具栏按钮顺序index: 200, 在bookConfig.toolBar选项为false时无效
        slideOn: false, // 可选，目录导航，默认是否打开状态
        slideHeader: '<div class="title">目&nbsp;&nbsp;录</div>', // 可选，侧边栏标题
        slideClassName: '', // 可选，侧边栏自定义class
        slidePosition: 'left', // 可选，位置 left、right
        slideMakeContent: null, // 自定义侧边栏内容处理函数，为null时,默认行为：使用目录内容填充， function(){ return '侧边栏内容';}
      },

      "toolBar": {
        "serverPrint": false,
        "webPrint": true,
        saveHtml: false,
        buttons: [
          // 这里可以自定义工具栏按钮
          // {
          //    id : 'cloudPrint',
          //    index : 1, // 按钮位置顺序，小的显示在前面，系统内置按钮index值，见各配置项说明。
          //    icon : 'https://xxxx.../aa.png'
          //    onClick : function(){ console.log("...do some thing"); }
          // }
        ],
      },
      "start": false
    }

    // 设置排版 前 渲染页面内容
    var d1 = $.Deferred();
    function renderPaper() {
      setFooter()
      // 处理试卷数据成html内容，放到calc-con 中
      dealPaperDataOfcalcCon(dealImg)
    }

    // 数据处理后，回到方法,设置排版 后试卷页面内容
    function setPaperHtmlStr(paperHtml, paperEditVersion) {
      if (paperEditVersion == 3) {
        $('#svgCon').html(paperHtml)
        // svg格式试卷增加打印按钮
        let printBtn = `<div id="toolbar" class="toolbar expend nop-noprint  right">
          <span title="打印" class="tool-item svg-print" data-index="100" style="display: block">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAwElEQVRYR+2W4Q2CMBCFv87jEgxhXEeZTBlCh2AJzRlrmohwhR4HSfsX2vflvbtrA84rOOujAXguhBzVqAC7cGBhCYxv1zhgDnABjsDBVOn38BvQiQNXoFlZPMrdBSD2eQsIVQ+cgPMaUCmARPD4iIoj4oz52hSAewTmdg8JpBFUgM07kDu2Ve+InBowA9COYguA9yjWXkalAb6X0VTxxSznAhR7E1aA6oC7A1Pd8u97sS5wA5grrNqXm6vq0JyfXo4OMr9kDLyAAAAAAElFTkSuQmCC" alt="">
          </span>
        </div>`
        $('body').append(printBtn)
        // setDate()
      } else {
        $('.paper-con').html(paperHtml)
        setFooter()
        // setDate()
        $('.paper-con').find('.mce-pagebreak').parent().replaceWith('<div data-op-type="new-page"></div>')
        var imgArr = $('img');
        if (imgArr.length == 0) {
          d1.resolve();
        } else {
          imgArr.load(function () {
            d1.resolve();
          })

          imgArr.error(function () {
            d1.resolve();
          });
        }
      }
      $('.model-con').remove()
      $('body').addClass('loadOver')
    }
    
    $.when(d1).then(function () {
      /** 2个图表渲染完毕后，执行PDF Book渲染 **/
      bookConfig.start = true;
    });
    

    /** * BOOK渲染完成前    book.before-complete**/
    $(document).on('book.before-complete', function (e, info) {
      // $("body").addClass("loadOver")
      if(viewType == 'layout'){
      window.parent.postMessage({loadOverCls: 'loadOver'}, "*");
      }else{
        $('body').addClass('loadOver')
      }
    })

    // 打印
    function printSvg() {
      var printContent = document.getElementById('svgCon').innerHTML;
      printCon(printContent)
    }
    $(document).keydown(function(e){
      if (e.ctrlKey && e.keyCode === 80 && paperContentType == 'htmlStr') {
        printSvg()
        return false
      }
    })
    $('body').on('click', '.svg-print', function() {
      printSvg()
    })
    // 接收试卷数据
    // window.onmessage = function(e) {
    //   getPaperData(renderPaper, setPaperHtmlStr, e.data)
    // }

    if(viewType == 'layout'){
      // 接收试卷数据
      window.onmessage = function(e) {
        getPaperData(renderPaper, setPaperHtmlStr, e.data)
      }
    }else if(project =="hn_mt" && viewType == 'single'){

      $.post("/queryPaperStructure/queryPaper.do?paperId="+paperId+"&flag=1&activityId="+ activityId,{},
        function(res,status){
          let paper = res?.ret?.[0].subItemTypeStructure
          if (paper) {
            dealPaperData(paper, 'part1')
            let paperData = {
              paper,
              subject: res?.ret?.[0]?.subjectName??'',
              comType: 'page',
            }
            getPaperData(renderPaper, setPaperHtmlStr, paperData)
          }

        });
    }


    // 处理答案数据
function dealPaperData(paperData, type) {
  if (arrJudge(paperData)) {
    paperData.forEach((_p, _pIndex) => {
      if (['part1', 'part2'].includes(type)) {
        _p['menuInfoType'] = 1
        /**
         * 单元
         * 1.如果单元下没有子单元，则该单元显示大题处理
        */
        if(type == 'part1') {
          if (!arrJudge(_p.childrenStructures) && _p.type == 1) {
            _p.type = 2
          }
        }
      }
      // 试题处理
      if (['items', 'childItems'].includes(type)) {
        Object.assign(_p, _p.item)
        delete _p.item
        _p.paperItemNum = _p.paperItemNum || (_pIndex+1)+''
      }


      let innerDatas = [], innerType = ''
      // 单元下大题处理赋值
      if (arrJudge(_p.childrenStructures)) {
        _p['childrenPaperPriewVOs'] = _p.childrenStructures
        innerDatas = _p.childrenStructures
        innerType = 'part2'
        delete _p.childrenStructures
      }
      // 试题列表处理赋值
      if (arrJudge(_p.items)) {
        _p['itemList'] = _p.items
        innerDatas = _p.items
        innerType = 'items'
        delete _p.items
      }
      // 子题列表处理赋值
      if (arrJudge(_p.childItem)) {
        _p['childItemList'] = _p.childItem
        innerDatas = _p.childItem
        innerType = 'childItems'
        delete _p.childItem
      }
      dealPaperData(innerDatas, innerType)
    });
  }
}

  //组卷并长度大于0判断
  function arrJudge(arr) {
    if (arr && arr instanceof Array && arr.length > 0) return true;
    else return false;
  }

  </script>
</body>

</html>
