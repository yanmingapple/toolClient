<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <title>答案预览生成中……</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="author" content="nop">
  <meta name="generator" content="wkhtmltopdf">
  <meta name="description" content="">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">

  <script src="./static/pdfrender/jquery.min.js"></script>
  <script src="./static/pdfrender/patch.min.js"></script>
  <script src="./static/pdfrender/lodash.min.js"></script>
  <script src="./static/pdfrender/pdfjs/latest/bookjs-eazy.min.js"></script>
  <style>
    .nop-book {
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="content-box" style="display: none">
    <div data-op-type="new-page"></div>
    <div data-op-type="mix-box">
      <div class="nop-fill-box paper-con"></div>
    </div>
  </div>
  <div class="calc-con"></div>

  <script type="text/javascript" src="./js/previewCom.js" id="previewComScript"></script>
  <!-- <script type="text/javascript" src="./js/paperAnswerCom.js"></script> -->
  <script>
    loadConfigFile('answer')
    
    var bookConfig = {
      "pageSize": pageMap.paper.name,
      "orientation": "portrait",// portrait/landscape 定义纸张是竖屏/横屏放置

      // 可选,高度修复选项。
      // 不同的浏览器在打印时PDF有可能出现每页都多出空白页
      // 常用于自定义未适配的纸张。 
      // 通过此值调节修正
      pageFixedHeightOffset: 0, // 单位mm,一般为负值
      "padding": pageMap.padding,
      // 可选，文本内容在跨页差分时，不会出现在段首的字符，所列选项为默认值
      textNoBreakChars: ['，', '。', '：', '”', '！', '？', '、', '；', '》', '】', '…', '.', ',', '!', ']', '}', '｝'],
      "simpleCatalog": {
        "positionSelector": ".pendant-title:first",
        "showCatalog": false,
      },
      "simplePageNum": {
        "pageBegin": 0,   // 从第几页开始编号，默认0为第一页开始
        "pageEnd": -1,// 从第几页结束编号，默认-1为最后一页结束
        "pendant": "<div style=\"padding-bottom: 34mm;left: 0px;width: 100%;height: 4cm; \" class=\"page-num-simple\"><span  style=\"color: #000;\">参考答案第${PAGE}页（共${TOTAL_PAGE}页）</span></div>"
      },

      // 目录/书签插件，可选（默认未开启），所列选项为开启时的默认值
      simpleCatalog: {
        // 当前版本，如果需要生成PDF书签，toolBar.serverPrint.wkHtmlToPdf 必须为true
        // titlesSelector不要修改，使用h1-h6标记书签
        // titlesSelector : 'h1,h2,h3,h4,h5,h6', // 可选，作为目录标题的选择器，按目录级别依次


        /** 目录相关选项 **/
        showCatalog: false, // 可选，是否在页面中插入目录，默认，插入目录到页面
        header: '<div class="catalog-title">目 录</div>', // 可选，目录页Header部分，放入你想加入的一切
        itemFillChar: '…', // 可选，目录项填充字符, ""空字符串，不填充，使用自定义makeItem时，忽略该选项配置
        positionSelector: '.nop-page-item-pagenum-1', //可选，目录位置会插入在匹配页的之前，默认为第一个编号页前
        // 可选，自定义目录项。
        makeItem: function (itemEl, itemInfo) {
          /** 
            * @var itemEl jQuery Element 
            * @var object itemInfo PS: {title, pageNum, level,linkId}
            **/
          return '<div>自定义的目录项html内容，根据itemInfo自己构造</div>';
        },

        /** 侧边栏（PDF书签）相关选项 **/
        showSlide: false, // 可选，是否显示侧边栏，目录导航，工具栏按钮顺序index: 200, 在bookConfig.toolBar选项为false时无效
        slideOn: false, // 可选，目录导航，默认是否打开状态
        slideHeader: '<div class="title">目&nbsp;&nbsp;录</div>', // 可选，侧边栏标题
        slideClassName: '', // 可选，侧边栏自定义class
        slidePosition: 'left', // 可选，位置 left、right
        slideMakeContent: null, // 自定义侧边栏内容处理函数，为null时,默认行为：使用目录内容填充， function(){ return '侧边栏内容';}
      },

      "toolBar": {
        "serverPrint": false,
        "webPrint": true,
        saveHtml: false,
        buttons: [
        ],
      },
      "start": false
    }

    var d1 = $.Deferred();
    // 设置排版后试卷页面内容
    function setPaperHtml(paperHtml) {
      // $('.paper-con').html(paperHtml)
      $('.calc-con').html(paperHtml)
      dealImg()
      // $('.paper-con').find('.mce-pagebreak').parent().replaceWith('<div data-op-type="new-page"></div>')
      // var imgArr = $('img');
      // if (imgArr.length == 0) {
      //   d1.resolve();
      // } else {
      //   imgArr.load(function () {
      //     d1.resolve();
      //   })

      //   imgArr.error(function () {
      //     d1.resolve();
      //   });
      // }
      // $('.model-con').remove()
    }
    $.when(d1).then(function () {
      /** 2个图表渲染完毕后，执行PDF Book渲染 **/
      bookConfig.start = true;
    });
    // ifram 传值展示试卷分页内容
    window.onmessage = handleMessage
    function handleMessage(event) {
      let data = event.data || {}
      // 页脚内容设置
      bookConfig['simplePageNum']['pendant'] = '<div style="padding-bottom: 34mm;left: 0px;width: 100%;height: 4cm; " class="page-num-simple"><span  style=\"color: #000;\">' + paperInfo.subject + '参考答案第${PAGE}页（共${TOTAL_PAGE}页）</span></div>'
      setPaperHtml(data.content || '')
    }


    /** * BOOK渲染完成前    book.before-complete**/
    $(document).on('book.before-complete', function (e, info) {
      // $("body").addClass("loadOver")
      window.parent.postMessage('success', "*");
    })
  </script>
</body>

</html>