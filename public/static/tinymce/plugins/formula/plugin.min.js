tinymce.PluginManager.add('formula', function(editor, url) {
    
  var openDialog = function () {
  
  var isPlaceholderImage = function (imgElm) {
    return imgElm.nodeName === 'IMG' && (imgElm.hasAttribute('data-mce-object') || imgElm.hasAttribute('data-mce-placeholder'));
  };
  
  var getSelectedImage = function (editor) {
    var imgElm = editor.selection.getNode();
    if (imgElm && (imgElm.nodeName !== 'IMG' || isPlaceholderImage(imgElm)) ) {
      return null;
    }
    if(imgElm.dataset && imgElm.dataset.formulaImage){
      Formula.formulaData = imgElm.dataset.formulaImage;
    }
    
    return imgElm;
  };
  
  getSelectedImage(editor);
  
    return editor.windowManager.openUrl({
      title: '公式编辑器',
      url: url + '/formula.html',//根据自己的实际路径来
      buttons: [
        {
         type: 'cancel',
         name: 'cancel',
         text: 'Cancel'
        }, {
          type: 'custom',
          text: 'Save',
          name: 'save',
          primary: true
      },
      ],
      onAction: function (api, details) {
        switch (details.name) {
          case 'save':
            //@ts-ignore
      Formula.r.action((function() {
         Formula.r.syncEditorSVG();
       
       //命令行也可以
       // editor.execCommand('mceInsertContent', false, '<img  src="'+ Formula.formulaImgData + '" data-formula-image="'+ Formula.formulaData +'" </img>');
       // editor.addVisual();
       
       editor.insertContent('<img  src="'+ Formula.formulaImgData + '" data-formula-image="'+ Formula.formulaData +'" </img>')
       //editor.insertContent( '<p><b class="mceNonEditable">题干：</b><b class="selcontent">选择后的题干内容</b></p>');
      
       api.close();
      }
      ), "已同步至编辑器", "同步失败")
     
            break;
           default:
              break;
        }
      },
   onClose:function(){
     Formula.r.setFormulaData('','');
     Formula.formulaImgData ='',Formula.formulaData = '';
   }
    });
  };
  

  //状态选择器适配器 用于更新按钮状态
const stateSelectorAdapter = function (editor, selector) {
  return function (buttonApi) {
    return editor.selection.selectorChangedWithUnbind(selector.join(','),buttonApi.setActive).unbind;
  };
}

  // 注册一个工具栏按钮名称
  editor.ui.registry.addButton('formula', {
  icon: 'formula',
  tooltip: 'formula',
    onAction: function () {
      openDialog();
    }
  });

  // 注册一个菜单项名称 menu/menubar
  editor.ui.registry.addMenuItem('formula', {
    icon: 'formula',
    tooltip: 'formula',
    text:'formula',
      onAction: function () {
        openDialog();
      }
  });

  return {
    getMetadata: function () {
      return  {
        //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
        name: "formula",//插件名称
        url: "", //作者网址
      };
    }
  };
});

