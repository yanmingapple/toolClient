<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
  
  </style>

  <script src="../../tkDate.js"></script>
  <script src="../../tkString.js"></script>
</head>
<body>
  <!-- #region page -->
  <section class="flat-container container-fluid~">
    <div class="flat-row row~">
      <div>
          <span
          >文字内容</span>
          <div>
            <textarea id="copyValue"  style="width: 100%;" rows="10" ></textarea></div>
      </div>
     
    
      <div style="margin-top: 25px;">
        <div>展示区：</div>
        
        <div id="showDiv" style="margin-top: 10px;text-align: left;border: 1px outset rgb(110, 131, 33);padding: 5px;">

        </div>

        <!-- <div style="padding:5px; ">
          <div>png图片：</div>
          <canvas id="showCanvas"></canvas>
        </div> -->
        
      </div>
      

    </div>
  </section>



<script type="text/javascript">

  //借贷解析数据集合
  var data = {
    allData : [],//所有数据集合
    jieDataArr : [],//借的数据集合
    daiDataArr : [],//贷的数据集合
    hanziWidthHeightObj : {width:0,height:0} ,//一个汉字的宽高
    yingwendthHeightObj : {width:0,height:0} ,//一个英文的宽高
    firtLineWidthHeight : {width:0,height:0},//第一行的宽高
    lineHeightPx:0,//行高像素，按照汉字的字体高度*行高
  }

  //配置项
  var config = {
    spaseRex : /\s+/ig,//空格
    moneyRex :/[0-9\-\.]/ig,//数字
    noMoneyRex :/[^0-9^\-^\.]/ig,//非数字
    subjectRex : /[\—\—]/ig,//明细科目开头
    outLinePlacehold : "-",//外边框识别字符串
    placeCnt : 1 ,//替换的空位，按照汉字宽度
    fontFamily : "'Times New Roman','宋体','Songti SC','SimSun'" ,//字体
    fontSize : 16,//字体大小
    lineheight : 1.5,//行高
    parseLine : true,//一行多个借、贷 ，需要解析成多行 
  }

  config.showStyle = "border:none;font-family:"+config.fontFamily+";font-size:"+config.fontSize+"px;";//汉字样式
  config.moneyStyleOutLine = "font-family:"+config.fontFamily+";font-size:"+config.fontSize+"px;outline: 1px solid;";//已还数字样式
  
  config.halfLineHeight = (config.fontSize * config.lineheight - config.fontSize)/2;
  
  /**
   * 重置解析数据
   * **/
  function resetData(){
      data.allData=[],
      data.jieDataArr = [],
      data.daiDataArr = [];
      console.log(data.daiDataArr.length);
  }

  //初始化
  (function(){
    //用于与父窗口信息传递
    var DrawSvgData = window.parent.DrawSvgData  || {};
    window.parent.DrawSvgData = window.DrawSvgData = DrawSvgData;
    DrawSvgData.data = DrawSvgData.data || '';
    //赋值
    document.getElementById('copyValue').value = DrawSvgData.data.tkDecodeBase64();

    getTextWidthHeight(' ');
    data.hanziWidthHeightObj = getTextWidthHeight('中',1);
    data.firtLineWidthHeight = getTextWidthHeight('中',1);
    data.yingwendthHeightObj = getTextWidthHeight('A',1);
    //行高像素= 字体高度px * 字体行高
    data.lineHeightPx = data.hanziWidthHeightObj.height;

    if(DrawSvgData.data && DrawSvgData.data !=''){
      //格式化数据
      parseInputData();
      //同步svg
      syncSvg();
    }
   

    var time1 = null;
    document.getElementById('copyValue').onkeyup  = function(e){
      DrawSvgData.data  = e.target.value.tkEncodeBase64();
      if(time1){
        window.clearTimeout(time1);
      }
      time1 = window.setTimeout(function(){
        //格式化数据
        parseInputData();
        //同步svg
        syncSvg();

       
      },500);

      
      
    };

    document.getElementById('copyValue').onpaste  = function(e){
      DrawSvgData.data  = e.clipboardData.getData('text').tkEncodeBase64();
      //格式化数据
      parseInputData();
      //同步svg
      syncSvg();
    }

  })();


  function parseInputData(){
    //重置
    resetData();
    //获取格式化数据
    var copyValue = DrawSvgData.data.tkDecodeBase64();
    //开始解析
    var valueStringSplit = copyValue.split('\n');

    //借：贷打发2121212 阿斯顿发斯蒂芬 21121
    var autoSplitData = [];
    valueStringSplit.forEach(item=>{
      autoSplitData = autoSplitData.concat(item);
    })
    //每一行的数据进行解析
    var currIndex = 1;
    autoSplitData.forEach(item=>{
      //先去掉多余的空格和制表符号
      var itemSplits = item.replace(config.spaseRex,'').replace(/(^[\s\n\t]+|[\s\n\t]+$)/g, "");
      //当前行无数据，直接跳过
      if(itemSplits =='')return;

      //cat  借或贷的类型  type 为中间文字部分 money,为后面的金额，moneyStrArr保存小数
      var retData = {
        data:'',
        isFirstRow:false,//是否第一行
        isLessZero:false,//是否小于0
        leftXPx: 0,//起始位置X坐标
        yPx: 0,//起始位置X坐标
        rowIndex:0,//第几行
        index:0,//当前列表第几个
      }

      //分割每一行数据
      var parseData = itemSplits;//parseRow(itemSplits,currIndex);

      //占位符替换
      retData.data = parseData;
      var widthHeightObj = getTextWidthHeight(retData.data);
      retData.leftStrWidthPx = widthHeightObj.width;
      if(currIndex == 1){
        retData.yPx = data.lineHeightPx //+ config.halfLineHeight
      }else{
        retData.yPx = data.lineHeightPx * currIndex + config.halfLineHeight * 2 * (currIndex - 1)
      }
      retData.rowIndex = currIndex;
      currIndex++;

      //存放到数据集合中
      data.allData.push(retData);
    });

    initJieDataparseInputData();
}

//用户将借贷输入到一行数据中，需要自动解析
function paseRowStr(row){
  var data = [];
  var noMoneyData = [],moneyData = [];
  for(var index = 0;index < row.length;index++){
    
    var str = row.charAt(index);
    //优先处理金额
    if(str.search(config.noMoneyRex)== 0){
      noMoneyData.push(str)
      if(moneyData.length > 0){
        data.push(moneyData.join(''));
        moneyData = [];
      }
    }else{
      moneyData.push(str)
      if(noMoneyData.length > 0){
        data.push(noMoneyData.join(''));
        noMoneyData = [];
      }
    }
  }

  if(noMoneyData.length > 0){
    data.push(noMoneyData.join(''));
    noMoneyData = [];
  }

  if(moneyData.length > 0){
    data.push(moneyData.join(''));
    moneyData = [];
  }

  var retData = [];
  for(var index = 0; index < data.length; index+=2){
    retData.push(data[index] + (data[index+1]||'0'));
  }
  
  return retData;
}

  //格式化每一行的数据，借贷，科目及明细科目，金额
  function parseRow(row,currIndex){
    //从后往前查找,先找金额，在找科目，再找分类
    var retData = {
      cat:'',
      subject:'',
      money:''
    };

    //先处理借、贷的类型
    if(row.indexOf('借：') == 0 || row.indexOf('借:') == 0){
      retData.cat = '借：';
      row = row.replace('借：','').replace('借:','')
    }else if(row.indexOf('贷：') == 0 || row.indexOf('贷:') == 0){
      retData.cat = '贷：';
      row = row.replace('贷：','').replace('贷:','')
    }
    if(currIndex == 1 && retData.cat == '') retData.cat ='借：'

    var data = [];
    for(var index = row.length - 1;index >= 0;index--){
      
      var str = row.charAt(index);
      //优先处理金额
      if(!retData.money && str.search(config.noMoneyRex)== 0){
        retData.money = data.length == 0 ? ' ' : data.reverse().join('');
        retData.money = retData.money == '-' ? '-0': retData.money
        data = [];
        data.push(str);
        continue;
      }else{
        data.push(str);
      }
    }
    retData.subject = data.reverse().join('');

    return retData;
  }

function initJieDataparseInputData(){

  //处理每一组数据
  data.allData.forEach(group => {
    for(var gIndex =1;gIndex < group.length;gIndex++){
      var gItem = group[gIndex];
      gItem.leftXPx = getTextWidthHeight(gItem.data).width;
    }

  });
}

  function syncSvg(){
    //创建 svg
    var svg = document.createElement('svg');
    svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
    svg.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");
    // svg.setAttribute("style","border:1px solid;");
    // svg.setAttribute ("style","overflow: visible;");

    //文字
    var jieSvgText = document.createElement('text');
    jieSvgText.setAttribute("style",config.showStyle);
    //设置文字空格占位
    jieSvgText.setAttribute("xml:space","preserve");
    svg.appendChild(jieSvgText);

    //计算最长的字符串，规则：借的金额需要在借贷中最长的后面
    var maxStr = getMaxRowBeforeMoneyStr();//最长字符
    var maxStrWidthHeight = getTextWidthHeight(maxStr);
 
    //格式化借款金额
     parseSvgDOM(jieSvgText,data.allData)
     
    
    var showdiv = document.getElementById('showDiv');
  
    showdiv.innerHTML = svg.outerHTML;

    syncEditorSVG();

    }

  /***
   * 格式化 借贷svg
   * svgText svgtext
   * dataArr  借贷数据集
   * maxStrWidthHeight 最长字符串宽高
   * jieMoneyMaxStr 金额的最大字符串宽高
   * moneyZhengStrWidthHeight 整数金额的最大字符串 宽高
   * 
   */
  function parseSvgDOM(svgText,dataArr){
    //数据为空，着不格式化
    if(dataArr.length == 0){
      return;
    }

    var lineIndex = 0;
    for(let index = 0;index < dataArr.length;index++){
        var item = dataArr[index];
        var type = document.createElement('tspan');
        type.innerText = item.data;
        type.setAttribute("x",item.leftXPx);   
        type.setAttribute("y",item.yPx);
        svgText.appendChild(type);
    }
  }

  //获取金额前的最长行的字符串，贷的行前面还有一个借字的位置
  function getMaxRowBeforeMoneyStr(){
    var jieMaxStr = getMaxStrBeforeMoney(data.allData);//最长字符
    return jieMaxStr.length;
  }


  //获取金额最大长度，与整数最大长度
  function getMaxMoneyData(dataArr){
    var retData ={
      moneyNumParseStr:'',
      moneyPointStr:'',//小数点后面字符
    }

    //个位对齐，找小数后面最长的数字、整数最长数字
    dataArr.forEach(item=>{
      retData.moneyPointStr = retData.moneyPointStr.length > item.moneyPointStr.length ? retData.moneyPointStr : item.moneyPointStr;
      retData.moneyNumParseStr = retData.moneyNumParseStr.length > item.moneyNumParseStr.length ? retData.moneyNumParseStr : item.moneyNumParseStr;
    });
    retData.maxStr = retData.moneyNumParseStr + (retData.moneyPointStr .length > 0 ? '.'+retData.moneyPointStr :'')

    return retData;
  }

    //获取最长的金额字符串是否小于0
  function getLessZeroMaxMoneyLength(dataArr){
    //找出是否有小于0的情况
    var lessZero = [];
    dataArr.forEach(item=>{
      if(item.isLessZero)lessZero.push(item);
    });
    if(lessZero.length > 0){
      return true;
    }
    return false;
  }

  //获取金额前的最大长度字符串
  function getMaxStrBeforeMoney(dataArr){    
    var strArr = [],//存放字符串列表
     catStr,//借贷分类
     lineBeforeStr;//总科目后面最后一个明细科目前的字符串
    //组装数据
    dataArr.forEach(item=>{
      strArr.push(item.data);
    });

    //取最大的长度字符串
    var maxStr = "";
    strArr.forEach(item=>{
      var maxLenth = getLength(maxStr);
      var itemLenth = getLength(item);
      maxStr = maxLenth > itemLenth ? maxStr : item;
    });

    return maxStr;
  }

  //获取字符的长度，按照汉字与英文区分,分别按照像素的宽度计算
  function getLength(str) {
    ///<summary>获得字符串实际长度，中文2，英文1</summary>
    ///<param name="str">要获得长度的字符串</param>
    var realLength = 0, len = str.length, charCode = -1;
    for (var i = 0; i < len; i++) {
        charCode = str.charCodeAt(i);
        
        if (charCode >= 0 && charCode <= 128){
          realLength += data.yingwendthHeightObj.width;
        }else{
          realLength += data.hanziWidthHeightObj.width;
        }
    }
    return realLength;
 }


  function getTextWidthHeight(text,lineHeight){
    const ele = document.createElement("span");
    ele.style.position = 'absolute';
    //ele.style.whiteSpace = 'nowrap';
    ele.style.fontSize = config.fontSize + 'px';
    ele.style.fontFamily = config.fontFamily;
    ele.style.lineHeight = lineHeight||config.lineheight;
 
    //ele.style.position = 'absolute';
    ele.innerHTML = text == ' ' ? '&nbsp;':text;
    document.body.append(ele);

    // 获取span的宽度
    
    const width= ele.getBoundingClientRect().width;
    const height = ele.getBoundingClientRect().height;

    // const width= ele.clientWidth;
    // const height = ele.clientHeight;
    // 从body中删除该span
    document.body.removeChild(ele);
    // 返回span宽度
    return {width:width,height:height};

  }
   function syncEditorSVG () {

    var showDiv = document.getElementById('showDiv');
    var e = showDiv.firstElementChild;
    // e.removeAttribute("style"),
    // e.removeAttribute("focusable"),
    // e.removeAttribute("role");

    var bbox = e.getBBox();
    var width = bbox.width + bbox.x + 2;
    var height = bbox.height + bbox.y + 3;

    e.setAttribute("width", width + "px"),
    e.setAttribute("height", height+"px");
    var n = e.outerHTML
    , t = new Image;
    t.width = width,
    t.height  = height;


      var t = '<?xml version="1.0" encoding="UTF-8" standalone="no" ?>\n' + e.outerHTML
        , o = new Blob([t],{
          type: "image/svg+xml"
      });  

      const base64 = n.tkEncodeBase64();

      const fileReader = new FileReader();
      fileReader.onload = (e) => {
        const ImgBase64 = `${e.target.result}`;
        DrawSvgData.imageData = ImgBase64;
        DrawSvgData.width = width,
        DrawSvgData.height = height;
      };
      fileReader.readAsDataURL(o);
 
   
   
   
  }



</script>
</body>
</html>
