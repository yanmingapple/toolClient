tinymce.PluginManager.add('imagetool', function(editor, url) {

  window.Formula = window.Formula  || {};
    
    var isNullable = function (a) {
      return a === null || a === undefined;
    };
    var isNonNullable = function (a) {
      return !isNullable(a);
    };
  
    var isFormulaImage = function (imgElm) {
      if(imgElm.nodeName==='FIGURE'){
        return imgElm.childNodes[0].hasAttribute('data-formula-image')
      }else if(imgElm.nodeName === 'IMG'){
        return imgElm.hasAttribute('data-formula-image');
      }
      return  false;
    };

    var move = function (editor,px) {
      var imgElm = editor.selection.getNode();
      var figureElm = editor.dom.getParent(imgElm, 'figure.image');
      if (figureElm) {
        if (!isFormulaImage(figureElm.childNodes[0])) {
          return null;
        }
        if(figureElm.childNodes[0].dataset && figureElm.childNodes[0].dataset.formulaImage){
          Formula.formulaData = figureElm.childNodes[0].dataset.formulaImage;
        }
        return editor.dom.select('img', figureElm)[0];
      }
      if (imgElm && (imgElm.nodeName !== 'IMG' && !isFormulaImage(imgElm))) {
        return null;
      }

      if(imgElm.dataset && imgElm.dataset.formulaImage){
        Formula.formulaData = imgElm.dataset.formulaImage;
      }
      let marginBottm = px + "px";
      if(imgElm.style.marginBottom){
        let marginBottmInt = imgElm.style.marginBottom.replace("px","")
        marginBottmInt = parseInt(marginBottmInt);
        marginBottmInt += px;
        marginBottm = marginBottmInt + "px";
      }
      imgElm.style.marginBottom = marginBottm
      
      
      if(imgElm.dataset.mceStyle){
        const newDatasetList = [];
        const datasetlist = imgElm.dataset.mceStyle.split(";")
        datasetlist.forEach((el,elIndex)=>{
          if(el){
            if(el.includes("margin-bottom")){
              newDatasetList.push(`margin-bottom: ${marginBottm};`)
            }else{
              newDatasetList.push(el);
            }

          }
        })
        imgElm.dataset.mceStyle = newDatasetList.join(";")

      }else{
        imgElm.dataset.mceStyle = `margin-bottom: ${marginBottm};`
      }
      return imgElm;
    };
    
    
    editor.ui.registry.addToggleButton('imagetoolup', {
      icon: 'imagetoolup',
      tooltip: 'imagetoolup',
      onAction:  ()=>{
        move(editor,-1);
      }
    });

    editor.ui.registry.addToggleButton('imagetooldown', {
      icon: 'imagetooldown',
      tooltip: 'imagetooldown',
      onAction:  ()=>{
        move(editor,1);
      }
    });

    return {
      getMetadata: function () {
        return  {
          //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
          name: "imagetool",//插件名称
          url: "", //作者网址
        };
      }
    };
  });
  
  