TrelloClient=function(t){DrawioClient.call(this,t,"tauth"),Trello.setKey(this.key)},mxUtils.extend(TrelloClient,DrawioClient),TrelloClient.prototype.key=(window.location.hostname,"e73615c79cf7e381aef91c85936e9553"),TrelloClient.prototype.baseUrl="https://api.trello.com/1/",TrelloClient.prototype.SEPARATOR="|$|",TrelloClient.prototype.maxFileSize=1e7,TrelloClient.prototype.extension=".xml",TrelloClient.prototype.authenticate=function(e,n,t){t&&this.logout();t=mxUtils.bind(this,function(t,i){Trello.authorize({type:"popup",name:"draw.io",scope:{read:"true",write:"true"},expiration:t?"never":"1hour",success:function(){null!=i&&i(),e()},error:function(){null!=i&&i(),null!=n&&n(mxResources.get("loggedOut"))}})});this.isAuthorized()?t(!0):this.ui.showAuthDialog(this,!0,t)},TrelloClient.prototype.getLibrary=function(t,i,e){this.getFile(t,i,e,!1,!0)},TrelloClient.prototype.getFile=function(s,r,u,t,a){a=null!=a&&a;var h=mxUtils.bind(this,function(){var t=s.split(this.SEPARATOR),l=!0,o=window.setTimeout(mxUtils.bind(this,function(){l=!1,u({code:App.ERROR_TIMEOUT,retry:h})}),this.ui.timeout);Trello.cards.get(t[0]+"/attachments/"+t[1],mxUtils.bind(this,function(e){var n,t;window.clearTimeout(o),l&&(n=/\.png$/i.test(e.name),t={Authorization:'OAuth oauth_consumer_key="'+Trello.key()+'", oauth_token="'+Trello.token()+'"'},/\.v(dx|sdx?)$/i.test(e.name)||/\.gliffy$/i.test(e.name)||!this.ui.useCanvasForExport&&n?this.ui.convertFile(PROXY_URL+"?url="+encodeURIComponent(e.url),e.name,e.mimeType,this.extension,r,u,null,t):(l=!0,o=window.setTimeout(mxUtils.bind(this,function(){l=!1,u({code:App.ERROR_TIMEOUT})}),this.ui.timeout),this.ui.editor.loadUrl(PROXY_URL+"?url="+encodeURIComponent(e.url),mxUtils.bind(this,function(t){var i;window.clearTimeout(o),l&&(e.compoundId=s,0<(n?t.lastIndexOf(","):-1)&&(null!=(i=this.ui.extractGraphModelFromPng(t))&&0<i.length&&(t=i)),r(new(a?TrelloLibrary:TrelloFile)(this.ui,t,e)))}),mxUtils.bind(this,function(t,i){window.clearTimeout(o),l&&(401==i.status?this.authenticate(h,u,!0):u())}),n||null!=e.mimeType&&"image/"==e.mimeType.substring(0,6),null,null,null,t)))}),mxUtils.bind(this,function(t){window.clearTimeout(o),l&&(null!=t&&401==t.status?this.authenticate(h,u,!0):u())}))});this.authenticate(h,u)},TrelloClient.prototype.insertLibrary=function(t,i,e,n,l){this.insertFile(t,i,e,n,!0,l)},TrelloClient.prototype.insertFile=function(e,n,l,o,s,r){s=null!=s&&s;var t=mxUtils.bind(this,function(){var i=mxUtils.bind(this,function(t){this.writeFile(e,t,r,mxUtils.bind(this,function(t){l(new(s?TrelloLibrary:TrelloFile)(this.ui,n,t))}),o)});this.ui.useCanvasForExport&&/(\.png)$/i.test(e)?this.ui.getEmbeddedPng(mxUtils.bind(this,function(t){i(this.ui.base64ToBlob(t,"image/png"))}),o,n):i(n)});this.authenticate(t,o)},TrelloClient.prototype.saveFile=function(i,e,n){var l=i.meta.compoundId.split(this.SEPARATOR),o=mxUtils.bind(this,function(t){this.writeFile(i.meta.name,t,l[0],function(t){Trello.del("cards/"+l[0]+"/attachments/"+l[1],mxUtils.bind(this,function(){e(t)}),mxUtils.bind(this,function(t){null!=t&&401==t.status?this.authenticate(s,n,!0):n()}))},n)}),s=mxUtils.bind(this,function(){this.ui.useCanvasForExport&&/(\.png)$/i.test(i.meta.name)?this.ui.getEmbeddedPng(mxUtils.bind(this,function(t){o(this.ui.base64ToBlob(t,"image/png"))}),n,this.ui.getCurrentFile()!=i?i.getData():null):o(i.getData())});this.authenticate(s,n)},TrelloClient.prototype.writeFile=function(l,o,s,r,u){var a;null!=l&&null!=o?o.length>=this.maxFileSize?u({message:mxResources.get("drawingTooLarge")+" ("+this.ui.formatFileSize(o.length)+" / 10 MB)"}):(a=mxUtils.bind(this,function(){var i=!0,e=window.setTimeout(mxUtils.bind(this,function(){i=!1,u({code:App.ERROR_TIMEOUT,retry:a})}),this.ui.timeout),t=new FormData;t.append("key",Trello.key()),t.append("token",Trello.token()),t.append("file","string"==typeof o?new Blob([o]):o,l),t.append("name",l);var n=new XMLHttpRequest;n.responseType="json",n.onreadystatechange=mxUtils.bind(this,function(){var t;4===n.readyState&&(window.clearTimeout(e),i&&(200==n.status?((t=n.response).compoundId=s+this.SEPARATOR+t.id,r(t)):401==n.status?this.authenticate(a,u,!0):u()))}),n.open("POST",this.baseUrl+"cards/"+s+"/attachments"),n.send(t)}),this.authenticate(a,u)):u({message:mxResources.get("unknownError")})},TrelloClient.prototype.pickLibrary=function(t){this.pickFile(t)},TrelloClient.prototype.pickFolder=function(t){this.authenticate(mxUtils.bind(this,function(){this.showTrelloDialog(!1,t)}),mxUtils.bind(this,function(t){this.ui.showError(mxResources.get("error"),t)}))},TrelloClient.prototype.pickFile=function(t,i){t=null!=t?t:mxUtils.bind(this,function(t){this.ui.loadFile("T"+encodeURIComponent(t))}),this.authenticate(mxUtils.bind(this,function(){this.showTrelloDialog(!0,t)}),mxUtils.bind(this,function(t){this.ui.showError(mxResources.get("error"),t,mxResources.get("ok"))}))},TrelloClient.prototype.showTrelloDialog=function(o,s){var r=null,u="@me",a=0,t=document.createElement("div");t.style.whiteSpace="nowrap",t.style.overflow="hidden",t.style.height="224px";var i=document.createElement("h3");mxUtils.write(i,o?mxResources.get("selectFile"):mxResources.get("selectCard")),i.style.cssText="width:100%;text-align:center;margin-top:0px;margin-bottom:12px",t.appendChild(i);var h=document.createElement("div");h.style.whiteSpace="nowrap",h.style.overflow="auto",h.style.height="194px",t.appendChild(h);t=new CustomDialog(this.ui,t);this.ui.showDialog(t.container,340,290,!0,!0),t.okButton.parentNode.removeChild(t.okButton);var c=mxUtils.bind(this,function(t,i,e){a++;var n=document.createElement("div");n.style="width:100%;text-overflow:ellipsis;overflow:hidden;vertical-align:middle;padding:2px 0 2px 0;background:"+(a%2==0?Editor.isDarkMode()?"#000":"#eee":Editor.isDarkMode()?"":"#fff");var l,o=document.createElement("a");return o.style.cursor="pointer",null!=e&&((l=document.createElement("img")).src=e.url,l.width=e.width,l.height=e.height,l.style="border: 1px solid black;margin:5px;vertical-align:middle",o.appendChild(l)),mxUtils.write(o,t),mxEvent.addListener(o,"click",i),n.appendChild(o),n}),e=mxUtils.bind(this,function(t){this.ui.handleError(t,null,mxUtils.bind(this,function(){this.ui.spinner.stop(),this.ui.hideDialog()}))}),d=mxUtils.bind(this,function(){a=0,h.innerHTML="",this.ui.spinner.spin(h,mxResources.get("loading"));var i=mxUtils.bind(this,function(){Trello.cards.get(r+"/attachments",{fields:"id,name,previews"},mxUtils.bind(this,function(t){this.ui.spinner.stop();var i=t;h.appendChild(c("../ [Up]",mxUtils.bind(this,function(){x()}))),mxUtils.br(h),null==i||0==i.length?mxUtils.write(h,mxResources.get("noFiles")):mxUtils.bind(this,function(){for(var t=0;t<i.length;t++)mxUtils.bind(this,function(t){h.appendChild(c(t.name,mxUtils.bind(this,function(){this.ui.hideDialog(),s(r+this.SEPARATOR+t.id)}),null!=t.previews?t.previews[0]:null))})(i[t])})()}),mxUtils.bind(this,function(t){401==t.status?this.authenticate(i,e,!0):null!=e&&e(t)}))});i()}),m=null,p=null,x=mxUtils.bind(this,function(n){null==n&&(a=0,h.innerHTML="",n=1),this.ui.spinner.spin(h,mxResources.get("loading")),null!=m&&null!=m.parentNode&&m.parentNode.removeChild(m),(m=document.createElement("a")).style.display="block",m.style.cursor="pointer",mxUtils.write(m,mxResources.get("more")+"...");var l=mxUtils.bind(this,function(){mxEvent.removeListener(h,"scroll",p),x(n+1)});mxEvent.addListener(m,"click",l);var i=mxUtils.bind(this,function(){Trello.get("search",{query:""==mxUtils.trim(u)?"is:open":u,cards_limit:100,cards_page:n-1},mxUtils.bind(this,function(t){this.ui.spinner.stop();var i=null!=t?t.cards:null;if(null==i||0==i.length)mxUtils.write(h,mxResources.get("noFiles"));else{1==n&&(h.appendChild(c(mxResources.get("filterCards")+"...",mxUtils.bind(this,function(){var t=new FilenameDialog(this.ui,u,mxResources.get("ok"),mxUtils.bind(this,function(t){null!=t&&(u=t,x())}),mxResources.get("filterCards"),null,null,"http://help.trello.com/article/808-searching-for-cards-all-boards");this.ui.showDialog(t.container,300,80,!0,!1),t.init()}))),mxUtils.br(h));for(var e=0;e<i.length;e++)mxUtils.bind(this,function(t){h.appendChild(c(t.name,mxUtils.bind(this,function(){o?(r=t.id,d()):(this.ui.hideDialog(),s(t.id))})))})(i[e]);100==i.length&&(h.appendChild(m),p=function(){h.scrollTop>=h.scrollHeight-h.offsetHeight&&l()},mxEvent.addListener(h,"scroll",p))}}),mxUtils.bind(this,function(t){401==t.status?this.authenticate(i,e,!0):null!=e&&e({message:t.responseText})}))});i()});x()},TrelloClient.prototype.isAuthorized=function(){try{return null!=localStorage.trello_token}catch(t){}return!1},TrelloClient.prototype.logout=function(){localStorage.removeItem("trello_token"),Trello.deauthorize()};