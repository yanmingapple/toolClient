OneDriveFile=function(e,t,i){DrawioFile.call(this,e,t),this.meta=i},mxUtils.extend(OneDriveFile,DrawioFile),OneDriveFile.prototype.autosaveDelay=300,OneDriveFile.prototype.share=function(){var e,t,i,n,s=this.meta.webUrl;if(s=s.substring(0,s.lastIndexOf("/")),null!=this.meta.parentReference)try{"personal"==this.meta.parentReference.driveType?s="https://onedrive.live.com/?cid="+encodeURIComponent(this.meta.parentReference.driveId)+"&id="+encodeURIComponent(this.meta.id):"documentLibrary"==this.meta.parentReference.driveType?(e=(e=this.meta.parentReference.path).substring(e.indexOf("/root:")+6),s=(s=(i=this.meta.webUrl).substring(0,i.length-e.length-this.meta.name.length-(0<e.length?1:0)))+"/Forms/AllItems.aspx?id="+(i=i.substring(i.indexOf("/",8)))+"&parent="+i.substring(0,i.lastIndexOf("/"))):"business"==this.meta.parentReference.driveType&&(t=(s=this.meta["@microsoft.graph.downloadUrl"]).indexOf("/_layouts/15/download.aspx?"),n=i=this.meta.webUrl,i=(i=i.substring(8)).substring(i.indexOf("/")),n=(n=n.substring(0,n.lastIndexOf("/"))).substring(n.indexOf("/",8)),s=s.substring(0,t)+"/_layouts/15/onedrive.aspx?id="+i+"&parent="+n)}catch(e){}this.ui.editor.graph.openLink(s)},OneDriveFile.prototype.getId=function(){return this.getIdOf(this.meta)},OneDriveFile.prototype.getParentId=function(){return this.getIdOf(this.meta,!0)},OneDriveFile.prototype.getIdOf=function(e,t){return(null!=e.parentReference&&null!=e.parentReference.driveId?e.parentReference.driveId+"/":"")+(null!=t?e.parentReference:e).id},OneDriveFile.prototype.getChannelId=function(){return"W-"+DrawioFile.prototype.getChannelId.apply(this,arguments)},OneDriveFile.prototype.getHash=function(){return"W"+encodeURIComponent(this.getId())},OneDriveFile.prototype.getMode=function(){return App.MODE_ONEDRIVE},OneDriveFile.prototype.isAutosaveOptional=function(){return!0},OneDriveFile.prototype.getTitle=function(){return this.meta.name},OneDriveFile.prototype.isRenamable=function(){return!0},OneDriveFile.prototype.isOptimisticSync=function(){return!0},OneDriveFile.prototype.isSyncSupported=function(){return!0},OneDriveFile.prototype.getSize=function(){return this.meta.size},OneDriveFile.prototype.isConflict=function(e){return null!=e&&(412==e.getStatus()||409==e.getStatus())},OneDriveFile.prototype.getCurrentUser=function(){return null!=this.ui.oneDrive?this.ui.oneDrive.user:null},OneDriveFile.prototype.loadDescriptor=function(t,i){this.ui.oneDrive.executeRequest(this.ui.oneDrive.getItemURL(this.getId()),mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?t(JSON.parse(e.getText())):null!=i&&i()}),i)},OneDriveFile.prototype.getLatestVersion=function(e,t){this.ui.oneDrive.getFile(this.getId(),e,t)},OneDriveFile.prototype.getDescriptor=function(){return this.meta},OneDriveFile.prototype.setDescriptor=function(e){this.meta=e},OneDriveFile.prototype.getDescriptorEtag=function(e){return e.eTag},OneDriveFile.prototype.setDescriptorEtag=function(e,t){e.eTag=t},OneDriveFile.prototype.loadPatchDescriptor=function(t,i){var e=this.ui.oneDrive.getItemURL(this.getId());this.ui.oneDrive.executeRequest(e+"?select=etag,file",mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?t(JSON.parse(e.getText())):i(this.ui.oneDrive.parseRequestText(e))}),i)},OneDriveFile.prototype.getChannelKey=function(){return"undefined"!=typeof CryptoJS?CryptoJS.MD5(this.meta.createdDateTime+(null!=this.meta.createdBy&&null!=this.meta.createdBy.user?this.meta.createdBy.user.id:"")).toString():null},OneDriveFile.prototype.getLastModifiedDate=function(){return new Date(this.meta.lastModifiedDateTime)},OneDriveFile.prototype.save=function(e,t,i,n,s){this.doSave(this.getTitle(),e,t,i,n,s)},OneDriveFile.prototype.saveAs=function(e,t,i){this.doSave(e,!1,t,i)},OneDriveFile.prototype.doSave=function(e,t,i,n,s,r){var o=this.meta.name;this.meta.name=e,DrawioFile.prototype.save.apply(this,[null,mxUtils.bind(this,function(){this.meta.name=o,this.saveFile(e,t,i,n,s,r)}),n,s,r])},OneDriveFile.prototype.saveFile=function(e,t,n,s,i,r){var o;this.isEditable()?this.savingFile||(this.getTitle()==e?(o=mxUtils.bind(this,function(){try{this.savingFileTime=new Date,this.setShadowModified(!1),this.savingFile=!0;var e=r||this.constructor!=OneDriveFile||"manual"!=DrawioFile.SYNC&&"auto"!=DrawioFile.SYNC?null:this.getCurrentEtag(),i=this.meta;this.fileSaving(),this.ui.oneDrive.saveFile(this,mxUtils.bind(this,function(e,t){this.setModified(this.getShadowModified()),this.savingFile=!1,this.meta=e,this.fileSaved(t,i,mxUtils.bind(this,function(){this.contentChanged(),null!=n&&n()}),s)}),mxUtils.bind(this,function(e,t){try{this.savingFile=!1,this.isConflict(t)?(this.inConflictState=!0,null!=this.sync?(this.savingFile=!0,this.sync.fileConflict(null,mxUtils.bind(this,function(){window.setTimeout(mxUtils.bind(this,function(){this.updateFileData(),o()}),100+500*Math.random())}),mxUtils.bind(this,function(){this.savingFile=!1,null!=s&&s()}))):null!=s&&s()):null!=s&&s(e)}catch(e){if(this.savingFile=!1,null==s)throw e;s(e)}}),e)}catch(e){if(this.savingFile=!1,null==s)throw e;s(e)}}))():(this.savingFileTime=new Date,this.setShadowModified(!1),this.savingFile=!0,this.ui.oneDrive.insertFile(e,this.getData(),mxUtils.bind(this,function(e){this.setModified(this.getShadowModified()),this.savingFile=!1,null!=n&&n(),this.ui.fileLoaded(e)}),mxUtils.bind(this,function(){this.savingFile=!1,null!=s&&s()})))):null!=n&&n()},OneDriveFile.prototype.rename=function(t,i,n){var s=this.getCurrentEtag();this.ui.oneDrive.renameFile(this,t,mxUtils.bind(this,function(e){this.hasSameExtension(t,this.getTitle())?(this.meta=e,this.descriptorChanged(),null!=this.sync&&this.sync.descriptorChanged(s),null!=i&&i(e)):(this.meta=e,null!=this.sync&&this.sync.descriptorChanged(s),this.save(!0,i,n))}),n)},OneDriveFile.prototype.move=function(e,t,i){this.ui.oneDrive.moveFile(this.getId(),e,mxUtils.bind(this,function(e){this.meta=e,this.descriptorChanged(),null!=t&&t(e)}),i)};