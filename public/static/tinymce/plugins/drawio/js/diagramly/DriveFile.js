DriveFile=function(i,t,e){DrawioFile.call(this,i,t),this.desc=e},mxUtils.extend(DriveFile,DrawioFile),DriveFile.prototype.saveDelay=0,DriveFile.prototype.allChangesSavedKey="allChangesSavedInDrive",DriveFile.prototype.getSize=function(){return this.desc.fileSize},DriveFile.prototype.isRestricted=function(){return null!=this.desc.userPermission&&null!=this.desc.labels&&"reader"==this.desc.userPermission.role&&this.desc.labels.restricted},DriveFile.prototype.isConflict=function(i){return null!=i&&null!=i.error&&412==i.error.code},DriveFile.prototype.getCurrentUser=function(){return null!=this.ui.drive?this.ui.drive.user:null},DriveFile.prototype.getMode=function(){return App.MODE_GOOGLE},DriveFile.prototype.getPublicUrl=function(e){this.ui.drive.executeRequest({url:"/files/"+this.desc.id+"/permissions?supportsAllDrives=true"},mxUtils.bind(this,function(i){if(null!=i&&null!=i.items)for(var t=0;t<i.items.length;t++)if("anyoneWithLink"===i.items[t].id||"anyone"===i.items[t].id)return void e(this.desc.webContentLink);e(null)}),mxUtils.bind(this,function(){e(null)}))},DriveFile.prototype.isAutosaveOptional=function(){return!0},DriveFile.prototype.isRenamable=function(){return this.isEditable()&&DrawioFile.prototype.isEditable.apply(this,arguments)},DriveFile.prototype.isMovable=function(){return this.isEditable()},DriveFile.prototype.isTrashed=function(){return this.desc.labels.trashed},DriveFile.prototype.save=function(i,t,e,s,n){DrawioFile.prototype.save.apply(this,[i,mxUtils.bind(this,function(){this.saveFile(null,i,t,e,s,n)}),e,s,n])},DriveFile.prototype.saveFile=function(i,o,l,u,h,e){try{this.isEditable()?this.savingFile||(this.savingFileTime=new Date,this.setShadowModified(!1),this.savingFile=!0,this.createSecret(mxUtils.bind(this,function(t,n){var r=mxUtils.bind(this,function(e,i){try{var s=this.desc;this.ui.drive.saveFile(this,i,mxUtils.bind(this,function(i,t){try{this.savingFile=!1,0!=i?(this.setModified(this.getShadowModified()),o&&(this.lastAutosaveRevision=(new Date).getTime()),this.autosaveDelay=Math.round(Math.min(1e4,Math.max(DriveFile.prototype.autosaveDelay,this.saveDelay))),this.desc=i,null!=n?this.fileSaved(t,s,mxUtils.bind(this,function(){this.contentChanged(),null!=l&&l(i)}),u,n):null!=l&&l(i)):null!=u&&u(i)}catch(i){if(this.savingFile=!1,null==u)throw i;u(i)}}),mxUtils.bind(this,function(i,t){try{this.savingFile=!1,this.isConflict(i)?(this.inConflictState=!0,null!=this.sync?(this.savingFile=!0,this.sync.fileConflict(t,mxUtils.bind(this,function(){window.setTimeout(mxUtils.bind(this,function(){this.updateFileData(),this.setShadowModified(!1),r(e,!0)}),100+500*Math.random())}),mxUtils.bind(this,function(){this.savingFile=!1,null!=u&&u()}))):null!=u&&u()):null!=u&&u(i)}catch(i){if(this.savingFile=!1,null==u)throw i;u(i)}}),h,h,e,null,t)}catch(i){if(this.savingFile=!1,null==u)throw i;u(i)}});r(e,o)}))):null!=l&&l()}catch(i){if(null==u)throw i;u(i)}},DriveFile.prototype.copyFile=function(i,t){this.isRestricted()?DrawioFile.prototype.copyFile.apply(this,arguments):this.makeCopy(mxUtils.bind(this,function(){if(this.ui.spinner.spin(document.body,mxResources.get("saving")))try{this.save(!0,i,t)}catch(i){t(i)}}),t,!0)},DriveFile.prototype.makeCopy=function(t,i,e){this.ui.spinner.spin(document.body,mxResources.get("saving"))&&this.saveAs(this.ui.getCopyFilename(this,e),mxUtils.bind(this,function(i){this.desc=i,this.ui.spinner.stop(),this.setModified(!1),this.backupPatch=null,this.invalidChecksum=!1,this.inConflictState=!1,this.descriptorChanged(),t()}),mxUtils.bind(this,function(){this.ui.spinner.stop(),null!=i&&i()}))},DriveFile.prototype.saveAs=function(i,t,e){this.ui.drive.copyFile(this.getId(),i,t,e)},DriveFile.prototype.rename=function(t,e,s){var n=this.getCurrentEtag();this.ui.drive.renameFile(this.getId(),t,mxUtils.bind(this,function(i){this.hasSameExtension(t,this.getTitle())?(this.desc=i,this.descriptorChanged(),null!=this.sync&&this.sync.descriptorChanged(n),null!=e&&e(i)):(this.desc=i,null!=this.sync&&this.sync.descriptorChanged(n),this.save(!0,e,s))}),s)},DriveFile.prototype.move=function(i,t,e){this.ui.drive.moveFile(this.getId(),i,mxUtils.bind(this,function(i){this.desc=i,this.descriptorChanged(),null!=t&&t(i)}),e)},DriveFile.prototype.share=function(){this.ui.drive.showPermissions(this.getId())},DriveFile.prototype.getTitle=function(){return this.desc.title},DriveFile.prototype.getHash=function(){return"G"+this.getId()},DriveFile.prototype.getId=function(){return this.desc.id},DriveFile.prototype.isEditable=function(){return DrawioFile.prototype.isEditable.apply(this,arguments)&&this.desc.editable},DriveFile.prototype.isSyncSupported=function(){return!0},DriveFile.prototype.isRevisionHistorySupported=function(){return!0},DriveFile.prototype.getRevisions=function(e,i){this.ui.drive.executeRequest({url:"/files/"+this.getId()+"/revisions"},mxUtils.bind(this,function(i){for(var t=0;t<i.items.length;t++)mxUtils.bind(this,function(e){e.title=e.originalFilename,e.getXml=mxUtils.bind(this,function(t,i){this.ui.drive.getXmlFile(e,mxUtils.bind(this,function(i){t(i.getData())}),i)}),e.getUrl=mxUtils.bind(this,function(i){return this.ui.getUrl(window.location.pathname+"?rev="+e.id+"&chrome=0&nav=1&layers=1&edit=_blank"+(null!=i?"&page="+i:""))+window.location.hash})})(i.items[t]);e(i.items)}),i)},DriveFile.prototype.getLatestVersion=function(i,t){this.ui.drive.getFile(this.getId(),i,t,!0)},DriveFile.prototype.getChannelId=function(){var i=this.ui.drive.getCustomProperty(this.desc,"channel");return i=null!=i?"G-"+this.getId()+"."+i:i},DriveFile.prototype.getChannelKey=function(){return this.ui.drive.getCustomProperty(this.desc,"key")},DriveFile.prototype.getLastModifiedDate=function(){return new Date(this.desc.modifiedDate)},DriveFile.prototype.getDescriptor=function(){return this.desc},DriveFile.prototype.setDescriptor=function(i){this.desc=i},DriveFile.prototype.getDescriptorSecret=function(i){return this.ui.drive.getCustomProperty(i,"secret")},DriveFile.prototype.setDescriptorRevisionId=function(i,t){i.headRevisionId=t},DriveFile.prototype.getDescriptorRevisionId=function(i){return i.headRevisionId},DriveFile.prototype.getDescriptorEtag=function(i){return i.etag},DriveFile.prototype.setDescriptorEtag=function(i,t){i.etag=t},DriveFile.prototype.loadPatchDescriptor=function(t,i){this.ui.drive.executeRequest({url:"/files/"+this.getId()+"?supportsAllDrives=true&fields="+this.ui.drive.catchupFields},mxUtils.bind(this,function(i){t(i)}),i)},DriveFile.prototype.patchDescriptor=function(i,t){i.headRevisionId=t.headRevisionId,i.modifiedDate=t.modifiedDate,DrawioFile.prototype.patchDescriptor.apply(this,arguments)},DriveFile.prototype.loadDescriptor=function(i,t){this.ui.drive.loadDescriptor(this.getId(),i,t)},DriveFile.prototype.commentsSupported=function(){return!0},DriveFile.prototype.getComments=function(n,i){var o=this.ui.getCurrentUser();this.ui.drive.executeRequest({url:"/files/"+this.getId()+"/comments"},mxUtils.bind(this,function(i){for(var t=[],e=0;e<i.items.length;e++){var s=function i(t,e,s){if(e.deleted)return null;for(var n=new DriveComment(t,e.commentId||e.replyId,e.content,e.modifiedDate,e.createdDate,"resolved"==e.status,e.author.isAuthenticatedUser?o:new DrawioUser(e.author.permissionId,e.author.emailAddress,e.author.displayName,e.author.picture.url),s),r=0;null!=e.replies&&r<e.replies.length;r++)n.addReplyDirect(i(t,e.replies[r],e.commentId));return n}(this,i.items[e]);null!=s&&t.push(s)}n(t)}),i)},DriveFile.prototype.addComment=function(i,t,e){i={content:i.content};this.ui.drive.executeRequest({url:"/files/"+this.getId()+"/comments",method:"POST",params:i},mxUtils.bind(this,function(i){t(i.commentId)}),e)},DriveFile.prototype.canReplyToReplies=function(){return!1},DriveFile.prototype.canComment=function(){return this.desc.canComment},DriveFile.prototype.newComment=function(i,t){return new DriveComment(this,null,i,Date.now(),Date.now(),!1,t)};