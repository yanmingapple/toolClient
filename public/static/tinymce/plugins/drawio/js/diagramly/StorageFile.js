StorageFile=function(t,e,i){DrawioFile.call(this,t,e),this.title=i},mxUtils.extend(StorageFile,DrawioFile),StorageFile.prototype.autosaveDelay=2e3,StorageFile.prototype.maxAutosaveDelay=2e4,StorageFile.prototype.type="F",StorageFile.prototype.getMode=function(){return App.MODE_BROWSER},StorageFile.prototype.isAutosaveOptional=function(){return!0},StorageFile.prototype.getHash=function(){return"L"+encodeURIComponent(this.getTitle())},StorageFile.prototype.getTitle=function(){return this.title},StorageFile.prototype.isRenamable=function(){return!0},StorageFile.prototype.save=function(t,e,i){this.saveAs(this.getTitle(),e,i)},StorageFile.prototype.saveAs=function(t,e,i){DrawioFile.prototype.save.apply(this,arguments),this.saveFile(t,!1,e,i)},StorageFile.insertFile=function(i,l,o,n,a){var e=mxUtils.bind(this,function(t){function e(){var t=new StorageFile(i,o,l);t.saveFile(l,!1,function(){n(t)},a)}t?i.confirm(mxResources.get("replaceIt",[l]),e,a):e()});StorageFile.getFileContent(i,l,function(t){e(null!=t)},function(){e(!1)})},StorageFile.getFileContent=function(t,e,i,l){t.getDatabaseItem(e,function(t){i(null!=t?t.data:null)},mxUtils.bind(this,function(){null==t.database?t.getLocalData(e,i):null!=l&&l()}),"files")},StorageFile.getFileInfo=function(t,e,i,l){t.getDatabaseItem(e,function(t){i(t)},mxUtils.bind(this,function(){null==t.database?t.getLocalData(e,function(t){i(null!=t?{title:e}:null)}):null!=l&&l()}),"filesInfo")},StorageFile.prototype.saveFile=function(i,t,l,o){var e;this.isEditable()?(e=mxUtils.bind(this,function(){this.isRenamable()&&(this.title=i);try{var t=mxUtils.bind(this,function(){this.setModified(this.getShadowModified()),this.contentChanged(),null!=l&&l()});this.setShadowModified(!1);var e=this.getData();this.ui.setDatabaseItem(null,[{title:this.title,size:e.length,lastModified:Date.now(),type:this.type},{title:this.title,data:e}],t,mxUtils.bind(this,function(){null==this.ui.database?this.ui.setLocalData(this.title,e,t):null!=o&&o()}),["filesInfo","files"])}catch(t){null!=o&&o(t)}}),this.isRenamable()&&"."==i.charAt(0)&&null!=o?o({message:mxResources.get("invalidName")}):StorageFile.getFileInfo(this.ui,i,mxUtils.bind(this,function(t){this.isRenamable()&&this.getTitle()!=i&&null!=t?this.ui.confirm(mxResources.get("replaceIt",[i]),e,o):e()}),o)):null!=l&&l()},StorageFile.prototype.rename=function(i,l,o){var n=this.getTitle();n!=i?StorageFile.getFileInfo(this.ui,i,mxUtils.bind(this,function(t){var e=mxUtils.bind(this,function(){this.title=i,this.hasSameExtension(n,i)||this.setData(this.ui.getFileData()),this.saveFile(i,!1,mxUtils.bind(this,function(){this.ui.removeLocalData(n,l)}),o)});null!=t?this.ui.confirm(mxResources.get("replaceIt",[i]),e,o):e()}),o):l()},StorageFile.prototype.open=function(){DrawioFile.prototype.open.apply(this,arguments),this.saveFile(this.getTitle())},StorageFile.prototype.getLatestVersion=function(e,t){StorageFile.getFileContent(this.ui,this.title,mxUtils.bind(this,function(t){e(new StorageFile(this.ui,t,this.title))}),t)},StorageFile.prototype.destroy=function(){DrawioFile.prototype.destroy.apply(this,arguments),null!=this.storageListener&&(mxEvent.removeListener(window,"storage",this.storageListener),this.storageListener=null)},StorageFile.listLocalStorageFiles=function(t){for(var e=[],i=0;i<localStorage.length;i++){var l,o,n=localStorage.key(i),a=localStorage.getItem(n);0<n.length&&"."!=n.charAt(0)&&0<a.length&&(l=!(null!=t&&"F"!=t||"<mxfile "!==a.substring(0,8)&&"<?xml"!==a.substring(0,5)&&"\x3c!--[if IE]>"!==a.substring(0,12)),o=(null==t||"L"==t)&&"<mxlibrary>"===a.substring(0,11),(l||o)&&e.push({title:n,type:l?"F":"L",size:a.length,lastModified:Date.now()}))}return e},StorageFile.migrate=function(t){var e=StorageFile.listLocalStorageFiles();e.push({title:".scratchpad",type:"L"});for(var t=t.transaction(["files","filesInfo"],"readwrite"),i=t.objectStore("files"),l=t.objectStore("filesInfo"),o=0;o<e.length;o++){var n=e[o],a=localStorage.getItem(n.title);i.add({title:n.title,data:a}),l.add(n)}},StorageFile.listFiles=function(t,l,o,e){t.getDatabaseItems(function(t){var e=[];if(null!=t)for(var i=0;i<t.length;i++)"."==t[i].title.charAt(0)||null!=l&&t[i].type!=l||e.push(t[i]);o(e)},function(){null==t.database?o(StorageFile.listLocalStorageFiles(l)):null!=e&&e()},"filesInfo")},StorageFile.deleteFile=function(t,e,i,l){t.removeDatabaseItem([e,e],i,function(){null==t.database?(localStorage.removeItem(e),i()):null!=l&&l()},["files","filesInfo"])};