!function(){var m=null;window.OneDriveClient=function(e,t,i,n){null==t&&null!=window.urlParams&&"1"==window.urlParams.extAuth&&(t=!0),null==i&&(i=null==window.Editor||Editor.oneDriveInlinePicker),null==n&&null!=window.urlParams&&"1"==window.urlParams.noLogoutOD&&(n=!0),DrawioClient.call(this,e,t?"oneDriveExtAuthInfo":"oneDriveAuthInfo"),this.isExtAuth=t,this.inlinePicker=i,this.noLogout=n;n=JSON.parse(this.token);null!=n&&(this.endpointHint=null!=n.endpointHint?n.endpointHint.replace("/Documents","/_layouts/15/onedrive.aspx"):n.endpointHint)},mxUtils.extend(OneDriveClient,DrawioClient),OneDriveClient.prototype.clientId=window.DRAWIO_MSGRAPH_CLIENT_ID||("test.draw.io"==window.location.hostname?"2e598409-107f-4b59-89ca-d7723c8e00a4":"45c10911-200f-4e27-a666-9e9fca147395"),OneDriveClient.prototype.clientId="app.diagrams.net"==window.location.hostname?"b5ff67d6-3155-4fca-965a-59a3655c4476":OneDriveClient.prototype.clientId,OneDriveClient.prototype.clientId="viewer.diagrams.net"==window.location.hostname?"417a451a-a343-4788-b6c1-901e63182565":OneDriveClient.prototype.clientId,OneDriveClient.prototype.scopes="user.read files.readwrite.all sites.read.all",OneDriveClient.prototype.redirectUri=window.location.protocol+"//"+window.location.host+"/microsoft",OneDriveClient.prototype.pickerRedirectUri=window.location.protocol+"//"+window.location.host+"/onedrive3.html",OneDriveClient.prototype.defEndpointHint="api.onedrive.com",OneDriveClient.prototype.endpointHint=OneDriveClient.prototype.defEndpointHint,OneDriveClient.prototype.extension=".drawio",OneDriveClient.prototype.baseUrl="https://graph.microsoft.com/v1.0",OneDriveClient.prototype.emptyFn=function(){},OneDriveClient.prototype.invalidFilenameRegExs=[/[~"#%\*:<>\?\/\\{\|}]/,/^\.lock$/i,/^CON$/i,/^PRN$/i,/^AUX$/i,/^NUL$/i,/^COM\d$/i,/^LPT\d$/i,/^desktop\.ini$/i,/_vti_/i],OneDriveClient.prototype.isValidFilename=function(e){if(null==e||""===e)return!1;for(var t=0;t<this.invalidFilenameRegExs.length;t++)if(this.invalidFilenameRegExs[t].test(e))return!1;return!0},OneDriveClient.prototype.get=function(e,t,i){e=new mxXmlRequest(e,null,"GET");return e.setRequestHeaders=mxUtils.bind(this,function(e,t){e.setRequestHeader("Authorization","Bearer "+m)}),e.send(t,i),e},OneDriveClient.prototype.updateUser=function(t,i,n){var s=!0,o=window.setTimeout(mxUtils.bind(this,function(){s=!1,i({code:App.ERROR_TIMEOUT})}),this.ui.timeout);this.get(this.baseUrl+"/me",mxUtils.bind(this,function(e){window.clearTimeout(o),s&&(e.getStatus()<200||300<=e.getStatus()?n?i({message:mxResources.get("accessDenied")}):(this.logout(),this.authenticate(mxUtils.bind(this,function(){this.updateUser(t,i,!0)}),i)):(e=JSON.parse(e.getText()),this.setUser(new DrawioUser(e.id,e.mail,e.displayName)),t()))}),mxUtils.bind(this,function(e){window.clearTimeout(o),s&&i(e)}))},OneDriveClient.prototype.resetTokenRefresh=function(e){null!=this.tokenRefreshThread&&(window.clearTimeout(this.tokenRefreshThread),this.tokenRefreshThread=null),0<e&&(this.tokenRefreshInterval=1e3*e,this.tokenRefreshThread=window.setTimeout(mxUtils.bind(this,function(){this.authenticate(this.emptyFn,this.emptyFn,!0)}),900*e))},OneDriveClient.prototype.authenticate=function(t,i,n){this.isExtAuth?window.parent.oneDriveAuth(mxUtils.bind(this,function(e){this.updateAuthInfo(e,!0,null==this.endpointHint,t,i)}),i,null!=window.urlParams&&"1"==urlParams.odAuthCancellable):new mxXmlRequest(this.redirectUri+"?getState=1",null,"GET").send(mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?this.authenticateStep2(e.getText(),t,i,n):null!=i&&i(e)}),i)},OneDriveClient.prototype.updateAuthInfo=function(e,t,i,n,s){i&&this.setUser(null),m=e.access_token,delete e.access_token,e.expiresOn=Date.now()+1e3*e.expires_in,this.tokenExpiresOn=e.expiresOn,e.remember=t,this.setPersistentToken(JSON.stringify(e),!t),this.resetTokenRefresh(e.expires_in),i?this.getAccountTypeAndEndpoint(mxUtils.bind(this,function(){n()}),s):n()},OneDriveClient.prototype.authenticateStep2=function(a,u,c,i){var h;null==window.onOneDriveCallback?(h=mxUtils.bind(this,function(){var l=!0,t=JSON.parse(this.getPersistentToken(!0));null!=t?new mxXmlRequest(this.redirectUri+"?state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+a),null,"GET").send(mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?this.updateAuthInfo(JSON.parse(e.getText()),t.remember,!1,u,c):(this.clearPersistentToken(),this.setUser(null),m=null,401!=e.getStatus()||i?c({message:mxResources.get("accessDenied"),retry:h}):h())}),c):this.ui.showAuthDialog(this,!0,mxUtils.bind(this,function(i,n){var e="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id="+this.clientId+"&response_type=code&redirect_uri="+encodeURIComponent(this.redirectUri)+"&scope="+encodeURIComponent(this.scopes+(i?" offline_access":""))+"&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+a),t=window.screenX,s=window.screenY,o=window.outerWidth,r=window.outerHeight,o=t+Math.max(o-525,0)/2,o=["width=525","height=525","top="+(s+Math.max(r-525,0)/2),"left="+o,"status=no","resizable=yes","toolbar=no","menubar=no","scrollbars=yes"],o=window.open(e,"odauth",o.join(","));null!=o&&(window.onOneDriveCallback=mxUtils.bind(this,function(e,t){if(l){window.onOneDriveCallback=null,l=!1;try{null==e?c({message:mxResources.get("accessDenied"),retry:h}):(null!=n&&n(),this.updateAuthInfo(e,i,!0,u,c))}catch(e){c(e)}finally{null!=t&&t.close()}}else null!=t&&t.close()}),o.focus())}),mxUtils.bind(this,function(){l&&(window.onOneDriveCallback=null,l=!1,c({message:mxResources.get("accessDenied"),retry:h}))}))}))():c({code:App.ERROR_BUSY})},OneDriveClient.prototype.getAccountTypeAndEndpoint=function(n,s){this.get(this.baseUrl+"/me/drive/root",mxUtils.bind(this,function(e){try{if(200<=e.getStatus()&&e.getStatus()<=299){var t=JSON.parse(e.getText());0<t.webUrl.indexOf(".sharepoint.com")?this.endpointHint=t.webUrl.replace("/Documents","/_layouts/15/onedrive.aspx"):this.endpointHint=this.defEndpointHint;var i=JSON.parse(this.getPersistentToken(!0));return null!=i&&(i.endpointHint=this.endpointHint,this.setPersistentToken(JSON.stringify(i),!i.remember)),void n()}}catch(e){}s({message:mxResources.get("unknownError")+" (Code: "+e.getStatus()+")"})}),s)},OneDriveClient.prototype.executeRequest=function(e,s,o){var r=mxUtils.bind(this,function(t){var i=!0,n=window.setTimeout(mxUtils.bind(this,function(){i=!1,o({code:App.ERROR_TIMEOUT,retry:r})}),this.ui.timeout);this.get(e,mxUtils.bind(this,function(e){window.clearTimeout(n),i&&(200<=e.getStatus()&&e.getStatus()<=299||404==e.getStatus()?(null==this.user&&this.updateUser(this.emptyFn,this.emptyFn,!0),s(e)):t||401!==e.getStatus()&&400!==e.getStatus()?o(this.parseRequestText(e)):this.authenticate(function(){r(!0)},o,t))}),mxUtils.bind(this,function(e){window.clearTimeout(n),i&&o(e)}))});null==m||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(function(){r(!0)},o):r(!1)},OneDriveClient.prototype.checkToken=function(e){null==m||null==this.tokenRefreshThread||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(e,this.emptyFn):e()},OneDriveClient.prototype.getItemRef=function(e){var t=e.split("/");return 1<t.length?{driveId:t[0],id:t[1]}:{id:e}},OneDriveClient.prototype.getItemURL=function(e,t){var i=e.split("/");if(1<i.length){var n=i[0],i=i[1];return(t?"":this.baseUrl)+"/drives/"+n+("root"==i?"/root":"/items/"+i)}return(t?"":this.baseUrl)+"/me/drive/items/"+e},OneDriveClient.prototype.getLibrary=function(e,t,i){this.getFile(e,t,i,!1,!0)},OneDriveClient.prototype.removeExtraHtmlContent=function(e){var t=e.lastIndexOf('<html><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><meta name="Robots" ');return e=0<t?e.substring(0,t):e},OneDriveClient.prototype.getFile=function(e,u,c,t,h){h=null!=h&&h,this.executeRequest(this.getItemURL(e),mxUtils.bind(this,function(e){var o,r,t,l,a;200<=e.getStatus()&&e.getStatus()<=299?(o=JSON.parse(e.getText()),r=/\.png$/i.test(o.name),/\.v(dx|sdx?)$/i.test(o.name)||/\.gliffy$/i.test(o.name)||/\.pdf$/i.test(o.name)||!this.ui.useCanvasForExport&&r?(t=null!=o.file?o.file.mimeType:null,this.ui.convertFile(o["@microsoft.graph.downloadUrl"],o.name,t,this.extension,u,c)):(l=!0,a=window.setTimeout(mxUtils.bind(this,function(){l=!1,c({code:App.ERROR_TIMEOUT})}),this.ui.timeout),this.ui.editor.loadUrl(o["@microsoft.graph.downloadUrl"],mxUtils.bind(this,function(e){try{var t,i,n,s;window.clearTimeout(a),l&&(/\.html$/i.test(o.name)&&(e=this.removeExtraHtmlContent(e)),t=r?e.lastIndexOf(","):-1,i=null,0<t?null!=(n=this.ui.extractGraphModelFromPng(e))&&0<n.length?e=n:i=new LocalFile(this.ui,e,o.name,!0):"data:image/png;base64,PG14ZmlsZS"==e.substring(0,32)&&(s=e.substring(22),e=window.atob&&!mxClient.IS_SF?atob(s):Base64.decode(s)),Graph.fileSupport&&(new XMLHttpRequest).upload&&this.ui.isRemoteFileFormat(e,o["@microsoft.graph.downloadUrl"])?this.ui.parseFile(new Blob([e],{type:"application/octet-stream"}),mxUtils.bind(this,function(e){try{4==e.readyState&&(200<=e.status&&e.status<=299?u(new LocalFile(this.ui,e.responseText,o.name+this.extension,!0)):null!=c&&c({message:mxResources.get("errorLoadingFile")}))}catch(e){if(null==c)throw e;c(e)}}),o.name):u(null!=i?i:new(h?OneDriveLibrary:OneDriveFile)(this.ui,e,o)))}catch(e){if(null==c)throw e;c(e)}}),mxUtils.bind(this,function(e){window.clearTimeout(a),l&&c(this.parseRequestText(e))}),r||null!=o.file&&null!=o.file.mimeType&&("image/"==o.file.mimeType.substring(0,6)&&"image/svg"!=o.file.mimeType.substring(0,9)||"application/pdf"==o.file.mimeType)))):this.isExtAuth?c({message:mxResources.get("fileNotFoundOrDenied"),ownerEmail:null!=window.urlParams?urlParams.ownerEml:null}):c(this.parseRequestText(e))}),c)},OneDriveClient.prototype.renameFile=function(t,i,n,s){null!=t&&null!=i&&(this.isValidFilename(i)?this.checkExists(t.getParentId(),i,!1,mxUtils.bind(this,function(e){e?this.writeFile(this.getItemURL(t.getId()),JSON.stringify({name:i}),"PATCH","application/json",n,s):s()})):s({message:this.invalidFilenameRegExs[0].test(i)?mxResources.get("oneDriveCharsNotAllowed"):mxResources.get("oneDriveInvalidDeviceName")}))},OneDriveClient.prototype.moveFile=function(e,t,i,n){var s=this.getItemRef(t),t=this.getItemRef(e);s.driveId!=t.driveId?n({message:mxResources.get("cannotMoveOneDrive",null,"Moving a file between accounts is not supported yet.")}):this.writeFile(this.getItemURL(e),JSON.stringify({parentReference:s}),"PATCH","application/json",i,n)},OneDriveClient.prototype.insertLibrary=function(e,t,i,n,s){this.insertFile(e,t,i,n,!0,s)},OneDriveClient.prototype.insertFile=function(i,n,s,o,r,l){this.isValidFilename(i)?(r=null!=r&&r,this.checkExists(l,i,!0,mxUtils.bind(this,function(e){var t;e?(e="/me/drive/root",null!=l&&(e=this.getItemURL(l,!0)),t=mxUtils.bind(this,function(e){s(new(r?OneDriveLibrary:OneDriveFile)(this.ui,n,e))}),e=this.baseUrl+e+"/children/"+encodeURIComponent(i)+"/content",4e6<=n.length?this.writeFile(e,"","PUT",null,mxUtils.bind(this,function(e){this.writeLargeFile(this.getItemURL(e.id),n,t,o)}),o):this.writeFile(e,n,"PUT",null,t,o)):o()}))):o({message:this.invalidFilenameRegExs[0].test(i)?mxResources.get("oneDriveCharsNotAllowed"):mxResources.get("oneDriveInvalidDeviceName")})},OneDriveClient.prototype.checkExists=function(e,t,i,n){var s="/me/drive/root";null!=e&&(s=this.getItemURL(e,!0)),this.executeRequest(this.baseUrl+s+"/children/"+encodeURIComponent(t),mxUtils.bind(this,function(e){404==e.getStatus()?n(!0):i?(this.ui.spinner.stop(),this.ui.confirm(mxResources.get("replaceIt",[t]),function(){n(!0)},function(){n(!1)})):(this.ui.spinner.stop(),this.ui.showError(mxResources.get("error"),mxResources.get("fileExists"),mxResources.get("ok"),function(){n(!1)}))}),function(e){n(!1)},!0)},OneDriveClient.prototype.saveFile=function(n,s,o,r){try{var e,l=n.getData(),t=mxUtils.bind(this,function(e){var t=mxUtils.bind(this,function(e){s(e,l)}),i=this.getItemURL(n.getId());4e6<=e.length?this.writeLargeFile(i,e,t,o,r):this.writeFile(i+"/content/",e,"PUT",null,t,o,r)});this.ui.useCanvasForExport&&/(\.png)$/i.test(n.meta.name)?(e=this.ui.getPngFileProperties(this.ui.fileNode),this.ui.getEmbeddedPng(mxUtils.bind(this,function(e){t(this.ui.base64ToBlob(e,"image/png"))}),o,this.ui.getCurrentFile()!=n?l:null,e.scale,e.border)):t(l)}catch(e){o(e)}},OneDriveClient.prototype.writeLargeFile=function(t,u,c,h,o){try{var d,r;null!=u?(d=mxUtils.bind(this,function(n,s,o){try{o=o||0;var r=!0,l=window.setTimeout(mxUtils.bind(this,function(){r=!1,h({code:App.ERROR_TIMEOUT})}),this.ui.timeout),a=u.substr(s,4194304),e=new mxXmlRequest(n,a,"PUT");e.setRequestHeaders=mxUtils.bind(this,function(e,t){e.setRequestHeader("Content-Length",a.length),e.setRequestHeader("Content-Range","bytes "+s+"-"+(s+a.length-1)+"/"+u.length)}),e.send(mxUtils.bind(this,function(e){var t,i;window.clearTimeout(l),r&&(200<=(t=e.getStatus())&&t<=299?(i=s+a.length)==u.length?c(JSON.parse(e.getText())):d(n,i,o):500<=t&&t<=599&&o<2?d(n,s,++o):h(this.parseRequestText(e),e))}),mxUtils.bind(this,function(e){window.clearTimeout(l),r&&h(this.parseRequestText(e))}))}catch(e){h(e)}}),r=mxUtils.bind(this,function(i){try{var n=!0,s=null;try{s=window.setTimeout(mxUtils.bind(this,function(){n=!1,h({code:App.ERROR_TIMEOUT})}),this.ui.timeout)}catch(e){}var e=new mxXmlRequest(t+"/createUploadSession","{}","POST");e.setRequestHeaders=mxUtils.bind(this,function(e,t){e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("Authorization","Bearer "+m),null!=o&&e.setRequestHeader("If-Match",o)}),e.send(mxUtils.bind(this,function(e){var t;window.clearTimeout(s),n&&(200<=e.getStatus()&&e.getStatus()<=299?(t=JSON.parse(e.getText()),d(t.uploadUrl,0)):i||401!==e.getStatus()?h(this.parseRequestText(e),e):this.authenticate(function(){r(!0)},h,i))}),mxUtils.bind(this,function(e){window.clearTimeout(s),n&&h(this.parseRequestText(e))}))}catch(e){h(e)}}),null==m||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(function(){r(!0)},h):r(!1)):h({message:mxResources.get("unknownError")})}catch(e){h(e)}},OneDriveClient.prototype.writeFile=function(s,o,r,l,a,u,c){try{var h;null!=s&&null!=o?(h=mxUtils.bind(this,function(t){try{var i=!0,n=null;try{n=window.setTimeout(mxUtils.bind(this,function(){i=!1,u({code:App.ERROR_TIMEOUT})}),this.ui.timeout)}catch(e){}var e=new mxXmlRequest(s,o,r);e.setRequestHeaders=mxUtils.bind(this,function(e,t){e.setRequestHeader("Content-Type",l||" "),e.setRequestHeader("Authorization","Bearer "+m),null!=c&&e.setRequestHeader("If-Match",c)}),e.send(mxUtils.bind(this,function(e){window.clearTimeout(n),i&&(200<=e.getStatus()&&e.getStatus()<=299?(null==this.user&&this.updateUser(this.emptyFn,this.emptyFn,!0),a(JSON.parse(e.getText()))):t||401!==e.getStatus()?u(this.parseRequestText(e),e):this.authenticate(function(){h(!0)},u,t))}),mxUtils.bind(this,function(e){window.clearTimeout(n),i&&u(this.parseRequestText(e))}))}catch(e){u(e)}}),null==m||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(function(){h(!0)},u):h(!1)):u({message:mxResources.get("unknownError")})}catch(e){u(e)}},OneDriveClient.prototype.parseRequestText=function(e){var t={message:mxResources.get("unknownError")};try{(t=JSON.parse(e.getText())).status=e.getStatus(),t.error&&(t.error.status=t.status,t.error.code=t.status)}catch(e){}return t},OneDriveClient.prototype.pickLibrary=function(t){this.pickFile(function(e){t(e)})},OneDriveClient.prototype.createInlinePicker=function(n,s){return mxUtils.bind(this,function(){var t=null,e=document.createElement("div");e.style.position="relative";var i=new CustomDialog(this.ui,e,mxUtils.bind(this,function(){var e=t.getSelectedItem();if(null!=e){if(s&&"object"==typeof e.folder)return void n({value:[e]});if(!e.folder)return void n(OneDriveFile.prototype.getIdOf(e))}return mxResources.get("invalidSel",null,"Invalid selection")}),null,mxResources.get(s?"save":"open"),null,null,null,null,!0);this.ui.showDialog(i.container,550,500,!0,!0),e.style.width=i.container.parentNode.style.width,e.style.height=parseInt(i.container.parentNode.style.height)-60+"px",t=new mxODPicker(e,null,mxUtils.bind(this,function(e,t,i){this.executeRequest(this.baseUrl+e,function(e){t(JSON.parse(e.getText()))},i)}),mxUtils.bind(this,function(e,t,i,n){this.executeRequest(this.baseUrl+"/drives/"+t+"/items/"+e,function(e){i(JSON.parse(e.getText()))},n)}),null,null,function(e){n(s?{value:[e]}:OneDriveFile.prototype.getIdOf(e))},mxUtils.bind(this,function(e){this.ui.showError(mxResources.get("error"),e)}),s)})},OneDriveClient.prototype.pickFolder=function(i,e){var n=mxUtils.bind(this,function(e){this.ui.showError(mxResources.get("error"),e&&e.message?e.message:e)}),t=mxUtils.bind(this,function(e){var t=this.inlinePicker?this.createInlinePicker(i,!0):mxUtils.bind(this,function(){OneDrive.save({clientId:this.clientId,action:"query",openInNewWindow:!0,advanced:{endpointHint:mxClient.IS_IE11?null:this.endpointHint,redirectUri:this.pickerRedirectUri,queryParameters:"select=id,name,parentReference",accessToken:m,isConsumerAccount:!1},success:mxUtils.bind(this,function(e){i(e),mxClient.IS_IE11&&(m=e.accessToken)}),cancel:mxUtils.bind(this,function(){}),error:n})});e?t():this.ui.confirm(mxResources.get("useRootFolder"),mxUtils.bind(this,function(){i({value:[{id:"root",name:"root",parentReference:{driveId:"me"}}]})}),t,mxResources.get("yes"),mxResources.get("noPickFolder")+"...",!0),null==this.user&&this.updateUser(this.emptyFn,this.emptyFn,!0)});null==m||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(mxUtils.bind(this,function(){t(!1)}),n):t(e)},OneDriveClient.prototype.pickFile=function(t){t=null!=t?t:mxUtils.bind(this,function(e){this.ui.loadFile("W"+encodeURIComponent(e))});var e=mxUtils.bind(this,function(e){this.ui.showError(mxResources.get("error"),e&&e.message?e.message:e)}),i=this.inlinePicker?this.createInlinePicker(t):mxUtils.bind(this,function(){OneDrive.open({clientId:this.clientId,action:"query",multiSelect:!1,advanced:{endpointHint:mxClient.IS_IE11?null:this.endpointHint,redirectUri:this.pickerRedirectUri,queryParameters:"select=id,name,parentReference",accessToken:m,isConsumerAccount:!1},success:mxUtils.bind(this,function(e){null!=e&&null!=e.value&&0<e.value.length&&(mxClient.IS_IE11&&(m=e.accessToken),t(OneDriveFile.prototype.getIdOf(e.value[0]),e))}),cancel:mxUtils.bind(this,function(){}),error:e}),null==this.user&&this.updateUser(this.emptyFn,this.emptyFn,!0)});null==m||this.tokenExpiresOn-Date.now()<6e4?this.authenticate(mxUtils.bind(this,function(){this.inlinePicker?(this.ui.hideDialog(),i()):this.ui.showDialog(new BtnDialog(this.ui,this,mxResources.get("open"),mxUtils.bind(this,function(){this.ui.hideDialog(),i()})).container,300,140,!0,!0)}),e):i()},OneDriveClient.prototype.logout=function(){var e;!isLocalStorage||null!=(e=localStorage.getItem("odpickerv7cache"))&&'{"odsdkLoginHint":{'==e.substring(0,19)&&localStorage.removeItem("odpickerv7cache"),window.open("https://login.microsoftonline.com/common/oauth2/v2.0/logout","logout","width=525,height=525,status=no,resizable=yes,toolbar=no,menubar=no,scrollbars=yes"),this.ui.editor.loadUrl(this.redirectUri+"?doLogout=1&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname)),this.clearPersistentToken(),this.setUser(null),m=null}}();