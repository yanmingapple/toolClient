!function(){var h=null;window.GitHubClient=function(e,t){DrawioClient.call(this,e,t||"ghauth")},mxUtils.extend(GitHubClient,DrawioClient),GitHubClient.prototype.clientId="test.draw.io"==window.location.hostname?"23bc97120b9035515661":window.DRAWIO_GITHUB_ID,GitHubClient.prototype.scope="repo",GitHubClient.prototype.extension=".drawio",GitHubClient.prototype.baseUrl=DRAWIO_GITHUB_API_URL,GitHubClient.prototype.baseHostUrl=DRAWIO_GITHUB_URL,GitHubClient.prototype.redirectUri=window.location.protocol+"//"+window.location.host+"/github2",GitHubClient.prototype.maxFileSize=1e6,GitHubClient.prototype.authToken="token",GitHubClient.prototype.setToken=function(e){h=e},GitHubClient.prototype.updateUser=function(e,t,i){var n=!0,s=window.setTimeout(mxUtils.bind(this,function(){n=!1,t({code:App.ERROR_TIMEOUT,message:mxResources.get("timeout")})}),this.ui.timeout),l=new mxXmlRequest(this.baseUrl+"/user",null,"GET"),o=this.authToken+" "+h;l.setRequestHeaders=function(e,t){e.setRequestHeader("Authorization",o)},l.send(mxUtils.bind(this,function(){window.clearTimeout(s),n&&(401===l.getStatus()?i?t({message:mxResources.get("accessDenied")}):(this.logout(),this.authenticate(mxUtils.bind(this,function(){this.updateUser(e,t,!0)}),t)):l.getStatus()<200||300<=l.getStatus()?t({message:mxResources.get("accessDenied")}):(this.setUser(this.createUser(JSON.parse(l.getText()))),e()))}),t)},GitHubClient.prototype.createUser=function(e){return new DrawioUser(e.id,e.email,e.name)},GitHubClient.prototype.authenticate=function(t,i){new mxXmlRequest(this.redirectUri+"?getState=1",null,"GET").send(mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?this.authenticateStep2(e.getText(),t,i):null!=i&&i(e)}),i)},GitHubClient.prototype.authenticateStep2=function(e,l,o){var r;null==window.onGitHubCallback?(r=mxUtils.bind(this,function(){var s=!0;this.ui.showAuthDialog(this,!0,mxUtils.bind(this,function(i,n){null!=window.open(this.baseHostUrl+"/login/oauth/authorize?client_id="+this.clientId+"&scope="+this.scope+"&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+e),"ghauth")?window.onGitHubCallback=mxUtils.bind(this,function(e,t){s?(window.onGitHubCallback=null,s=!1,null==e?o({message:mxResources.get("accessDenied"),retry:r}):(null!=n&&n(),h=e.access_token,this.setUser(null),i&&this.setPersistentToken("remembered"),l(),null!=t&&t.close())):null!=t&&t.close()}):o({message:mxResources.get("serviceUnavailableOrBlocked"),retry:r})}),mxUtils.bind(this,function(){s&&(window.onGitHubCallback=null,s=!1,o({message:mxResources.get("accessDenied"),retry:r}))}))}))():o({code:App.ERROR_BUSY})},GitHubClient.prototype.getErrorMessage=function(e,t){try{var i=JSON.parse(e.getText());null!=i&&null!=i.message&&(t=i.message)}catch(e){}return t},GitHubClient.prototype.executeRequest=function(o,r,u,a){var c=mxUtils.bind(this,function(i){var n=!0,s=window.setTimeout(mxUtils.bind(this,function(){n=!1,u({code:App.ERROR_TIMEOUT,retry:d})}),this.ui.timeout),l=this.authToken+" "+h;o.setRequestHeaders=function(e,t){e.setRequestHeader("Authorization",l)},o.send(mxUtils.bind(this,function(){if(window.clearTimeout(s),n)if(200<=o.getStatus()&&o.getStatus()<=299||a&&404==o.getStatus())r(o);else if(401===o.getStatus())i?u({code:o.getStatus(),message:mxResources.get("accessDenied"),retry:mxUtils.bind(this,function(){this.authenticate(function(){d(!0)},u)})}):this.authenticate(function(){c(!0)},u);else if(403===o.getStatus()){var e=!1;try{var t=JSON.parse(o.getText());null!=t&&null!=t.errors&&0<t.errors.length&&(e="too_large"==t.errors[0].code)}catch(e){}u({message:mxResources.get(e?"drawingTooLarge":"forbidden")})}else 404===o.getStatus()?u({code:o.getStatus(),message:this.getErrorMessage(o,mxResources.get("fileNotFound"))}):409===o.getStatus()?u({code:o.getStatus(),status:409}):u({code:o.getStatus(),message:this.getErrorMessage(o,mxResources.get("error")+" "+o.getStatus())})}),mxUtils.bind(this,function(e){window.clearTimeout(s),n&&u(e)}))}),d=mxUtils.bind(this,function(e){null==this.user?this.updateUser(function(){d(!0)},u,e):c(e)});null==h?this.authenticate(function(){d(!0)},u):d(!1)},GitHubClient.prototype.getLibrary=function(e,t,i){this.getFile(e,t,i,!0)},GitHubClient.prototype.getSha=function(e,t,i,n,s,l){var o="&t="+(new Date).getTime(),o=new mxXmlRequest(this.baseUrl+"/repos/"+e+"/"+t+"/contents/"+i+"?ref="+n+o,null,"HEAD");this.executeRequest(o,mxUtils.bind(this,function(e){try{s(e.request.getResponseHeader("Etag").match(/"([^"]+)"/)[1])}catch(e){l(e)}}),l)},GitHubClient.prototype.getFile=function(e,t,i,n,s){n=null!=n&&n;var l=e.split("/"),o=l[0],r=l[1],u=l[2];e=l.slice(3,l.length).join("/");var a,c=/\.png$/i.test(e);!s&&(/\.v(dx|sdx?)$/i.test(e)||/\.gliffy$/i.test(e)||/\.pdf$/i.test(e)||!this.ui.useCanvasForExport&&c)?null!=h?(c=this.baseUrl+"/repos/"+o+"/"+r+"/contents/"+e+"?ref="+u,a={Authorization:"token "+h},l=0<(l=e.split("/")).length?l[l.length-1]:e,this.ui.convertFile(c,l,null,this.extension,t,i,null,a)):i({message:mxResources.get("accessDenied")}):(a="&t="+(new Date).getTime(),a=new mxXmlRequest(this.baseUrl+"/repos/"+o+"/"+r+"/contents/"+e+"?ref="+u+a,null,"GET"),this.executeRequest(a,mxUtils.bind(this,function(e){try{t(this.createGitHubFile(o,r,u,JSON.parse(e.getText()),n))}catch(e){i(e)}}),i))},GitHubClient.prototype.createGitHubFile=function(e,t,i,n,s){var t={org:e,repo:t,ref:i,name:n.name,path:n.path,sha:n.sha,html_url:n.html_url,download_url:n.download_url},i=n.content;return"base64"===n.encoding&&(i=/\.jpe?g$/i.test(n.name)?"data:image/jpeg;base64,"+i:/\.gif$/i.test(n.name)?"data:image/gif;base64,"+i:/\.png$/i.test(n.name)?null!=(n=this.ui.extractGraphModelFromPng(i))&&0<n.length?n:"data:image/png;base64,"+i:Base64.decode(i)),new(s?GitHubLibrary:GitHubFile)(this.ui,i,t)},GitHubClient.prototype.insertLibrary=function(e,t,i,n,s){this.insertFile(e,t,i,n,!0,s,!1)},GitHubClient.prototype.insertFile=function(i,n,s,l,o,e,r){o=null!=o&&o;var e=e.split("/"),u=e[0],a=e[1],c=e[2],d=e.slice(3,e.length).join("/");0<d.length&&(d+="/"),d+=i,this.checkExists(u+"/"+a+"/"+c+"/"+d,!0,mxUtils.bind(this,function(e,t){e?o?(r||(n=Base64.encode(n)),this.showCommitDialog(i,!0,mxUtils.bind(this,function(e){this.writeFile(u,a,c,d,e,n,t,mxUtils.bind(this,function(e){try{var t=JSON.parse(e.getText());s(this.createGitHubFile(u,a,c,t.content,o))}catch(e){l(e)}}),l)}),l)):s(new GitHubFile(this.ui,n,{org:u,repo:a,ref:c,name:i,path:d,sha:t,isNew:!0})):l()}))},GitHubClient.prototype.showCommitDialog=function(e,t,i,n){var s=this.ui.spinner.pause(),e=new FilenameDialog(this.ui,mxResources.get(t?"addedFile":"updateFile",[e]),mxResources.get("ok"),mxUtils.bind(this,function(e){s(),i(e)}),mxResources.get("commitMessage"),null,null,null,null,mxUtils.bind(this,function(){n()}),null,280);this.ui.showDialog(e.container,400,80,!0,!1),e.init()},GitHubClient.prototype.writeFile=function(e,t,i,n,s,l,o,r,u){l.length>=this.maxFileSize?u({message:mxResources.get("drawingTooLarge")+" ("+this.ui.formatFileSize(l.length)+" / 1 MB)"}):(l={path:n,branch:decodeURIComponent(i),message:s,content:l},null!=o&&(l.sha=o),l=new mxXmlRequest(this.baseUrl+"/repos/"+e+"/"+t+"/contents/"+n,JSON.stringify(l),"PUT"),this.executeRequest(l,mxUtils.bind(this,function(e){r(e)}),mxUtils.bind(this,function(e){404==e.code&&(e.helpLink=this.baseHostUrl+"/settings/connections/applications/"+this.clientId,e.code=null),u(e)})))},GitHubClient.prototype.checkExists=function(i,n,s){var e=i.split("/"),t=e[0],l=e[1],o=e[2];i=e.slice(3,e.length).join("/"),this.getSha(t,l,i,o,mxUtils.bind(this,function(e){var t;n?(t=this.ui.spinner.pause(),this.ui.confirm(mxResources.get("replaceIt",[i]),function(){t(),s(!0,e)},function(){t(),s(!1)})):(this.ui.spinner.stop(),this.ui.showError(mxResources.get("error"),mxResources.get("fileExists"),mxResources.get("ok"),function(){s(!1)}))}),mxUtils.bind(this,function(e){s(!0)}),null,!0)},GitHubClient.prototype.saveFile=function(i,n,s,e,l){var o=i.meta.org,r=i.meta.repo,u=i.meta.ref,a=i.meta.path,t=mxUtils.bind(this,function(e,t){this.writeFile(o,r,u,a,l,t,e,mxUtils.bind(this,function(e){delete i.meta.isNew,n(JSON.parse(e.getText()).content.sha)}),mxUtils.bind(this,function(e){s(e)}))}),c=mxUtils.bind(this,function(){var e;this.ui.useCanvasForExport&&/(\.png)$/i.test(a)?(e=this.ui.getPngFileProperties(this.ui.fileNode),this.ui.getEmbeddedPng(mxUtils.bind(this,function(e){t(i.meta.sha,e)}),s,this.ui.getCurrentFile()!=i?i.getData():null,e.scale,e.border)):t(i.meta.sha,Base64.encode(i.getData()))});e?this.getSha(o,r,a,u,mxUtils.bind(this,function(e){i.meta.sha=e,c()}),s):c()},GitHubClient.prototype.pickLibrary=function(e){this.pickFile(e)},GitHubClient.prototype.pickFolder=function(e){this.showGitHubDialog(!1,e)},GitHubClient.prototype.pickFile=function(e){e=null!=e?e:mxUtils.bind(this,function(e){this.ui.loadFile("H"+encodeURIComponent(e))}),this.showGitHubDialog(!0,e)},GitHubClient.prototype.showGitHubDialog=function(o,r){var u=null,a=null,c=null,d=null,e=document.createElement("div");e.style.whiteSpace="nowrap",e.style.overflow="hidden",e.style.height="304px";var t=document.createElement("h3");mxUtils.write(t,mxResources.get(o?"selectFile":"selectFolder")),t.style.cssText="width:100%;text-align:center;margin-top:0px;margin-bottom:12px",e.appendChild(t);var h=document.createElement("div");h.style.whiteSpace="nowrap",h.style.border="1px solid lightgray",h.style.boxSizing="border-box",h.style.padding="4px",h.style.overflow="auto",h.style.lineHeight="1.2em",h.style.height="274px",e.appendChild(h);var m=document.createElement("div");m.style.textOverflow="ellipsis",m.style.boxSizing="border-box",m.style.overflow="hidden",m.style.padding="4px",m.style.width="100%";var p=new CustomDialog(this.ui,e,mxUtils.bind(this,function(){r(u+"/"+a+"/"+encodeURIComponent(c)+"/"+d)}));this.ui.showDialog(p.container,420,370,!0,!0),o&&p.okButton.parentNode.removeChild(p.okButton);var g=mxUtils.bind(this,function(e,t,i,n){var s=document.createElement("a");return s.setAttribute("title",e),s.style.cursor="pointer",mxUtils.write(s,e),mxEvent.addListener(s,"click",t),n&&(s.style.textDecoration="underline"),null!=i&&((n=m.cloneNode()).style.padding=i,n.appendChild(s),s=n),s}),x=mxUtils.bind(this,function(e){var t=document.createElement("div");if(t.style.marginBottom="8px",t.appendChild(g(u+"/"+a,mxUtils.bind(this,function(){d=null,v()}),null,!0)),e||(mxUtils.write(t," / "),t.appendChild(g(decodeURIComponent(c),mxUtils.bind(this,function(){d=null,y()}),null,!0))),null!=d&&0<d.length)for(var i=d.split("/"),n=0;n<i.length;n++)!function(e){mxUtils.write(t," / "),t.appendChild(g(i[e],mxUtils.bind(this,function(){d=i.slice(0,e+1).join("/"),w()}),null,!0))}(n);h.appendChild(t)}),b=mxUtils.bind(this,function(e){this.ui.handleError(e,null,mxUtils.bind(this,function(){this.ui.spinner.stop(),null!=this.getUser()?(d=c=a=u=null,v()):this.ui.hideDialog()}),null,{})}),f=null,U=null,w=mxUtils.bind(this,function(i){null==i&&(h.innerHTML="",i=1);var e=new mxXmlRequest(this.baseUrl+"/repos/"+u+"/"+a+"/contents/"+d+"?ref="+encodeURIComponent(c)+"&per_page=100&page="+i,null,"GET");this.ui.spinner.spin(h,mxResources.get("loading")),p.okButton.removeAttribute("disabled"),null!=U&&(mxEvent.removeListener(h,"scroll",U),U=null),null!=f&&null!=f.parentNode&&f.parentNode.removeChild(f),(f=document.createElement("a")).style.display="block",f.style.cursor="pointer",mxUtils.write(f,mxResources.get("more")+"...");var t=mxUtils.bind(this,function(){w(i+1)});mxEvent.addListener(f,"click",t),this.executeRequest(e,mxUtils.bind(this,function(e){this.ui.spinner.stop(),1==i&&(x(),h.appendChild(g("../ [Up]",mxUtils.bind(this,function(){var e;""==d?(d=null,v()):(d=(e=d.split("/")).slice(0,e.length-1).join("/"),w())}),"4px")));var l,t=JSON.parse(e.getText());null==t||0==t.length?mxUtils.write(h,mxResources.get("noFiles")):(l=!0,(e=mxUtils.bind(this,function(s){for(var e=0;e<t.length;e++)mxUtils.bind(this,function(e,t){var i,n;s==("dir"==e.type)&&((i=m.cloneNode()).style.backgroundColor=l?Editor.isDarkMode()?"#000000":"#eeeeee":"",l=!l,(n=document.createElement("img")).src=IMAGE_PATH+"/"+("dir"==e.type?"folder.png":"file.png"),n.setAttribute("align","absmiddle"),n.style.marginRight="4px",n.style.marginTop="-4px",n.width=20,i.appendChild(n),i.appendChild(g(e.name+("dir"==e.type?"/":""),mxUtils.bind(this,function(){"dir"==e.type?(d=e.path,w()):o&&"file"==e.type&&(this.ui.hideDialog(),r(u+"/"+a+"/"+encodeURIComponent(c)+"/"+e.path))}))),h.appendChild(i),0)})(t[e],e)}))(!0),o&&e(!1))}),b,!0)}),y=mxUtils.bind(this,function(n,s){null==n&&(h.innerHTML="",n=1);var e=new mxXmlRequest(this.baseUrl+"/repos/"+u+"/"+a+"/branches?per_page=100&page="+n,null,"GET");p.okButton.setAttribute("disabled","disabled"),this.ui.spinner.spin(h,mxResources.get("loading")),null!=U&&(mxEvent.removeListener(h,"scroll",U),U=null),null!=f&&null!=f.parentNode&&f.parentNode.removeChild(f),(f=document.createElement("a")).style.display="block",f.style.cursor="pointer",mxUtils.write(f,mxResources.get("more")+"...");var l=mxUtils.bind(this,function(){y(n+1)});mxEvent.addListener(f,"click",l),this.executeRequest(e,mxUtils.bind(this,function(e){this.ui.spinner.stop(),1==n&&(x(!0),h.appendChild(g("../ [Up]",mxUtils.bind(this,function(){d=null,v()}),"4px")));var t=JSON.parse(e.getText());if(null==t||0==t.length)mxUtils.write(h,mxResources.get("noFiles"));else if(1==t.length&&s)c=t[0].name,d="",w();else{for(var i=0;i<t.length;i++)mxUtils.bind(this,function(e,t){var i=m.cloneNode();i.style.backgroundColor=t%2==0?Editor.isDarkMode()?"#000000":"#eeeeee":"",i.appendChild(g(e.name,mxUtils.bind(this,function(){c=e.name,d="",w()}))),h.appendChild(i)})(t[i],i);100==t.length&&(h.appendChild(f),U=function(){h.scrollTop>=h.scrollHeight-h.offsetHeight&&l()},mxEvent.addListener(h,"scroll",U))}}),b)}),v=mxUtils.bind(this,function(n){null==n&&(h.innerHTML="",n=1);var e=new mxXmlRequest(this.baseUrl+"/user/repos?per_page=100&page="+n,null,"GET");p.okButton.setAttribute("disabled","disabled"),this.ui.spinner.spin(h,mxResources.get("loading")),null!=U&&mxEvent.removeListener(h,"scroll",U),null!=f&&null!=f.parentNode&&f.parentNode.removeChild(f),(f=document.createElement("a")).style.display="block",f.style.cursor="pointer",mxUtils.write(f,mxResources.get("more")+"...");var s=mxUtils.bind(this,function(){v(n+1)});mxEvent.addListener(f,"click",s),this.executeRequest(e,mxUtils.bind(this,function(e){this.ui.spinner.stop();var t=JSON.parse(e.getText());if(null==t||0==t.length)mxUtils.write(h,mxResources.get("noFiles"));else{1==n&&(h.appendChild(g(mxResources.get("enterValue")+"...",mxUtils.bind(this,function(){var e=new FilenameDialog(this.ui,"org/repo/ref",mxResources.get("ok"),mxUtils.bind(this,function(e){var t,i;null!=e&&(1<(i=e.split("/")).length?(t=i[0],e=i[1],i.length<3?(u=t,a=e,d=c=null,y()):this.ui.spinner.spin(h,mxResources.get("loading"))&&(i=encodeURIComponent(i.slice(2,i.length).join("/")),this.getFile(t+"/"+e+"/"+i,mxUtils.bind(this,function(e){this.ui.spinner.stop(),u=e.meta.org,a=e.meta.repo,c=decodeURIComponent(e.meta.ref),d="",w()}),mxUtils.bind(this,function(e){this.ui.spinner.stop(),this.ui.handleError({message:mxResources.get("fileNotFound")})})))):(this.ui.spinner.stop(),this.ui.handleError({message:mxResources.get("invalidName")})))}),mxResources.get("enterValue"));this.ui.showDialog(e.container,300,80,!0,!1),e.init()}))),mxUtils.br(h),mxUtils.br(h));for(var i=0;i<t.length;i++)mxUtils.bind(this,function(e,t){var i=m.cloneNode();i.style.backgroundColor=t%2==0?Editor.isDarkMode()?"#000000":"#eeeeee":"",i.appendChild(g(e.full_name,mxUtils.bind(this,function(){u=e.owner.login,a=e.name,y(null,!(d=""))}))),h.appendChild(i)})(t[i],i)}100==t.length&&(h.appendChild(f),U=function(){h.scrollTop>=h.scrollHeight-h.offsetHeight&&s()},mxEvent.addListener(h,"scroll",U))}),b)});v()},GitHubClient.prototype.logout=function(){this.clearPersistentToken(),this.setUser(null),h=null}}();