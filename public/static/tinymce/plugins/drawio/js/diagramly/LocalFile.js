LocalFile=function(i,e,t,l,s,n){DrawioFile.call(this,i,e),this.title=t,this.mode=l?null:App.MODE_DEVICE,this.fileHandle=s,this.desc=n},mxUtils.extend(LocalFile,DrawioFile),LocalFile.prototype.isAutosave=function(){return null!=this.fileHandle&&!this.invalidFileHandle&&DrawioFile.prototype.isAutosave.apply(this,arguments)},LocalFile.prototype.isAutosaveOptional=function(){return null!=this.fileHandle},LocalFile.prototype.getMode=function(){return this.mode},LocalFile.prototype.getTitle=function(){return this.title},LocalFile.prototype.isRenamable=function(){return!0},LocalFile.prototype.save=function(i,e,t){this.saveAs(this.title,e,t)},LocalFile.prototype.saveAs=function(i,e,t){this.saveFile(i,!1,e,t)},LocalFile.prototype.saveAs=function(i,e,t){this.saveFile(i,!1,e,t)},LocalFile.prototype.getDescriptor=function(){return this.desc},LocalFile.prototype.setDescriptor=function(i){this.desc=i},LocalFile.prototype.getLatestVersion=function(i,e){null==this.fileHandle?i(null):this.ui.loadFileSystemEntry(this.fileHandle,i,e)},LocalFile.prototype.saveFile=function(e,i,t,s,l){console.log("LocalFile-saveFile()"),e!=this.title&&(this.fileHandle=null,this.desc=null),this.title=e,l||this.updateFileData();var n=this.ui.useCanvasForExport&&/(\.png)$/i.test(this.getTitle());this.setShadowModified(!1);var o=this.getData(),a=mxUtils.bind(this,function(){console.log("LocalFile-saveFile.done()"),this.setModified(this.getShadowModified()),this.contentChanged(),null!=t&&t()}),h=mxUtils.bind(this,function(t){var l,i;null!=this.fileHandle?(console.log("LocalFile-saveFile-doSave(), null"),this.savingFile||(this.savingFileTime=new Date,this.savingFile=!0,l=mxUtils.bind(this,function(i){this.savingFile=!1,null!=s&&s({error:i})}),this.saveDraft(),this.fileHandle.createWritable().then(mxUtils.bind(this,function(e){this.fileHandle.getFile().then(mxUtils.bind(this,function(i){this.invalidFileHandle=null,this.desc.lastModified==i.lastModified?e.write(n?this.ui.base64ToBlob(t,"image/png"):t).then(mxUtils.bind(this,function(){e.close().then(mxUtils.bind(this,function(){this.fileHandle.getFile().then(mxUtils.bind(this,function(i){try{var e=this.desc;this.savingFile=!1,this.desc=i,this.fileSaved(o,e,a,l),this.removeDraft()}catch(i){l(i)}}),l)}),l)}),l):(this.inConflictState=!0,l())}),mxUtils.bind(this,function(i){this.invalidFileHandle=!0,l(i)}))}),l))):(console.log("LocalFile-saveFile-doSave(), localFileSave:"+this.ui.isLocalFileSave()),this.ui.isOfflineApp()||this.ui.isLocalFileSave()?this.ui.doSaveLocalFile(t,e,n?"image/png":"text/xml",n):t.length<MAX_REQUEST_SIZE?(i=0<(i=e.lastIndexOf("."))?e.substring(i+1):"xml",new mxXmlRequest(SAVE_URL,"format="+i+"&xml="+encodeURIComponent(t)+"&filename="+encodeURIComponent(e)+(n?"&binary=1":"")).simulate(document,"_blank")):this.ui.handleError({message:mxResources.get("drawingTooLarge")},mxResources.get("error"),mxUtils.bind(this,function(){mxUtils.popup(t)})),a())});n?(l=this.ui.getPngFileProperties(this.ui.fileNode),this.ui.getEmbeddedPng(mxUtils.bind(this,function(i){h(i)}),s,this.ui.getCurrentFile()!=this?o:null,l.scale,l.border)):(console.log("LocalFile-saveFile.doSave()"),h(o))},LocalFile.prototype.rename=function(i,e,t){this.title=i,this.descriptorChanged(),null!=e&&e()},LocalFile.prototype.open=function(){this.ui.setFileData(this.getData()),this.installListeners()};