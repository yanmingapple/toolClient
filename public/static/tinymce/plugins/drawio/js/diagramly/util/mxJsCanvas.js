function mxJsCanvas(t){mxAbstractCanvas2D.call(this),this.ctx=t.getContext("2d"),this.ctx.textBaseline="top",this.ctx.fillStyle="rgba(255,255,255,0)",this.ctx.strokeStyle="rgba(0, 0, 0, 0)",this.M_RAD_PER_DEG=Math.PI/180,this.images=null==this.images?[]:this.images,this.subCanvas=null==this.subCanvas?[]:this.subCanvas}mxUtils.extend(mxJsCanvas,mxAbstractCanvas2D),mxJsCanvas.prototype.ctx=null,mxJsCanvas.prototype.waitCounter=0,mxJsCanvas.prototype.onComplete=null,mxJsCanvas.prototype.images=null,mxJsCanvas.prototype.subCanvas=null,mxJsCanvas.prototype.canvasIndex=0,mxJsCanvas.prototype.hexToRgb=function(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,s,o,a){return s+s+o+o+a+a});t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},mxJsCanvas.prototype.incWaitCounter=function(){this.waitCounter++},mxJsCanvas.prototype.decWaitCounter=function(){this.waitCounter--,0==this.waitCounter&&null!=this.onComplete&&(this.onComplete(),this.onComplete=null)},mxJsCanvas.prototype.updateFont=function(){var t="";(this.state.fontStyle&mxConstants.FONT_BOLD)==mxConstants.FONT_BOLD&&(t+="bold "),(this.state.fontStyle&mxConstants.FONT_ITALIC)==mxConstants.FONT_ITALIC&&(t+="italic "),this.ctx.font=t+this.state.fontSize+"px "+this.state.fontFamily},mxJsCanvas.prototype.save=function(){this.states.push(this.state),this.state=mxUtils.clone(this.state),this.ctx.save()},mxJsCanvas.prototype.restore=function(){this.state=this.states.pop(),this.ctx.restore()},mxJsCanvas.prototype.scale=function(t){this.state.scale*=t,this.state.strokeWidth*=t,this.ctx.scale(t,t)},mxJsCanvas.prototype.translate=function(t,s){this.state.dx+=t,this.state.dy+=s,this.ctx.translate(t,s)},mxJsCanvas.prototype.rotate=function(t,s,o,a,e){a-=this.state.dx,e-=this.state.dy,this.ctx.translate(a,e),(s||o)&&this.ctx.scale(s?-1:1,o?-1:1),this.ctx.rotate(t*this.M_RAD_PER_DEG),this.ctx.translate(-a,-e)},mxJsCanvas.prototype.setAlpha=function(t){this.state.alpha=t,this.ctx.globalAlpha=t},mxJsCanvas.prototype.setFillColor=function(t){t==mxConstants.NONE&&(t=null),this.state.fillColor=t,this.state.gradientColor=null,this.ctx.fillStyle=t},mxJsCanvas.prototype.setGradient=function(t,s,o,a,e,n,i,h,l){a=this.ctx.createLinearGradient(0,a,0,a+n),n=this.state;n.fillColor=t,n.fillAlpha=null!=h?h:1,n.gradientColor=s,n.gradientAlpha=null!=l?l:1,n.gradientDirection=i;t=this.hexToRgb(t),s=this.hexToRgb(s);null!=t&&a.addColorStop(0,"rgba("+t.r+","+t.g+","+t.b+","+n.fillAlpha+")"),null!=s&&a.addColorStop(1,"rgba("+s.r+","+s.g+","+s.b+","+n.gradientAlpha+")"),this.ctx.fillStyle=a},mxJsCanvas.prototype.setStrokeColor=function(t){null==t||(t==mxConstants.NONE?(this.state.strokeColor=null,this.ctx.strokeStyle="rgba(0, 0, 0, 0)"):(this.ctx.strokeStyle=t,this.state.strokeColor=t))},mxJsCanvas.prototype.setStrokeWidth=function(t){this.ctx.lineWidth=t},mxJsCanvas.prototype.setDashed=function(t){if(this.state.dashed=t){for(var s=this.state.dashPattern.split(" "),o=0;o<s.length;o++)s[o]=parseInt(s[o],10);this.setLineDash(s)}else this.setLineDash([0])},mxJsCanvas.prototype.setLineDash=function(t){try{"function"==typeof this.ctx.setLineDash&&this.ctx.setLineDash(t)}catch(t){}},mxJsCanvas.prototype.setDashPattern=function(t){if(this.state.dashPattern=t,this.state.dashed){for(var s=t.split(" "),o=0;o<s.length;o++)s[o]=parseInt(s[o],10);this.ctx.setLineDash(s)}},mxJsCanvas.prototype.setLineCap=function(t){this.ctx.lineCap=t},mxJsCanvas.prototype.setLineJoin=function(t){this.ctx.lineJoin=t},mxJsCanvas.prototype.setMiterLimit=function(t){this.ctx.lineJoin=t},mxJsCanvas.prototype.setFontColor=function(t){this.ctx.fillStyle=t},mxJsCanvas.prototype.setFontBackgroundColor=function(t){t==mxConstants.NONE&&(t=null),this.state.fontBackgroundColor=t},mxJsCanvas.prototype.setFontBorderColor=function(t){t==mxConstants.NONE&&(t=null),this.state.fontBorderColor=t},mxJsCanvas.prototype.setFontSize=function(t){this.state.fontSize=t},mxJsCanvas.prototype.setFontFamily=function(t){this.state.fontFamily=t},mxJsCanvas.prototype.setFontStyle=function(t){this.state.fontStyle=t},mxJsCanvas.prototype.setShadow=function(t){(this.state.shadow=t)?(this.setShadowOffset(this.state.shadowDx,this.state.shadowDy),this.setShadowAlpha(this.state.shadowAlpha)):(this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0)},mxJsCanvas.prototype.setShadowColor=function(t){var s;null!=t&&t!=mxConstants.NONE||(t=null,this.ctx.shadowColor="transparent"),this.state.shadowColor=t,this.state.shadow&&null!=t&&(s=null!=this.state.shadowAlpha?this.state.shadowAlpha:1,t=this.hexToRgb(t),this.ctx.shadowColor="rgba("+t.r+","+t.g+","+t.b+","+s+")")},mxJsCanvas.prototype.setShadowAlpha=function(t){this.state.shadowAlpha=t,this.setShadowColor(this.state.shadowColor)},mxJsCanvas.prototype.setShadowOffset=function(t,s){this.state.shadowDx=t,this.state.shadowDy=s,this.state.shadow&&(this.ctx.shadowOffsetX=t,this.ctx.shadowOffsetY=s)},mxJsCanvas.prototype.moveTo=function(t,s){this.ctx.moveTo(t,s),this.lastMoveX=t,this.lastMoveY=s},mxJsCanvas.prototype.lineTo=function(t,s){this.ctx.lineTo(t,s),this.lastMoveX=t,this.lastMoveY=s},mxJsCanvas.prototype.quadTo=function(t,s,o,a){this.ctx.quadraticCurveTo(t,s,o,a),this.lastMoveX=o,this.lastMoveY=a},mxJsCanvas.prototype.arcTo=function(t,s,o,a,e,n,i){var h=mxUtils.arcToCurves(this.lastMoveX,this.lastMoveY,t,s,o,a,e,n,i);if(null!=h)for(var l=0;l<h.length;l+=6)this.curveTo(h[l],h[l+1],h[l+2],h[l+3],h[l+4],h[l+5])},mxJsCanvas.prototype.curveTo=function(t,s,o,a,e,n){this.ctx.bezierCurveTo(t,s,o,a,e,n),this.lastMoveX=e,this.lastMoveY=n},mxJsCanvas.prototype.rect=function(t,s,o,a){this.begin(),this.moveTo(t,s),this.lineTo(t+o,s),this.lineTo(t+o,s+a),this.lineTo(t,s+a),this.close()},mxJsCanvas.prototype.roundrect=function(t,s,o,a,e,n){this.begin(),this.moveTo(t+e,s),this.lineTo(t+o-e,s),this.quadTo(t+o,s,t+o,s+n),this.lineTo(t+o,s+a-n),this.quadTo(t+o,s+a,t+o-e,s+a),this.lineTo(t+e,s+a),this.quadTo(t,s+a,t,s+a-n),this.lineTo(t,s+n),this.quadTo(t,s,t+e,s)},mxJsCanvas.prototype.ellipse=function(t,s,o,a){this.ctx.save(),this.ctx.translate(t+o/2,s+a/2),this.ctx.scale(o/2,a/2),this.ctx.beginPath(),this.ctx.arc(0,0,1,0,2*Math.PI,!1),this.ctx.restore()},mxJsCanvas.prototype.rewriteImageSource=function(t){return t="http://"==t.substring(0,7)||"https://"==t.substring(0,8)?"/proxy?url="+encodeURIComponent(t):t},mxJsCanvas.prototype.image=function(t,s,o,a,e,r,c,x){this.state.scale;e=this.rewriteImageSource(e);e=this.images[e];null!=e&&0<e.height&&0<e.width&&!function(t,s,o,a,e,n){var i,h;t.save(),r&&(i=s.width,h=s.height,o+=(e-i*(l=Math.min(e/i,n/h)))/2,a+=(n-h*l)/2,e=i*l,n=h*l);var l=this.state.scale;c&&(t.translate(2*o+e,0),t.scale(-1,1)),x&&(t.translate(0,2*a+n),t.scale(1,-1)),t.drawImage(s,o,a,e,n),t.restore()}.call(this,this.ctx,e,t,s,o,a)},mxJsCanvas.prototype.begin=function(){this.ctx.beginPath()},mxJsCanvas.prototype.close=function(){this.ctx.closePath()},mxJsCanvas.prototype.fill=function(){this.ctx.fill()},mxJsCanvas.prototype.stroke=function(){this.ctx.stroke()},mxJsCanvas.prototype.fillAndStroke=function(){var t,s,o;this.state.shadow?(this.ctx.stroke(),this.ctx.fill(),t=this.ctx.shadowColor,s=this.ctx.shadowOffsetX,o=this.ctx.shadowOffsetY,this.ctx.shadowColor="transparent",this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.stroke(),this.ctx.shadowColor=t,this.ctx.shadowOffsetX=s,this.ctx.shadowOffsetY=o):(this.ctx.fill(),this.ctx.stroke())},mxJsCanvas.prototype.text=function(t,s,o,a,e,n,i,h,l,r,c,x){if(null!=e&&0!=e.length){var p=this.state.scale;if(0!=x&&(this.ctx.translate(Math.round(t),Math.round(s)),this.ctx.rotate(x*Math.PI/180),this.ctx.translate(Math.round(-t),Math.round(-s))),"html"==l){var u=this.subCanvas[this.canvasIndex++],f=u.height,C=u.width;switch(i){case mxConstants.ALIGN_MIDDLE:s-=f/2/p;break;case mxConstants.ALIGN_BOTTOM:s-=f/p}switch(n){case mxConstants.ALIGN_CENTER:t-=C/2/p;break;case mxConstants.ALIGN_RIGHT:t-=C/p}this.ctx.save(),null==this.state.fontBackgroundColor&&null==this.state.fontBorderColor||(null!=this.state.fontBackgroundColor&&(this.ctx.fillStyle=this.state.fontBackgroundColor,this.ctx.fillRect(Math.round(t)-.5,Math.round(s)-.5,Math.round(u.width/p),Math.round(u.height/p))),null!=this.state.fontBorderColor&&(this.ctx.strokeStyle=this.state.fontBorderColor,this.ctx.lineWidth=1,this.ctx.strokeRect(Math.round(t)-.5,Math.round(s)-.5,Math.round(u.width/p),Math.round(u.height/p)))),this.ctx.scale(1/p,1/p),this.ctx.drawImage(u,Math.round(t*p),Math.round(s*p)),this.ctx.restore()}else{this.ctx.save(),this.updateFont();l=document.createElement("div");l.innerHTML=e,l.style.position="absolute",l.style.top="-9999px",l.style.left="-9999px",l.style.fontFamily=this.state.fontFamily,l.style.fontWeight="bold",l.style.fontSize=this.state.fontSize+"pt",document.body.appendChild(l);u=[l.offsetWidth,l.offsetHeight];document.body.removeChild(l);var d=e.split("\n"),m=u[1];this.ctx.textBaseline="top";var v=s;switch(i){case mxConstants.ALIGN_MIDDLE:this.ctx.textBaseline="middle",v=(s-=(d.length-1)*m/2)-this.state.fontSize/2;break;case mxConstants.ALIGN_BOTTOM:this.ctx.textBaseline="alphabetic",v=(s-=m*(d.length-1))-this.state.fontSize}for(var y=[],g=[],J=0;J<d.length;J++)g[J]=t,y[J]=this.ctx.measureText(d[J]).width,null!=n&&n!=mxConstants.ALIGN_LEFT&&(g[J]-=y[J],n==mxConstants.ALIGN_CENTER&&(g[J]+=y[J]/2));if(null!=this.state.fontBackgroundColor||null!=this.state.fontBorderColor){for(var w=g[0],T=y[0],J=1;J<d.length;J++)w=Math.min(w,g[J]),T=Math.max(T,y[J]);this.ctx.save(),w=Math.round(w)-.5,v=Math.round(v)-.5,null!=this.state.fontBackgroundColor&&(this.ctx.fillStyle=this.state.fontBackgroundColor,this.ctx.fillRect(w,v,T,this.state.fontSize*mxConstants.LINE_HEIGHT*d.length)),null!=this.state.fontBorderColor&&(this.ctx.strokeStyle=this.state.fontBorderColor,this.ctx.lineWidth=1,this.ctx.strokeRect(w,v,T,this.state.fontSize*mxConstants.LINE_HEIGHT*d.length)),this.ctx.restore()}for(J=0;J<d.length;J++)this.ctx.fillText(d[J],g[J],s),s+=this.state.fontSize*mxConstants.LINE_HEIGHT;this.ctx.restore()}}},mxJsCanvas.prototype.getCanvas=function(){return canvas},mxJsCanvas.prototype.finish=function(t){0==this.waitCounter?t():this.onComplete=t};