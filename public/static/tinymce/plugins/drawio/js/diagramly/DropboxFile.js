DropboxFile=function(t,i,e){DrawioFile.call(this,t,i),this.stat=e},mxUtils.extend(DropboxFile,DrawioFile),DropboxFile.prototype.getId=function(){return this.stat.path_display.substring(1)},DropboxFile.prototype.getHash=function(){return"D"+encodeURIComponent(this.getId())},DropboxFile.prototype.getMode=function(){return App.MODE_DROPBOX},DropboxFile.prototype.isAutosaveOptional=function(){return!0},DropboxFile.prototype.getTitle=function(){return this.stat.name},DropboxFile.prototype.isRenamable=function(){return!0},DropboxFile.prototype.getSize=function(){return this.stat.size},DropboxFile.prototype.isRevisionHistorySupported=function(){return!0},DropboxFile.prototype.getRevisions=function(o,s){var t=this.ui.dropbox.client.filesListRevisions({path:this.stat.path_lower,limit:100});t.then(mxUtils.bind(this,function(t){try{for(var i=[],e=t.entries.length-1;0<=e;e--)mxUtils.bind(this,function(e){i.push({modifiedDate:e.client_modified,fileSize:e.size,getXml:mxUtils.bind(this,function(t,i){this.ui.dropbox.readFile({path:this.stat.path_lower,rev:e.rev},t,i)}),getUrl:mxUtils.bind(this,function(t){return this.ui.getUrl(window.location.pathname+"?rev="+e.rev+"&chrome=0&nav=1&layers=1&edit=_blank"+(null!=t?"&page="+t:""))+window.location.hash})})})(t.entries[e]);o(i)}catch(t){s(t)}})),t.catch(function(t){s(t)})},DropboxFile.prototype.getLatestVersion=function(t,i){this.ui.dropbox.getFile(this.getId(),t,i)},DropboxFile.prototype.updateDescriptor=function(t){this.stat=t.stat},DropboxFile.prototype.save=function(t,i,e,o,s){this.doSave(this.getTitle(),t,i,e,o,s)},DropboxFile.prototype.saveAs=function(t,i,e){this.doSave(t,!1,i,e)},DropboxFile.prototype.doSave=function(t,i,e,o,s,n){var r=this.stat.name;this.stat.name=t,DrawioFile.prototype.save.apply(this,[null,mxUtils.bind(this,function(){this.stat.name=r,this.saveFile(t,i,e,o,s,n)}),o,s,n])},DropboxFile.prototype.saveFile=function(o,t,s,n){var i;this.isEditable()?this.savingFile?null!=n&&n({code:App.ERROR_BUSY}):(i=mxUtils.bind(this,function(t){if(t)try{this.savingFileTime=new Date,this.setShadowModified(!1),this.savingFile=!0;var i,e=mxUtils.bind(this,function(t){var i=this.stat.path_display.lastIndexOf("/"),i=1<i?this.stat.path_display.substring(1,i+1):null;this.ui.dropbox.saveFile(o,t,mxUtils.bind(this,function(t){this.setModified(this.getShadowModified()),this.savingFile=!1,this.stat=t,this.contentChanged(),null!=s&&s()}),mxUtils.bind(this,function(t){this.savingFile=!1,null!=n&&n(t)}),i)});this.ui.useCanvasForExport&&/(\.png)$/i.test(this.getTitle())?(i=this.ui.getPngFileProperties(this.ui.fileNode),this.ui.getEmbeddedPng(mxUtils.bind(this,function(t){e(this.ui.base64ToBlob(t,"image/png"))}),n,this.ui.getCurrentFile()!=this?this.getData():null,i.scale,i.border)):e(this.getData())}catch(t){if(this.savingFile=!1,null==n)throw t;n(t)}else null!=n&&n()}),this.getTitle()==o?i(!0):this.ui.dropbox.checkExists(o,i)):null!=s&&s()},DropboxFile.prototype.rename=function(i,e,o){this.ui.dropbox.renameFile(this,i,mxUtils.bind(this,function(t){this.hasSameExtension(i,this.getTitle())?(this.stat=t,this.descriptorChanged(),null!=e&&e()):(this.stat=t,this.descriptorChanged(),this.save(!0,e,o))}),o)};