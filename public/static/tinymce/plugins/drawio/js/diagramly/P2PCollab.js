function P2PCollab(d){socket=io(App.SOCKET_IO_SRV);var s,u='<svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="684.000000pt" height="1024.000000pt" viewBox="0 0 684.000000 1024.000000" preserveAspectRatio="xMidYMid meet"><g transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)"  stroke="none" fill="',m='<path d="M0 5305 l0 -4940 568 567 c1170 1168 1637 1627 1644 1613 4 -7 242 -579 529 -1271 286 -693 523 -1262 527 -1266 4 -3 368 175 809 395 l802 402 -539 1294 c-297 712 -540 1296 -540 1298 0 2 682 3 1515 3 833 0 1515 3 1515 8 0 4 -1537 1544 -3415 3422 l-3415 3415 0 -4940z m3091 1175 l2604 -2599 -1304 -1 c-1236 0 -1303 -1 -1299 -17 3 -10 265 -641 582 -1402 318 -761 582 -1395 587 -1408 8 -22 -3 -29 -366 -210 -241 -121 -378 -184 -384 -178 -5 6 -262 622 -572 1370 -309 748 -564 1362 -566 1365 -2 2 -428 -420 -946 -938 -518 -518 -945 -942 -950 -942 -4 0 -7 1701 -7 3780 0 2224 4 3780 9 3780 5 0 1181 -1170 2612 -2600z"/></g></svg>',p=d.editor.graph,g=0,v=["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#808080","#000000"],y={},i=1,x={},n={},r={},a=!0,l=!1;function c(e,t){var o=d.getCurrentUser();if(l&&null!=o&&null!=o.email){var n=JSON.stringify({from:s,id:i,type:e,userId:o.id,username:o.displayName,data:t});for(p2pId in i++,a&&socket.emit("message",n),r)r[p2pId].send(n)}}function f(e){if(e=JSON.parse(e),!(x[e.from]>=e.id)){x[e.from]=e.id;var t,o,n,s=e.username||"Anonymous",i=e.userId;null==y[i]?(o=v[g],y[i]={cursor:document.createElement("div"),index:g,color:o},g++,(t=y[i].cursor).style.position="absolute",t.style.zIndex=5e3,n="data:image/svg+xml;base64,"+btoa(u+o+'">'+m),t.innerHTML='<img src="'+n+'" style="width:16px"><div style="color:'+o+'">'+s+"</div>",document.body.appendChild(t)):t=y[i].cursor;var r=e.data;switch(e.type){case"cursor":var a=p.view.translate,l=p.view.scale,c=d.diagramContainer,f=mxUtils.getOffset(c);r.x=(a.x+r.x)*l-c.scrollLeft+f.x,r.y=(a.y+r.y)*l-c.scrollTop+f.y,t.style.left=r.x+"px",t.style.top=r.y+"px";break;case"diff":f=d.getCurrentFile();null!=f.sync&&f.sync.p2pCatchup(r.data,r.from,r.to,r.id,f.getDescriptor(),function(){console.log("Diff Synced")},function(){console.log("Diff Error")})}}}function o(t,e){if(SimplePeer.WEBRTC_SUPPORT){var o=new SimplePeer({initiator:e});return o.on("signal",function(e){socket.emit("sendSignal",{to:t,from:s,signal:e})}),o.on("error",function(e){delete n[t],console.log("error",e)}),o.on("connect",function(){r[t]=o,delete n[t],0==Object.keys(n).length&&(a=!1,socket.emit("movedToP2P",""))}),o.on("close",function(){delete r[t]}),o.on("data",f),n[t]=o}}this.sendMessage=c,p.addMouseListener({startX:0,startY:0,scrollLeft:0,scrollTop:0,mouseDown:function(e,t){},mouseMove:function(e,t){var o=p.view.translate,n=p.view.scale;c("cursor",{x:t.graphX/n-o.x,y:t.graphY/n-o.y})},mouseUp:function(e,t){}}),socket.on("message",f),socket.on("clientsList",function(e){s=e.cId;for(var t=0;t<e.list.length;t++)o(e.list[t],!0)}),socket.on("signal",function(e){var t;n[e.from]?t=n[e.from]:(t=o(e.from,!1),a=!0),t.signal(e.signal)}),socket.on("newClient",function(e){a=!0}),this.joinFile=function(e){socket.emit("join",{name:e}),l=!0}}