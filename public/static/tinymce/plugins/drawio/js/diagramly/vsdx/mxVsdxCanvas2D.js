function mxVsdxCanvas2D(){mxAbstractCanvas2D.call(this)}mxUtils.extend(mxVsdxCanvas2D,mxAbstractCanvas2D),mxVsdxCanvas2D.prototype.textEnabled=!0,mxVsdxCanvas2D.prototype.init=function(e){this.filesLoading=0,this.zip=e},mxVsdxCanvas2D.prototype.onFilesLoaded=function(){},mxVsdxCanvas2D.prototype.createElt=function(e){return null!=this.xmlDoc.createElementNS?this.xmlDoc.createElementNS(VsdxExport.prototype.XMLNS,e):this.xmlDoc.createElement(e)},mxVsdxCanvas2D.prototype.createGeoSec=function(){null!=this.geoSec&&this.shape.appendChild(this.geoSec);var e=this.createElt("Section");e.setAttribute("N","Geometry"),e.setAttribute("IX",this.geoIndex++),this.geoSec=e,this.geoStepIndex=1,this.lastX=0,this.lastY=0,this.lastMoveToX=0,this.lastMoveToY=0},mxVsdxCanvas2D.prototype.newShape=function(e,t,i){this.geoIndex=0,this.shape=e,this.cellState=t,this.xmGeo=t.cell.geometry,this.xmlDoc=i,this.geoSec=null,this.shapeImg=null,this.shapeType="Shape",this.createGeoSec()},mxVsdxCanvas2D.prototype.newEdge=function(e,t,i){this.shape=e,this.cellState=t,this.xmGeo=t.cellBounds;this.state;this.xmlDoc=i},mxVsdxCanvas2D.prototype.endShape=function(){null!=this.shapeImg&&this.addForeignData(this.shapeImg.type,this.shapeImg.id)},mxVsdxCanvas2D.prototype.newPage=function(){this.images=[]},mxVsdxCanvas2D.prototype.getShapeType=function(){return this.shapeType},mxVsdxCanvas2D.prototype.getShapeGeo=function(){return this.geoSec},mxVsdxCanvas2D.prototype.createCellElemScaled=function(e,t,i){return this.createCellElem(e,t/VsdxExport.prototype.CONVERSION_FACTOR,i)},mxVsdxCanvas2D.prototype.createCellElem=function(e,t,i){var a=this.createElt("Cell");return a.setAttribute("N",e),a.setAttribute("V",t),i&&a.setAttribute("F",i),a},mxVsdxCanvas2D.prototype.createRowScaled=function(e,t,i,a,s,l,o,n,h,d,r,p,c,x){return this.createRowRel(e,t,i/VsdxExport.prototype.CONVERSION_FACTOR,a/VsdxExport.prototype.CONVERSION_FACTOR,s/VsdxExport.prototype.CONVERSION_FACTOR,l/VsdxExport.prototype.CONVERSION_FACTOR,o/VsdxExport.prototype.CONVERSION_FACTOR,n/VsdxExport.prototype.CONVERSION_FACTOR,h,d,r,p,c,x)},mxVsdxCanvas2D.prototype.createRowRel=function(e,t,i,a,s,l,o,n,h,d,r,p,c,x){var m=this.createElt("Row");return m.setAttribute("T",e),m.setAttribute("IX",t),m.appendChild(this.createCellElem("X",i,h)),m.appendChild(this.createCellElem("Y",a,d)),null!=s&&isFinite(s)&&m.appendChild(this.createCellElem("A",s,r)),null!=l&&isFinite(l)&&m.appendChild(this.createCellElem("B",l,p)),null!=o&&isFinite(o)&&m.appendChild(this.createCellElem("C",o,c)),null!=n&&isFinite(n)&&m.appendChild(this.createCellElem("D",n,x)),m},mxVsdxCanvas2D.prototype.begin=function(){1<this.geoStepIndex&&this.createGeoSec()},mxVsdxCanvas2D.prototype.rect=function(e,t,i,a){1<this.geoStepIndex&&this.createGeoSec();var s=this.state;i*=s.scale,a*=s.scale;var l=this.xmGeo;e=(e-l.x+s.dx)*s.scale,t=(l.height-t+l.y-s.dy)*s.scale,this.geoSec.appendChild(this.createRowScaled("MoveTo",this.geoStepIndex++,e,t)),this.geoSec.appendChild(this.createRowScaled("LineTo",this.geoStepIndex++,e+i,t)),this.geoSec.appendChild(this.createRowScaled("LineTo",this.geoStepIndex++,e+i,t-a)),this.geoSec.appendChild(this.createRowScaled("LineTo",this.geoStepIndex++,e,t-a)),this.geoSec.appendChild(this.createRowScaled("LineTo",this.geoStepIndex++,e,t))},mxVsdxCanvas2D.prototype.roundrect=function(e,t,i,a,s,l){this.rect(e,t,i,a),this.shape.appendChild(this.createCellElemScaled("Rounding",s))},mxVsdxCanvas2D.prototype.ellipse=function(e,t,i,a){1<this.geoStepIndex&&this.createGeoSec();var s=this.state;i*=s.scale,a*=s.scale;var l=this.xmGeo,o=l.height*s.scale,n=l.width*s.scale,h=((e=(e-l.x+s.dx)*s.scale)+i/2)/n,d=((t=o+(-t+l.y-s.dy)*s.scale)-a/2)/o,l=e/n,s=(t-a/2)/o,n=(e+i/2)/n,o=t/o;this.geoSec.appendChild(this.createRowScaled("Ellipse",this.geoStepIndex++,e+i/2,t-a/2,e,t-a/2,e+i/2,t,"Width*"+h,"Height*"+d,"Width*"+l,"Height*"+s,"Width*"+n,"Height*"+o))},mxVsdxCanvas2D.prototype.moveTo=function(e,t){1<this.geoStepIndex&&this.createGeoSec(),this.lastMoveToX=e,this.lastMoveToY=t,this.lastX=e,this.lastY=t;var i=this.xmGeo,a=this.state;e=(e-i.x+a.dx)*a.scale,t=(i.height-t+i.y-a.dy)*a.scale;var s=i.height*a.scale,a=i.width*a.scale;this.geoSec.appendChild(this.createRowRel("RelMoveTo",this.geoStepIndex++,e/a,t/s))},mxVsdxCanvas2D.prototype.lineTo=function(e,t){this.lastX=e,this.lastY=t;var i=this.xmGeo,a=this.state;e=(e-i.x+a.dx)*a.scale,t=(i.height-t+i.y-a.dy)*a.scale;var s=i.height*a.scale,a=i.width*a.scale;this.geoSec.appendChild(this.createRowRel("RelLineTo",this.geoStepIndex++,e/a,t/s))},mxVsdxCanvas2D.prototype.quadTo=function(e,t,i,a){this.lastX=i,this.lastY=a;var s=this.state,l=this.xmGeo,o=l.height*s.scale,n=l.width*s.scale;e=(e-l.x+s.dx)*s.scale,t=(l.height-t+l.y-s.dy)*s.scale,i=(i-l.x+s.dx)*s.scale,a=(l.height-a+l.y-s.dy)*s.scale,e/=n,t/=o,i/=n,a/=o,this.geoSec.appendChild(this.createRowRel("RelQuadBezTo",this.geoStepIndex++,i,a,e,t))},mxVsdxCanvas2D.prototype.curveTo=function(e,t,i,a,s,l){this.lastX=s,this.lastY=l;var o=this.state,n=this.xmGeo,h=n.height*o.scale,d=n.width*o.scale;e=(e-n.x+o.dx)*o.scale,t=(n.height-t+n.y-o.dy)*o.scale,i=(i-n.x+o.dx)*o.scale,a=(n.height-a+n.y-o.dy)*o.scale,s=(s-n.x+o.dx)*o.scale,l=(n.height-l+n.y-o.dy)*o.scale,e/=d,t/=h,i/=d,a/=h,s/=d,l/=h,this.geoSec.appendChild(this.createRowRel("RelCubBezTo",this.geoStepIndex++,s,l,e,t,i,a))},mxVsdxCanvas2D.prototype.close=function(){this.lastMoveToX==this.lastX&&this.lastMoveToY==this.lastY||this.lineTo(this.lastMoveToX,this.lastMoveToY)},mxVsdxCanvas2D.prototype.addForeignData=function(e,t){var i=this.createElt("ForeignData");i.setAttribute("ForeignType","Bitmap"),"BMP"!=(e=e.toUpperCase())&&i.setAttribute("CompressionType",e);e=this.createElt("Rel");e.setAttribute("r:id","rId"+t),i.appendChild(e),this.shape.appendChild(i),this.shapeType="Foreign"},mxVsdxCanvas2D.prototype.convertSvg2Png=function(t,e,i){var a=this;this.filesLoading++;try{var s=document.createElement("canvas"),l=s.getContext("2d");e||(t=String.fromCharCode.apply(null,new Uint8Array(t)),t=window.btoa?btoa(t):Base64.encode(t,!0));var o="data:image/svg+xml;base64,"+t;img=new Image,img.onload=function(){s.width=this.width,s.height=this.height,l.drawImage(this,0,0);try{i(s.toDataURL("image/png"))}catch(e){}a.filesLoading--,0==a.filesLoading&&a.onFilesLoaded()},img.onerror=function(){console.log("SVG2PNG conversion failed");try{i(t)}catch(e){}a.filesLoading--,0==a.filesLoading&&a.onFilesLoaded()},img.src=o}catch(e){console.log("SVG2PNG conversion failed"+e.message);try{i(t)}catch(e){}this.filesLoading--,0==a.filesLoading&&a.onFilesLoaded()}},mxVsdxCanvas2D.prototype.image=function(e,t,i,a,s,l,o,n){var h,d,r,p=this,c="image"+(this.images.length+1)+".";0==s.indexOf("data:")?(d=s.indexOf("base64,"),h=s.substring(d+7),0==(m=s.substring(11,d-1)).indexOf("svg")?(c+=m="png",this.convertSvg2Png(h,!0,function(e){p.zip.file("visio/media/"+c,e.substring(22),{base64:!0})})):(c+=m,this.zip.file("visio/media/"+c,h,{base64:!0}))):window.XMLHttpRequest&&(s=this.converter.convert(s),this.filesLoading++,d=s.lastIndexOf("."),m=s.substring(d+1),r=!1,0==m.indexOf("svg")&&(m="png",r=!0),c+=m,(x=new XMLHttpRequest).open("GET",s,!0),x.responseType="arraybuffer",x.onreadystatechange=function(e){4==this.readyState&&(200==this.status&&(r?p.convertSvg2Png(this.response,!1,function(e){p.zip.file("visio/media/"+c,e.substring(22),{base64:!0})}):p.zip.file("visio/media/"+c,this.response)),p.filesLoading--,0==p.filesLoading&&p.onFilesLoaded())},x.send()),this.images.push(c),this.shapeImg={type:m,id:this.images.length+1};var x=this.state;i*=x.scale,a*=x.scale;var m=this.xmGeo;e=(e-m.x+x.dx)*x.scale,t=(m.height-t+m.y-x.dy)*x.scale,this.shape.appendChild(this.createCellElemScaled("ImgOffsetX",e)),this.shape.appendChild(this.createCellElemScaled("ImgOffsetY",t-a)),this.shape.appendChild(this.createCellElemScaled("ImgWidth",i)),this.shape.appendChild(this.createCellElemScaled("ImgHeight",a))},mxVsdxCanvas2D.prototype.text=function(e,t,d,i,a,s,l,r,o,n,h,p,c){var x=this;if(this.textEnabled&&null!=a){mxUtils.isNode(a)&&(a=mxUtils.getOuterHtml(a)),0==d&&0==i&&(g=mxUtils.getSizeForString(a,x.cellState.style.fontSize,x.cellState.style.fontFamily),d=2*g.width,i=2*g.height),"html"==o&&("0"!=mxUtils.getValue(this.cellState.style,"nl2Br","1")&&(a=a.replace(/\n/g,"").replace(/<br\s*.?>/g,"\n")),null==this.html2txtDiv&&(this.html2txtDiv=document.createElement("div")),this.html2txtDiv.innerHTML=Graph.sanitizeHtml(a),a=mxUtils.extractTextWithWhitespace(this.html2txtDiv.childNodes));var m=this.state,g=this.xmGeo;d*=m.scale,i*=m.scale;var C=this.createElt("Section");C.setAttribute("N","Character");var S=this.createElt("Section");S.setAttribute("N","Paragraph");var u,y=this.createElt("Text"),f=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},v=0,E=0,V=0,b=0,I=0,T=0,D=0,R=function(e,t,i,a,s){var l=e.fontSize,o=e.fontFamily,n=mxUtils.getSizeForString(s,l,o);r&&n.width>d&&(n=mxUtils.getSizeForString(s,l,o,d)),e.blockElem?(I+=n.width,V=Math.min(Math.max(V,I),d),I=0,T=Math.max(T,n.height),b+=T+D,D=T,T=0):(I+=n.width,V=Math.min(Math.max(V,I),d),T=Math.max(T,n.height),b=Math.max(b,T));n=x.createElt("Row");n.setAttribute("IX",v),e.fontColor&&n.appendChild(x.createCellElem("Color",e.fontColor)),l&&n.appendChild(x.createCellElemScaled("Size",.97*l)),o&&n.appendChild(x.createCellElem("Font",o));o=0;e.bold&&(o|=17),e.italic&&(o|=34),e.underline&&(o|=4),n.appendChild(x.createCellElem("Style",o)),n.appendChild(x.createCellElem("Case","0")),n.appendChild(x.createCellElem("Pos","0")),n.appendChild(x.createCellElem("FontScale","1")),n.appendChild(x.createCellElem("Letterspace","0")),t.appendChild(n);n=x.createElt("Row");n.setAttribute("IX",E);var h=1;switch(e.align){case"left":h=0;break;case"center":h=1;break;case"right":h=2;break;case"start":h=0;break;case"end":h=2;break;case"justify":h=0;break;default:h=1}n.appendChild(x.createCellElem("HorzAlign",h)),i.appendChild(n);n=x.createElt("cp");n.setAttribute("IX",v++),a.appendChild(n);e=x.xmlDoc.createTextNode(s+(e.blockElem?"\n":""));a.appendChild(e)},L=function(e,t){t=t||{};for(var i=0;i<e.length;i++){var a,s,l,o,n,h,d=e[i];3==d.nodeType?(s=x.cellState.style.fontStyle,l=!(o={fontColor:t.fontColor||x.cellState.style.fontColor,fontSize:t.fontSize||x.cellState.style.fontSize,fontFamily:t.fontFamily||x.cellState.style.fontFamily,align:t.align||x.cellState.style.align,bold:t.bold||1&s,italic:t.italic||2&s,underline:t.underline||4&s}),i+1<e.length&&"BR"==e[i+1].nodeName.toUpperCase()&&(l=!0,i++),R(o,C,S,y,(t.OL?t.LiIndex+". ":"")+d.textContent+(l?"\n":""))):1==d.nodeType&&(a=d.nodeName.toUpperCase(),s=d.childNodes.length,o={bold:"bold"==(l=window.getComputedStyle(d,null)).getPropertyValue("font-weight")||t.bold,italic:"italic"==l.getPropertyValue("font-style")||t.italic,underline:0<=l.getPropertyValue("text-decoration").indexOf("underline")||t.underline,align:l.getPropertyValue("text-align"),fontColor:f(l.getPropertyValue("color")),fontSize:parseFloat(l.getPropertyValue("font-size")),fontFamily:l.getPropertyValue("font-family").replace(/"/g,""),blockElem:"block"==l.getPropertyValue("display")||"BR"==a||"LI"==a,OL:t.OL,LiIndex:t.LiIndex},"UL"==a?((n=x.createElt("Row")).setAttribute("IX",E),n.appendChild(x.createCellElem("HorzAlign","0")),n.appendChild(x.createCellElem("Bullet","1")),S.appendChild(n),(h=x.createElt("pp")).setAttribute("IX",E++),y.appendChild(h)):"OL"==a?o.OL=!0:"LI"==a&&(o.LiIndex=i+1),0<s?(L(d.childNodes,o),"UL"==a&&((n=x.createElt("Row")).setAttribute("IX",E),n.appendChild(x.createCellElem("Bullet","0")),S.appendChild(n),(h=x.createElt("pp")).setAttribute("IX",E++),y.appendChild(h)),R(o,C,S,y,"")):R(o,C,S,y,(t.OL?t.LiIndex+". ":"")+d.textContent))}};"html"==o&&mxClient.IS_SVG?null!=(o=this.cellState.text.node.getElementsByTagName("div")[mxClient.NO_FO?0:1])&&(u=o.childNodes,L(u,{})):(u={fontColor:x.cellState.style.fontColor,fontSize:x.cellState.style.fontSize,fontFamily:x.cellState.style.fontFamily},R(u,C,S,y,a));var w=0,F=0;i=Math.max(i,b);var N=(d=Math.max(d,V))/2,O=i/2,A=parseInt(mxUtils.getValue(this.cellState.style,"rotation","0")),M=A*Math.PI/180;switch(s){case"right":0!=A?(e-=N*Math.cos(M),t-=N*Math.sin(M)):w=V/2;break;case"center":break;case"left":0!=A?(e+=N*Math.cos(M),t+=N*Math.sin(M)):w=-V/2}switch(l){case"top":0!=A?(e+=O*Math.sin(M),t+=O*Math.cos(M)):F=b/2;break;case"middle":break;case"bottom":0!=A?(e-=O*Math.sin(M),t-=O*Math.cos(M)):F=-b/2}e=(e-g.x+m.dx)*m.scale,t=(g.height-t+g.y-m.dy)*m.scale,this.shape.appendChild(this.createCellElemScaled("TxtPinX",e)),this.shape.appendChild(this.createCellElemScaled("TxtPinY",t)),this.shape.appendChild(this.createCellElemScaled("TxtWidth",d)),this.shape.appendChild(this.createCellElemScaled("TxtHeight",i)),this.shape.appendChild(this.createCellElemScaled("TxtLocPinX",N+w)),this.shape.appendChild(this.createCellElemScaled("TxtLocPinY",O+F)),0!=(p-=A)&&this.shape.appendChild(this.createCellElem("TxtAngle",(360-p)*Math.PI/180)),this.shape.appendChild(C),this.shape.appendChild(S),this.shape.appendChild(y)}},mxVsdxCanvas2D.prototype.rotate=function(e,t,i,a,s){var l;0!=e&&(a+=(l=this.state).dx,s+=l.dy,a*=l.scale,s*=l.scale,this.shape.appendChild(this.createCellElem("Angle",(360-e)*Math.PI/180)),l.rotation=l.rotation+e,l.rotationCx=a,l.rotationCy=s)},mxVsdxCanvas2D.prototype.stroke=function(){this.geoSec.appendChild(this.createCellElem("NoFill","1")),this.geoSec.appendChild(this.createCellElem("NoLine","0"))},mxVsdxCanvas2D.prototype.fill=function(){this.geoSec.appendChild(this.createCellElem("NoFill","0")),this.geoSec.appendChild(this.createCellElem("NoLine","1"))},mxVsdxCanvas2D.prototype.fillAndStroke=function(){this.geoSec.appendChild(this.createCellElem("NoFill","0")),this.geoSec.appendChild(this.createCellElem("NoLine","0"))};