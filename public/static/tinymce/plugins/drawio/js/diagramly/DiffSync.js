EditorUi.DIFF_INSERT="i",EditorUi.DIFF_REMOVE="r",EditorUi.DIFF_UPDATE="u",EditorUi.prototype.codec=new mxCodec,EditorUi.prototype.viewStateProperties={background:!0,backgroundImage:!0,shadowVisible:!0,foldingEnabled:!0,pageScale:!0,mathEnabled:!0,pageFormat:!0,extFonts:!0},EditorUi.prototype.cellProperties={id:!0,value:!0,xmlValue:!0,vertex:!0,edge:!0,visible:!0,collapsed:!0,connectable:!0,parent:!0,children:!0,previous:!0,source:!0,target:!0,edges:!0,geometry:!0,style:!0,mxObjectId:!0,mxTransient:!0},EditorUi.prototype.patchPages=function(e,r,n,t,i){var o={},u=[],a={},l={},d={},s={};if(null!=t&&null!=t[EditorUi.DIFF_UPDATE])for(var g in t[EditorUi.DIFF_UPDATE])o[g]=t[EditorUi.DIFF_UPDATE][g];if(null!=r[EditorUi.DIFF_REMOVE])for(var p=0;p<r[EditorUi.DIFF_REMOVE].length;p++)l[r[EditorUi.DIFF_REMOVE][p]]=!0;if(null!=r[EditorUi.DIFF_INSERT])for(p=0;p<r[EditorUi.DIFF_INSERT].length;p++)a[r[EditorUi.DIFF_INSERT][p].previous]=r[EditorUi.DIFF_INSERT][p];if(null!=r[EditorUi.DIFF_UPDATE])for(var g in r[EditorUi.DIFF_UPDATE]){var c=r[EditorUi.DIFF_UPDATE][g];null!=c.previous&&(s[c.previous]=g)}if(null!=e)for(var v="",p=0;p<e.length;p++){var E=e[p].getId();d[E]=e[p],null!=s[v]||l[E]||null!=r[EditorUi.DIFF_UPDATE]&&null!=r[EditorUi.DIFF_UPDATE][E]&&null!=r[EditorUi.DIFF_UPDATE][E].previous||(s[v]=E),v=E}var h={},f=mxUtils.bind(this,function(e){var t,l=null!=e?e.getId():"";null==e||h[l]||(h[l]=!0,u.push(e),null!=(t=null!=r[EditorUi.DIFF_UPDATE]?r[EditorUi.DIFF_UPDATE][l]:null)&&(this.updatePageRoot(e),null!=t.name&&e.setName(t.name),null!=t.view&&this.patchViewState(e,t.view),null!=t.cells&&this.patchPage(e,t.cells,o[e.getId()],i),!n||null==t.cells&&null==t.view||(e.needsUpdate=!0)));e=s[l];null!=e&&(delete s[l],f(d[e]));e=a[l];null!=e&&(delete a[l],U(e))}),U=mxUtils.bind(this,function(e){var t=mxUtils.parseXml(e.data).documentElement,e=new DiagramPage(t);this.updatePageRoot(e);t=d[e.getId()];null==t?f(e):(t.root=e.root,this.currentPage==t?this.editor.graph.model.setRoot(t.root):n&&(t.needsUpdate=!0))});for(g in f(),s)f(d[s[g]]),delete s[g];for(g in a)U(a[g]),delete a[g];return u},EditorUi.prototype.patchViewState=function(e,t){if(null!=e.viewState&&null!=t){for(var l in e==this.currentPage&&(e.viewState=this.editor.graph.getViewState()),t)try{e.viewState[l]=JSON.parse(t[l])}catch(e){}e==this.currentPage&&this.editor.graph.setViewState(e.viewState,!0)}},EditorUi.prototype.createParentLookup=function(e,t){var l,r={};function n(e){var t=r[e];return null==t&&(r[e]=t={inserted:[],moved:{}}),t}if(null!=t[EditorUi.DIFF_INSERT])for(var i=0;i<t[EditorUi.DIFF_INSERT].length;i++){var o,u=null!=(o=t[EditorUi.DIFF_INSERT][i]).parent?o.parent:"",a=null!=o.previous?o.previous:"";n(u).inserted[a]=o}if(null!=t[EditorUi.DIFF_UPDATE])for(var d in t[EditorUi.DIFF_UPDATE])null!=(o=t[EditorUi.DIFF_UPDATE][d]).previous&&(null==(u=o.parent)&&(null==(l=e.getCell(d))||null!=(l=e.getParent(l))&&(u=l.getId())),null!=u&&(n(u).moved[o.previous]=d));return r},EditorUi.prototype.patchPage=function(e,t,l,r){var n=e==this.currentPage?this.editor.graph.model:new mxGraphModel(e.root),i=this.createParentLookup(n,t);n.beginUpdate();try{var o=n.updateEdgeParent,u=new mxDictionary,a=[];n.updateEdgeParent=function(e,t){!u.get(e)&&r&&(u.put(e,!0),a.push(e))};var d=i[""],s=null!=d&&null!=d.inserted?d.inserted[""]:null,g=null;if(null!=(g=null==(g=null!=s?this.getCellForJson(s):g)&&null!=(c=null!=d&&null!=d.moved?d.moved[""]:null)?n.getCell(c):g)&&(n.setRoot(g),e.root=g),this.patchCellRecursive(e,n,n.root,i,t),null!=t[EditorUi.DIFF_REMOVE])for(var p=0;p<t[EditorUi.DIFF_REMOVE].length;p++)null!=(E=n.getCell(t[EditorUi.DIFF_REMOVE][p]))&&n.remove(E);if(null!=t[EditorUi.DIFF_UPDATE]){var c,v=null!=l&&null!=l.cells?l.cells[EditorUi.DIFF_UPDATE]:null;for(c in t[EditorUi.DIFF_UPDATE])this.patchCell(n,n.getCell(c),t[EditorUi.DIFF_UPDATE][c],null!=v?v[c]:null)}if(null!=t[EditorUi.DIFF_INSERT])for(p=0;p<t[EditorUi.DIFF_INSERT].length;p++){var E,s=t[EditorUi.DIFF_INSERT][p];null!=(E=n.getCell(s.id))&&(n.setTerminal(E,n.getCell(s.source),!0),n.setTerminal(E,n.getCell(s.target),!1))}if(n.updateEdgeParent=o,r&&0<a.length)for(p=0;p<a.length;p++)n.contains(a[p])&&n.updateEdgeParent(a[p])}finally{n.endUpdate()}},EditorUi.prototype.patchCellRecursive=function(r,n,i,o,u){if(null!=i){for(var e=o[i.getId()],t=null!=e&&null!=e.inserted?e.inserted:{},l=null!=e&&null!=e.moved?e.moved:{},a=0,d=n.getChildCount(i),s="",g=0;g<d;g++){var p=n.getChildAt(i,g).getId();null==l[s]&&(null==u[EditorUi.DIFF_UPDATE]||null==u[EditorUi.DIFF_UPDATE][p]||null==u[EditorUi.DIFF_UPDATE][p].previous&&null==u[EditorUi.DIFF_UPDATE][p].parent)&&(l[s]=p),s=p}for(var c=mxUtils.bind(this,function(e,t){var l=null!=e?e.getId():"";return null==e||!t||null!=(t=n.getCell(l))&&t!=e&&(e=null),null!=e&&(n.getChildAt(i,a)!=e&&n.add(i,e,a),this.patchCellRecursive(r,n,e,o,u),a++),l}),v=[null];0<v.length;){var E=v.shift(),E=l[h=c(null!=E?E.child:null,null!=E&&E.insert)];null!=E&&(delete l[h],v.push({child:n.getCell(E)}));E=t[h];if(null!=E&&(delete t[h],v.push({child:this.getCellForJson(E),insert:!0})),0==v.length){for(var h in l)v.push({child:n.getCell(l[h])}),delete l[h];for(var h in t)v.push({child:this.getCellForJson(t[h]),insert:!0}),delete t[h]}}}},EditorUi.prototype.patchCell=function(e,t,l,r){if(null!=t&&null!=l)for(var n in null!=r&&(null!=r.xmlValue||null!=r.value&&""!=r.value)||("value"in l?e.setValue(t,l.value):null!=l.xmlValue&&e.setValue(t,mxUtils.parseXml(l.xmlValue).documentElement)),null!=r&&null!=r.style||null==l.style||e.setStyle(t,l.style),null!=l.visible&&e.setVisible(t,1==l.visible),null!=l.collapsed&&e.setCollapsed(t,1==l.collapsed),null!=l.vertex&&(t.vertex=1==l.vertex),null!=l.edge&&(t.edge=1==l.edge),null!=l.connectable&&(t.connectable=1==l.connectable),null!=l.geometry&&e.setGeometry(t,this.codec.decode(mxUtils.parseXml(l.geometry).documentElement)),null!=l.source&&e.setTerminal(t,e.getCell(l.source),!0),null!=l.target&&e.setTerminal(t,e.getCell(l.target),!1),l)this.cellProperties[n]||(t[n]=l[n])},EditorUi.prototype.getPagesForNode=function(e,t){var l=this.editor.extractGraphModel(e,!0,!0),r=(e=null!=l?l:e).getElementsByTagName(t||"diagram"),n=[];if(0<r.length)for(var i=0;i<r.length;i++){var o=new DiagramPage(r[i]);this.updatePageRoot(o,!0),n.push(o)}else"mxGraphModel"==e.nodeName&&(this.editor.graph,(o=new DiagramPage(e.ownerDocument.createElement("diagram"))).setName(mxResources.get("pageWithNumber",[1])),mxUtils.setTextContent(o.node,Graph.compressNode(e,!0)),n.push(o));return n},EditorUi.prototype.diffPages=function(e,t){this.editor.graph;for(var l=[],r=[],n={},i={},o={},u=null,a=0;a<t.length;a++)i[t[a].getId()]={page:t[a],prev:u},u=t[a];for(var d,s,g,u=null,a=0;a<e.length;a++)null==(p=i[g=e[a].getId()])?r.push(g):(s=this.diffPage(e[a],p.page),d={},0<Object.keys(s).length&&(d.cells=s),s=this.diffViewState(e[a],p.page),0<Object.keys(s).length&&(d.view=s),((null!=p.prev?null==u:null!=u)||null!=u&&null!=p.prev&&u.getId()!=p.prev.getId())&&(d.previous=null!=p.prev?p.prev.getId():""),null!=p.page.getName()&&e[a].getName()!=p.page.getName()&&(d.name=p.page.getName()),0<Object.keys(d).length&&(o[g]=d)),delete i[e[a].getId()],u=e[a];for(g in i){var p=i[g];l.push({data:mxUtils.getXml(p.page.node),previous:null!=p.prev?p.prev.getId():""})}return 0<Object.keys(o).length&&(n[EditorUi.DIFF_UPDATE]=o),0<r.length&&(n[EditorUi.DIFF_REMOVE]=r),0<l.length&&(n[EditorUi.DIFF_INSERT]=l),n},EditorUi.prototype.createCellLookup=function(e,t,l){(l=null!=l?l:{})[e.getId()]={cell:e,prev:t};var r=e.getChildCount();t=null;for(var n=0;n<r;n++){var i=e.getChildAt(n);this.createCellLookup(i,t,l),t=i}return l},EditorUi.prototype.diffCellRecursive=function(e,t,l,r,n){r=null!=r?r:{};var i,o=l[e.getId()];delete l[e.getId()],null==o?n.push(e.getId()):((null!=(i=this.diffCell(e,o.cell)).parent||(null!=o.prev?null==t:null!=t)||null!=t&&null!=o.prev&&t.getId()!=o.prev.getId())&&(i.previous=null!=o.prev?o.prev.getId():""),0<Object.keys(i).length&&(r[e.getId()]=i));var u=e.getChildCount();t=null;for(var a=0;a<u;a++){var d=e.getChildAt(a);this.diffCellRecursive(d,t,l,r,n),t=d}return r},EditorUi.prototype.diffPage=function(e,t){var l=[],r=[],n={};this.updatePageRoot(e),this.updatePageRoot(t);var i,o=this.createCellLookup(t.root),e=this.diffCellRecursive(e.root,null,o,void 0,r);for(i in o){var u=o[i];l.push(this.getJsonForCell(u.cell,u.prev))}return 0<Object.keys(e).length&&(n[EditorUi.DIFF_UPDATE]=e),0<r.length&&(n[EditorUi.DIFF_REMOVE]=r),0<l.length&&(n[EditorUi.DIFF_INSERT]=l),n},EditorUi.prototype.diffViewState=function(e,t){var l=e.viewState,r=t.viewState,n={};if(t==this.currentPage&&(r=this.editor.graph.getViewState()),null!=l&&null!=r)for(var i in this.viewStateProperties){var o=JSON.stringify(l[i]),u=JSON.stringify(r[i]);o!=u&&(n[i]=u)}return n},EditorUi.prototype.getCellForJson=function(e){var t=null!=e.geometry?this.codec.decode(mxUtils.parseXml(e.geometry).documentElement):null,l=e.value;null!=e.xmlValue&&(l=mxUtils.parseXml(e.xmlValue).documentElement);var r,n=new mxCell(l,t,e.style);for(r in n.connectable=0!=e.connectable,n.collapsed=1==e.collapsed,n.visible=0!=e.visible,n.vertex=1==e.vertex,n.edge=1==e.edge,n.id=e.id,e)this.cellProperties[r]||(n[r]=e[r]);return n},EditorUi.prototype.getJsonForCell=function(e,t){var l,r={id:e.getId()};for(l in e.vertex&&(r.vertex=1),e.edge&&(r.edge=1),e.connectable||(r.connectable=0),null!=e.parent&&(r.parent=e.parent.getId()),null!=t&&(r.previous=t.getId()),null!=e.source&&(r.source=e.source.getId()),null!=e.target&&(r.target=e.target.getId()),null!=e.style&&(r.style=e.style),null!=e.geometry&&(r.geometry=mxUtils.getXml(this.codec.encode(e.geometry))),e.collapsed&&(r.collapsed=1),e.visible||(r.visible=0),null!=e.value&&("object"==typeof e.value&&"number"==typeof e.value.nodeType&&"string"==typeof e.value.nodeName&&"function"==typeof e.value.getAttribute?r.xmlValue=mxUtils.getXml(e.value):r.value=e.value),e)this.cellProperties[l]||"function"==typeof e[l]||(r[l]=e[l]);return r},EditorUi.prototype.diffCell=function(e,t){var l,r,n={};function i(e){return null!=e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName&&"function"==typeof e.getAttribute}for(r in e.vertex!=t.vertex&&(n.vertex=t.vertex?1:0),e.edge!=t.edge&&(n.edge=t.edge?1:0),e.connectable!=t.connectable&&(n.connectable=t.connectable?1:0),((null!=e.parent?null==t.parent:null!=t.parent)||null!=e.parent&&null!=t.parent&&e.parent.getId()!=t.parent.getId())&&(n.parent=null!=t.parent?t.parent.getId():""),((null!=e.source?null==t.source:null!=t.source)||null!=e.source&&null!=t.source&&e.source.getId()!=t.source.getId())&&(n.source=null!=t.source?t.source.getId():""),((null!=e.target?null==t.target:null!=t.target)||null!=e.target&&null!=t.target&&e.target.getId()!=t.target.getId())&&(n.target=null!=t.target?t.target.getId():""),i(e.value)&&i(t.value)?e.value.isEqualNode(t.value)||(n.xmlValue=mxUtils.getXml(t.value)):e.value!=t.value&&(i(t.value)?n.xmlValue=mxUtils.getXml(t.value):n.value=null!=t.value?t.value:null),e.style!=t.style&&(n.style=t.style),e.visible!=t.visible&&(n.visible=t.visible?1:0),e.collapsed!=t.collapsed&&(n.collapsed=t.collapsed?1:0),this.isObjectEqual(e.geometry,t.geometry,new mxGeometry)||null!=(l=this.codec.encode(t.geometry))&&(n.geometry=mxUtils.getXml(l)),e)this.cellProperties[r]||"function"==typeof e[r]||"function"==typeof t[r]||e[r]==t[r]||(n[r]=void 0===t[r]?null:t[r]);for(r in t)r in e||this.cellProperties[r]||"function"==typeof e[r]||"function"==typeof t[r]||e[r]==t[r]||(n[r]=void 0===t[r]?null:t[r]);return n},EditorUi.prototype.isObjectEqual=function(e,t,l){if(null==e&&null==t)return!0;if(null!=e?null==t:null!=t)return!1;function r(e,t){return null==l||l[e]!=t?!0===t?1:t:void 0}return JSON.stringify(e,r)==JSON.stringify(t,r)};