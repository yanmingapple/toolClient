!function(){var y=null;window.GitLabClient=function(e){GitHubClient.call(this,e,"gitlabauth")},mxUtils.extend(GitLabClient,GitHubClient),GitLabClient.prototype.clientId=DRAWIO_GITLAB_ID,GitLabClient.prototype.scope="api%20read_repository%20write_repository",GitLabClient.prototype.baseUrl=DRAWIO_GITLAB_URL+"/api/v4",GitLabClient.prototype.maxFileSize=1e7,GitLabClient.prototype.authToken="Bearer",GitLabClient.prototype.redirectUri=window.location.protocol+"//"+window.location.host+"/gitlab",GitLabClient.prototype.authenticate=function(t,i){new mxXmlRequest(this.redirectUri+"?getState=1",null,"GET").send(mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?this.authenticateStep2(e.getText(),t,i):null!=i&&i(e)}),i)},GitLabClient.prototype.authenticateStep2=function(e,l,o){var r;null==window.onGitLabCallback?(r=mxUtils.bind(this,function(){var s=!0;null!=this.getPersistentToken(!0)?new mxXmlRequest(this.redirectUri+"?state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+e),null,"GET").send(mxUtils.bind(this,function(e){200<=e.getStatus()&&e.getStatus()<=299?(y=JSON.parse(e.getText()).access_token,this.setToken(y),this.setUser(null),l()):(this.clearPersistentToken(),this.setUser(null),y=null,this.setToken(null),401==e.getStatus()?r():o({message:mxResources.get("accessDenied"),retry:r}))}),o):this.ui.showAuthDialog(this,!0,mxUtils.bind(this,function(i,n){null!=window.open(DRAWIO_GITLAB_URL+"/oauth/authorize?client_id="+this.clientId+"&scope="+this.scope+"&redirect_uri="+encodeURIComponent(this.redirectUri)+"&response_type=code&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+e),"gitlabauth")?window.onGitLabCallback=mxUtils.bind(this,function(e,t){s?(window.onGitLabCallback=null,s=!1,null==e?o({message:mxResources.get("accessDenied"),retry:r}):(null!=n&&n(),y=e.access_token,this.setToken(y),this.setUser(null),i&&this.setPersistentToken("remembered"),l(),null!=t&&t.close())):null!=t&&t.close()}):o({message:mxResources.get("serviceUnavailableOrBlocked"),retry:r})}),mxUtils.bind(this,function(){s&&(window.onGitLabCallback=null,s=!1,o({message:mxResources.get("accessDenied"),retry:r}))}))}))():o({code:App.ERROR_BUSY})},GitLabClient.prototype.executeRequest=function(o,r,a,u){var c=mxUtils.bind(this,function(i){var n=!0,s=window.setTimeout(mxUtils.bind(this,function(){n=!1,a({code:App.ERROR_TIMEOUT,message:mxResources.get("timeout")})}),this.ui.timeout),l=this.authToken+" "+y;o.setRequestHeaders=function(e,t){e.setRequestHeader("Authorization",l),e.setRequestHeader("PRIVATE_TOKEN",l),e.setRequestHeader("Content-Type","application/json")},o.send(mxUtils.bind(this,function(){if(window.clearTimeout(s),n)if(200<=o.getStatus()&&o.getStatus()<=299||u&&404==o.getStatus())r(o);else if(401===o.getStatus())i?a({message:mxResources.get("accessDenied"),retry:mxUtils.bind(this,function(){this.authenticate(function(){d(!0)},a)})}):this.authenticate(function(){c(!0)},a);else if(403===o.getStatus()){var e=!1;try{var t=JSON.parse(o.getText());null!=t&&null!=t.errors&&0<t.errors.length&&(e="too_large"==t.errors[0].code)}catch(e){}a({message:mxResources.get(e?"drawingTooLarge":"forbidden")})}else 404===o.getStatus()?a({message:this.getErrorMessage(o,mxResources.get("fileNotFound"))}):400===o.getStatus()?a({status:400}):a({status:o.getStatus(),message:this.getErrorMessage(o,mxResources.get("error")+" "+o.getStatus())})}),mxUtils.bind(this,function(e){window.clearTimeout(s),n&&a(e)}))}),d=mxUtils.bind(this,function(e){null==this.user?this.updateUser(function(){d(!0)},a,e):c(e)});null==y?this.authenticate(function(){d(!0)},a):d(!1)},GitLabClient.prototype.getRefIndex=function(l,o,r,a,e,u){var c,d;null!=e?r(l,e):(c=l.length-2,(d=mxUtils.bind(this,function(){var e,t,i,n,s;c<2?a({message:mxResources.get("fileNotFound")}):(i=Math.max(c-1,0),e=l.slice(0,i).join("/"),t=l[i],n=l[c],i=l.slice(c+1,l.length).join("/"),n=this.baseUrl+"/projects/"+encodeURIComponent(e+"/"+t)+"/repository/"+(o?u?"branches?per_page=1&page=1&ref="+n:"tree?path="+i+"&ref="+n:"files/"+encodeURIComponent(i)+"?ref="+n),s=new mxXmlRequest(n,null,"HEAD"),this.executeRequest(s,mxUtils.bind(this,function(){200==s.getStatus()?r(l,c):a({message:mxResources.get("fileNotFound")})}),mxUtils.bind(this,function(){404==s.getStatus()?(c--,d()):a({message:mxResources.get("fileNotFound")})})))}))())},GitLabClient.prototype.getFile=function(a,u,c,d,h,e){d=null!=d&&d,this.getRefIndex(a.split("/"),!1,mxUtils.bind(this,function(e,t){var i=Math.max(t-1,0),n=e.slice(0,i).join("/"),s=e[i],l=e[t];a=e.slice(t+1,e.length).join("/");var o,r,i=/\.png$/i.test(a);!h&&(/\.v(dx|sdx?)$/i.test(a)||/\.gliffy$/i.test(a)||/\.pdf$/i.test(a)||!this.ui.useCanvasForExport&&i)?null!=y?(r="&t="+(new Date).getTime(),o=this.baseUrl+"/projects/"+encodeURIComponent(n+"/"+s)+"/repository/files/"+encodeURIComponent(a)+"?ref="+l,e=0<(e=a.split("/")).length?e[e.length-1]:a,this.ui.convertFile(o+r,e,null,this.extension,u,c,mxUtils.bind(this,function(e,t,i){e=new mxXmlRequest(e,null,"GET");this.executeRequest(e,mxUtils.bind(this,function(e){try{t(this.getFileContent(JSON.parse(e.getText())))}catch(e){i(e)}}),i)}))):c({message:mxResources.get("accessDenied")}):(r="&t="+(new Date).getTime(),o=this.baseUrl+"/projects/"+encodeURIComponent(n+"/"+s)+"/repository/files/"+encodeURIComponent(a)+"?ref="+l,r=new mxXmlRequest(o+r,null,"GET"),this.executeRequest(r,mxUtils.bind(this,function(e){try{u(this.createGitLabFile(n,s,l,JSON.parse(e.getText()),d,t))}catch(e){c(e)}}),c))}),c,e)},GitLabClient.prototype.getFileContent=function(e){var t=e.file_name,i=e.content;return i="base64"===e.encoding?/\.jpe?g$/i.test(t)?"data:image/jpeg;base64,"+i:/\.gif$/i.test(t)?"data:image/gif;base64,"+i:/\.pdf$/i.test(t)?"data:application/pdf;base64,"+i:/\.png$/i.test(t)?null!=(t=this.ui.extractGraphModelFromPng(i))&&0<t.length?t:"data:image/png;base64,"+i:Base64.decode(i):i},GitLabClient.prototype.createGitLabFile=function(e,t,i,n,s,l){var o=DRAWIO_GITLAB_URL+"/",r=o+e+"/"+t+"/blob/"+i+"/"+n.file_path,o=o+e+"/"+t+"/raw/"+i+"/"+n.file_path+"?inline=false",l={org:e,repo:t,ref:i,name:n.file_name,path:n.file_path,html_url:r,download_url:o,last_commit_id:n.last_commit_id,refPos:l},n=this.getFileContent(n);return new(s?GitLabLibrary:GitLabFile)(this.ui,n,l)},GitLabClient.prototype.insertFile=function(r,a,u,c,d,e,h){d=null!=d&&d;e=e.split("/");this.getRefIndex(e,!0,mxUtils.bind(this,function(e,n){var t=Math.max(n-1,0),s=e.slice(0,t).join("/"),l=e[t],o=e[n];path=e.slice(n+1,e.length).join("/"),0<path.length&&(path+="/"),path+=r,this.checkExists(s+"/"+l+"/"+o+"/"+path,!0,mxUtils.bind(this,function(e,t){var i;e?d?(h||(a=Base64.encode(a)),this.showCommitDialog(r,!0,mxUtils.bind(this,function(e){this.writeFile(s,l,o,path,e,a,t,mxUtils.bind(this,function(e){try{var t=JSON.parse(e.getText());u(this.createGitLabFile(s,l,o,null!=t.content?t.content:t,d,n))}catch(e){c(e)}}),c)}),c)):(e=(i=DRAWIO_GITLAB_URL+"/")+s+"/"+l+"/blob/"+o+"/"+path,i=i+s+"/"+l+"/raw/"+o+"/"+path+"?inline=false",u(new GitLabFile(this.ui,a,{org:s,repo:l,ref:o,name:r,path:path,html_url:e,download_url:i,refPos:n,last_commit_id:t,isNew:!0}))):c()}))}),c,null,e.length<=4)},GitLabClient.prototype.checkExists=function(i,n,s){this.getFile(i,mxUtils.bind(this,function(e){var t;n?(t=this.ui.spinner.pause(),this.ui.confirm(mxResources.get("replaceIt",[i]),function(){t(),s(!0,e.getCurrentEtag())},function(){t(),s(!1)})):(this.ui.spinner.stop(),this.ui.showError(mxResources.get("error"),mxResources.get("fileExists"),mxResources.get("ok"),function(){s(!1)}))}),mxUtils.bind(this,function(e){s(!0)}),null,!0)},GitLabClient.prototype.writeFile=function(e,t,i,n,s,l,o,r,a){var u;l.length>=this.maxFileSize?a({message:mxResources.get("drawingTooLarge")+" ("+this.ui.formatFileSize(l.length)+" / 10 MB)"}):(u="POST",l={path:encodeURIComponent(n),branch:decodeURIComponent(i),commit_message:s,content:l,encoding:"base64"},null!=o&&(l.last_commit_id=o,u="PUT"),n=this.baseUrl+"/projects/"+encodeURIComponent(e+"/"+t)+"/repository/files/"+encodeURIComponent(n),u=new mxXmlRequest(n,JSON.stringify(l),u),this.executeRequest(u,mxUtils.bind(this,function(e){r(e)}),a))},GitLabClient.prototype.saveFile=function(i,n,s,e,l){var o=i.meta.org,r=i.meta.repo,a=i.meta.ref,u=i.meta.path,t=mxUtils.bind(this,function(e,t){this.writeFile(o,r,a,u,l,t,e,mxUtils.bind(this,function(e){delete i.meta.isNew,this.getFile(o+"/"+r+"/"+a+"/"+u,mxUtils.bind(this,function(e){e.getData()==i.getData()?n(e.getCurrentEtag()):n({content:i.getCurrentEtag()})}),s,null,null,i.meta.refPos)}),s)}),c=mxUtils.bind(this,function(){var e;this.ui.useCanvasForExport&&/(\.png)$/i.test(u)?(e=this.ui.getPngFileProperties(this.ui.fileNode),this.ui.getEmbeddedPng(mxUtils.bind(this,function(e){t(i.meta.last_commit_id,e)}),s,this.ui.getCurrentFile()!=i?i.getData():null,e.scale,e.border)):t(i.meta.last_commit_id,Base64.encode(i.getData()))});e?this.getFile(o+"/"+r+"/"+a+"/"+u,mxUtils.bind(this,function(e){i.meta.last_commit_id=e.meta.last_commit_id,c()}),s):c()},GitLabClient.prototype.pickFolder=function(e){this.showGitLabDialog(!1,e)},GitLabClient.prototype.pickFile=function(e){e=null!=e?e:mxUtils.bind(this,function(e){this.ui.loadFile("A"+encodeURIComponent(e))}),this.showGitLabDialog(!0,e)},GitLabClient.prototype.showGitLabDialog=function(o,r){var d=null,h=null,m=null,p=null,e=document.createElement("div");e.style.whiteSpace="nowrap",e.style.overflow="hidden",e.style.height="304px";var t=document.createElement("h3");mxUtils.write(t,mxResources.get(o?"selectFile":"selectFolder")),t.style.cssText="width:100%;text-align:center;margin-top:0px;margin-bottom:12px",e.appendChild(t);var g=document.createElement("div");g.style.whiteSpace="nowrap",g.style.border="1px solid lightgray",g.style.boxSizing="border-box",g.style.padding="4px",g.style.overflow="auto",g.style.lineHeight="1.2em",g.style.height="274px",e.appendChild(g);var x=document.createElement("div");x.style.textOverflow="ellipsis",x.style.boxSizing="border-box",x.style.overflow="hidden",x.style.padding="4px",x.style.width="100%";var a=new CustomDialog(this.ui,e,mxUtils.bind(this,function(){r(d+"/"+h+"/"+encodeURIComponent(m)+"/"+p)}));this.ui.showDialog(a.container,420,370,!0,!0),o&&a.okButton.parentNode.removeChild(a.okButton);var b=mxUtils.bind(this,function(e,t,i,n){var s=document.createElement("a");return s.setAttribute("title",e),s.style.cursor="pointer",mxUtils.write(s,e),mxEvent.addListener(s,"click",t),n&&(s.style.textDecoration="underline"),null!=i&&((n=x.cloneNode()).style.padding=i,n.appendChild(s),s=n),s}),u=mxUtils.bind(this,function(e){var t=document.createElement("div");if(t.style.marginBottom="8px",t.appendChild(b(d+"/"+h,mxUtils.bind(this,function(){p=null,v()}),null,!0)),e||(mxUtils.write(t," / "),t.appendChild(b(decodeURIComponent(m),mxUtils.bind(this,function(){p=null,w()}),null,!0))),null!=p&&0<p.length)for(var i=p.split("/"),n=0;n<i.length;n++)!function(e){mxUtils.write(t," / "),t.appendChild(b(i[e],mxUtils.bind(this,function(){p=i.slice(0,e+1).join("/"),C()}),null,!0))}(n);g.appendChild(t)}),f=mxUtils.bind(this,function(e){this.ui.handleError(e,null,mxUtils.bind(this,function(){this.ui.spinner.stop(),null!=this.getUser()?(p=m=h=d=null,v()):this.ui.hideDialog()}))}),U=null,R=null,C=mxUtils.bind(this,function(i){null==i&&(g.innerHTML="",i=1);var e=new mxXmlRequest(this.baseUrl+"/projects/"+encodeURIComponent(d+"/"+h)+"/repository/tree?path="+p+"&ref="+m+"&per_page=100&page="+i,null,"GET");this.ui.spinner.spin(g,mxResources.get("loading")),a.okButton.removeAttribute("disabled"),null!=R&&(mxEvent.removeListener(g,"scroll",R),R=null),null!=U&&null!=U.parentNode&&U.parentNode.removeChild(U),(U=document.createElement("a")).style.display="block",U.style.cursor="pointer",mxUtils.write(U,mxResources.get("more")+"...");var n=mxUtils.bind(this,function(){C(i+1)});mxEvent.addListener(U,"click",n),this.executeRequest(e,mxUtils.bind(this,function(e){this.ui.spinner.stop(),1==i&&(u(!m),g.appendChild(b("../ [Up]",mxUtils.bind(this,function(){var e;""==p?(p=null,v()):(p=(e=p.split("/")).slice(0,e.length-1).join("/"),C())}),"4px")));var s,l,t=JSON.parse(e.getText());null==t||0==t.length?mxUtils.write(g,mxResources.get("noFiles")):(s=!0,l=0,(e=mxUtils.bind(this,function(n){for(var e=0;e<t.length;e++)mxUtils.bind(this,function(e){var t,i;n==("tree"==e.type)&&((t=x.cloneNode()).style.backgroundColor=s?Editor.isDarkMode()?"#000000":"#eeeeee":"",s=!s,(i=document.createElement("img")).src=IMAGE_PATH+"/"+("tree"==e.type?"folder.png":"file.png"),i.setAttribute("align","absmiddle"),i.style.marginRight="4px",i.style.marginTop="-4px",i.width=20,t.appendChild(i),t.appendChild(b(e.name+("tree"==e.type?"/":""),mxUtils.bind(this,function(){"tree"==e.type?(p=e.path,C()):o&&"blob"==e.type&&(this.ui.hideDialog(),r(d+"/"+h+"/"+m+"/"+e.path))}))),g.appendChild(t),l++)})(t[e])}))(!0),o&&e(!1),100==l&&(g.appendChild(U),R=function(){g.scrollTop>=g.scrollHeight-g.offsetHeight&&n()},mxEvent.addListener(g,"scroll",R)))}),f,!0)}),w=mxUtils.bind(this,function(n,s){null==n&&(g.innerHTML="",n=1);var e=new mxXmlRequest(this.baseUrl+"/projects/"+encodeURIComponent(d+"/"+h)+"/repository/branches?per_page=100&page="+n,null,"GET");a.okButton.setAttribute("disabled","disabled"),this.ui.spinner.spin(g,mxResources.get("loading")),null!=R&&(mxEvent.removeListener(g,"scroll",R),R=null),null!=U&&null!=U.parentNode&&U.parentNode.removeChild(U),(U=document.createElement("a")).style.display="block",U.style.cursor="pointer",mxUtils.write(U,mxResources.get("more")+"...");var l=mxUtils.bind(this,function(){w(n+1)});mxEvent.addListener(U,"click",l),this.executeRequest(e,mxUtils.bind(this,function(e){this.ui.spinner.stop(),1==n&&(u(!0),g.appendChild(b("../ [Up]",mxUtils.bind(this,function(){p=null,v()}),"4px")));var t=JSON.parse(e.getText());if(null==t||0==t.length)mxUtils.write(g,mxResources.get("noFiles"));else if(1==t.length&&s)m=t[0].name,p="",C();else{for(var i=0;i<t.length;i++)mxUtils.bind(this,function(e,t){var i=x.cloneNode();i.style.backgroundColor=t%2==0?Editor.isDarkMode()?"#000000":"#eeeeee":"",i.appendChild(b(e.name,mxUtils.bind(this,function(){m=encodeURIComponent(e.name),p="",C()}))),g.appendChild(i)})(t[i],i);100==t.length&&(g.appendChild(U),R=function(){g.scrollTop>=g.scrollHeight-g.offsetHeight&&l()},mxEvent.addListener(g,"scroll",R))}}),f)});a.okButton.setAttribute("disabled","disabled"),this.ui.spinner.spin(g,mxResources.get("loading"));var v=mxUtils.bind(this,function(l){var e=this.ui.spinner,o=0;this.ui.spinner.stop();function r(){e.spin(g,mxResources.get("loading")),o+=1}function a(){0===--o&&e.stop()}null==l&&(g.innerHTML="",l=1),null!=R&&(mxEvent.removeListener(g,"scroll",R),R=null),null!=U&&null!=U.parentNode&&U.parentNode.removeChild(U),(U=document.createElement("a")).style.display="block",U.style.cursor="pointer",mxUtils.write(U,mxResources.get("more")+"...");var u=mxUtils.bind(this,function(){0===o&&v(l+1)});mxEvent.addListener(U,"click",u);var t=mxUtils.bind(this,function(t){r();var e=new mxXmlRequest(this.baseUrl+"/groups?per_page=100",null,"GET");this.executeRequest(e,mxUtils.bind(this,function(e){t(JSON.parse(e.getText())),a()}),f)}),c=mxUtils.bind(this,function(t,i){r();var e=new mxXmlRequest(this.baseUrl+"/groups/"+t.id+"/projects?per_page=100",null,"GET");this.executeRequest(e,mxUtils.bind(this,function(e){i(t,JSON.parse(e.getText())),a()}),f)});t(mxUtils.bind(this,function(n){var e;null==this.user?mxUtils.write(g,mxResources.get("loggedOut")):(r(),e=new mxXmlRequest(this.baseUrl+"/users/"+this.user.id+"/projects?per_page=100&page="+l,null,"GET"),this.executeRequest(e,mxUtils.bind(this,function(e){var t=JSON.parse(e.getText());if(null!=t&&0!=t.length||null!=n&&0!=n.length){1==l&&(g.appendChild(b(mxResources.get("enterValue")+"...",mxUtils.bind(this,function(){var e;0===o&&(e=new FilenameDialog(this.ui,"org/repo/ref",mxResources.get("ok"),mxUtils.bind(this,function(e){null!=e&&(1<(e=e.split("/")).length?(d=e[0],h=e[1],m=p=null,2<e.length?(m=encodeURIComponent(e.slice(2,e.length).join("/")),C()):w(null,!0)):(this.ui.spinner.stop(),this.ui.handleError({message:mxResources.get("invalidName")})))}),mxResources.get("enterValue")),this.ui.showDialog(e.container,300,80,!0,!1),e.init())}))),mxUtils.br(g),mxUtils.br(g));for(var s=!0,i=0;i<t.length;i++)mxUtils.bind(this,function(e){var t=x.cloneNode();t.style.backgroundColor=s?Editor.isDarkMode()?"#000000":"#eeeeee":"",s=!s,t.appendChild(b(e.name_with_namespace,mxUtils.bind(this,function(){0===o&&(d=e.owner.username,h=e.path,w(null,!(p="")))}))),g.appendChild(t)})(t[i]);for(i=0;i<n.length;i++)r(),c(n[i],mxUtils.bind(this,function(t,e){a();for(var i=0;i<e.length;i++){var n=x.cloneNode();n.style.backgroundColor=s?"dark"==uiTheme?"#000000":"#eeeeee":"",s=!s,mxUtils.bind(this,function(e){n.appendChild(b(e.name_with_namespace,mxUtils.bind(this,function(){0===o&&(d=t.full_path,h=e.path,w(null,!(p="")))}))),g.appendChild(n)})(e[i])}}));a()}else a(),mxUtils.write(g,mxResources.get("noFiles"));100==t.length&&(g.appendChild(U),R=function(){g.scrollTop>=g.scrollHeight-g.offsetHeight&&u()},mxEvent.addListener(g,"scroll",R))}),f))}))});y?this.user?v():this.updateUser(function(){v()},f,!0):this.authenticate(mxUtils.bind(this,function(){this.updateUser(function(){v()},f,!0)}),f)},GitLabClient.prototype.logout=function(){this.ui.editor.loadUrl(this.redirectUri+"?doLogout=1&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname)),this.clearPersistentToken(),this.setUser(null),y=null,this.setToken(null)}}();