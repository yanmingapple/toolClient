!function(){var c=null;window.NotionClient=function(t){DrawioClient.call(this,t,"notionAuthInfo")},mxUtils.extend(NotionClient,DrawioClient),NotionClient.prototype.extension=".drawio",NotionClient.prototype.xmlField="draw.io XML",NotionClient.prototype.baseUrl=window.NOTION_API_URL||"https://app.diagrams.net/notion-api",NotionClient.prototype.getTitle=function(t){var e,i,n;for(n in t)if("title"==t[n].type){e=t[i=n];break}return{title:this.getTitleVal(e),key:i}},NotionClient.prototype.getTitleVal=function(t){if("string"==typeof t.title)return t.title;for(var e=[],i=0;i<t.title.length;i++)e.push(t.title[i].text.content);return e.join(" ")},NotionClient.prototype.authenticate=function(n,t,o){var s=!0,l=mxUtils.bind(this,function(){s&&(s=!1,t({message:mxResources.get("accessDenied"),retry:mxUtils.bind(this,function(){this.ui.hideDialog(),e()})}))}),e=mxUtils.bind(this,function(){s=!0,this.ui.showAuthDialog(this,!0,mxUtils.bind(this,function(e,i){var t=new FilenameDialog(this.ui,"",mxResources.get("ok"),mxUtils.bind(this,function(t){c=t,this.executeRequest("/v1/databases",null,"GET",mxUtils.bind(this,function(){this.executeRequest("/setToken",null,"GET",mxUtils.bind(this,function(){s=!1,e&&(c=null),null!=i&&i(),n()}),l,o)}),l,o)}),mxResources.get("notionToken"),function(t){return null!=t&&0<t.length},null,"https://developers.notion.com/docs/getting-started#step-1-create-an-integration");this.ui.showDialog(t.container,300,80,!0,!0),t.init()}),l)});e()},NotionClient.prototype.executeRequest=function(n,o,s,l,r,u){var a=mxUtils.bind(this,function(){var e=!0,i=window.setTimeout(mxUtils.bind(this,function(){e=!1,r({code:App.ERROR_TIMEOUT,retry:a})}),this.ui.timeout),t=new mxXmlRequest(this.baseUrl+n,o,s);t.withCredentials=!0,t.setRequestHeaders=mxUtils.bind(this,function(t,e){null!=c&&t.setRequestHeader("Authorization","Bearer "+c),t.setRequestHeader("Notion-Version","2021-05-13"),t.setRequestHeader("Content-Type","application/json")}),t.send(mxUtils.bind(this,function(t){window.clearTimeout(i),e&&(200<=t.getStatus()&&t.getStatus()<=299?(null==this.user&&this.setUser(new DrawioUser("notion",null,"Notion")),l(JSON.parse(t.getText()))):u||401!==t.getStatus()&&400!==t.getStatus()?r(this.parseRequestText(t)):(this.setUser(null),u=!0,this.authenticate(function(){a()},r,u)))}),mxUtils.bind(this,function(t){window.clearTimeout(i),e&&r(t)}))});a()},NotionClient.prototype.getLibrary=function(t,e,i){this.getFile(t,e,i,!1,!0)},NotionClient.prototype.getFile=function(l,r,u,t,a){a=null!=a&&a,this.executeRequest("/v1/pages/"+encodeURIComponent(l),null,"GET",mxUtils.bind(this,function(t){try{for(var e=t.properties[this.xmlField].rich_text,i="",n=this.getTitle(t.properties),o=0;o<e.length;o++)i+=e[o].text.content;var s={id:l,name:n.title,nameField:n.key};r(new(a?NotionLibrary:NotionFile)(this.ui,i,s))}catch(t){if(null==u)throw t;u(t)}}),u)},NotionClient.prototype.insertLibrary=function(t,e,i,n,o){this.insertFile(t,e,i,n,!0,o)},NotionClient.prototype.insertFile=function(i,n,o,s,l,t){var r,u;l=null!=l&&l;var e=mxUtils.bind(this,function(){this.checkExists(r,i,u,!0,mxUtils.bind(this,function(t,e){t?this.writeFile(e?"/v1/pages/"+encodeURIComponent(e):"/v1/pages",e?null:r,i,u,n,e?"PATCH":"POST",mxUtils.bind(this,function(t){var e=this.getTitle(t.properties),e={id:t.id,name:e.title,nameField:e.key};o(new(l?NotionLibrary:NotionFile)(this.ui,n,e))}),s):s()}))});"object"==typeof t?(u=this.getTitle(t.schema.properties).key,r=t.id,t.drawioReady?e():(t.schema.properties[this.xmlField]={name:this.xmlField,type:"rich_text",rich_text:{}},this.executeRequest("/v1/databases/"+encodeURIComponent(t.id),JSON.stringify({title:t.schema.title,properties:t.schema.properties}),"PATCH",e,s))):s()},NotionClient.prototype.checkExists=function(t,e,i,n,o){this.executeRequest("/v1/databases/"+encodeURIComponent(t)+"/query",JSON.stringify({filter:{property:i,text:{equals:e}}}),"POST",mxUtils.bind(this,function(t){0==t.results.length?o(!0):n?(this.ui.spinner.stop(),this.ui.confirm(mxResources.get("replaceIt",[e]),function(){o(!0,t.results[0].id)},function(){o(!1)})):(this.ui.spinner.stop(),this.ui.showError(mxResources.get("error"),mxResources.get("fileExists"),mxResources.get("ok"),function(){o(!1)}))}),function(t){o(!1)})},NotionClient.prototype.saveFile=function(t,e,i){try{var n=t.getData();this.writeFile("/v1/pages/"+t.getId(),null,t.getTitle(),t.getNameField(),n,"PATCH",mxUtils.bind(this,function(t){e(t,n)}),i)}catch(t){i(t)}},NotionClient.prototype.writeFile=function(t,e,i,n,o,s,l,r){try{if(null!=t&&null!=o){if(2e5<o.length)return void r({message:mxResources.get("drawingTooLarge")+" ("+this.ui.formatFileSize(o.length)+" / 200 KB)"});for(var u=[],a=Math.ceil(o.length/2e3),c=0;c<a;c++)u.push({text:{content:o.substr(2e3*c,2e3)}});var d={properties:{}};d.properties[n]={title:[{text:{content:i}}]},d.properties[this.xmlField]={rich_text:u},e&&(d.parent={database_id:e}),this.executeRequest(t,JSON.stringify(d),s,l,r)}else r({message:mxResources.get("unknownError")})}catch(t){r(t)}},NotionClient.prototype.parseRequestText=function(t){var e={message:mxResources.get("unknownError")};try{e=JSON.parse(t.getText())}catch(t){}return e},NotionClient.prototype.pickLibrary=function(t){this.pickFile(t)},NotionClient.prototype.pickFolder=function(t){this.showNotionDialog(!1,t)},NotionClient.prototype.pickFile=function(t){t=null!=t?t:mxUtils.bind(this,function(t){this.ui.loadFile("N"+encodeURIComponent(t))}),this.showNotionDialog(!0,t)},NotionClient.prototype.showNotionDialog=function(r,u){var a,c,t=document.createElement("div");t.style.whiteSpace="nowrap",t.style.overflow="hidden",t.style.height="304px";var e=document.createElement("h3");mxUtils.write(e,mxResources.get(r?"officeSelDiag":"selectDB")),e.style.cssText="width:100%;text-align:center;margin-top:0px;margin-bottom:12px",t.appendChild(e);var d=document.createElement("div");d.style.whiteSpace="nowrap",d.style.border="1px solid lightgray",d.style.boxSizing="border-box",d.style.padding="4px",d.style.overflow="auto",d.style.lineHeight="1.2em",d.style.height="274px",t.appendChild(d);var h=document.createElement("div");h.style.textOverflow="ellipsis",h.style.boxSizing="border-box",h.style.overflow="hidden",h.style.padding="4px",h.style.width="100%";var i=new CustomDialog(this.ui,t,mxUtils.bind(this,function(){u(a)}));this.ui.showDialog(i.container,420,380,!0,!0),r&&i.okButton.parentNode.removeChild(i.okButton);var p=mxUtils.bind(this,function(t,e,i,n){var o=document.createElement("a");return o.setAttribute("title",t),o.style.cursor="pointer",mxUtils.write(o,t),mxEvent.addListener(o,"click",e),n&&(o.style.textDecoration="underline"),null!=i&&((n=h.cloneNode()).style.padding=i,n.appendChild(o),o=n),o}),l=mxUtils.bind(this,function(){var t=document.createElement("div");t.style.marginBottom="8px",t.appendChild(p(c,mxUtils.bind(this,function(){a=null,f()}),null,!0)),d.appendChild(t)}),o=mxUtils.bind(this,function(t){this.ui.handleError(t,null,mxUtils.bind(this,function(){this.ui.spinner.stop(),null!=this.getUser()?(a=null,f()):this.ui.hideDialog()}),null,{})}),m=null,x=null,g=mxUtils.bind(this,function(n){null==n&&(d.innerHTML=""),this.ui.spinner.spin(d,mxResources.get("loading")),i.okButton.removeAttribute("disabled"),null!=x&&(mxEvent.removeListener(d,"scroll",x),x=null),null!=m&&null!=m.parentNode&&m.parentNode.removeChild(m),(m=document.createElement("a")).style.display="block",m.style.cursor="pointer",mxUtils.write(m,mxResources.get("more")+"...");var s=mxUtils.bind(this,function(){g(n)});mxEvent.addListener(m,"click",s);var t={page_size:100};null!=n&&(t.start_cursor=n),this.executeRequest("/v1/databases/"+encodeURIComponent(a)+"/query",JSON.stringify(t),"POST",mxUtils.bind(this,function(t){this.ui.spinner.stop(),null==n&&(l(),d.appendChild(p("../ [Up]",mxUtils.bind(this,function(){a=null,f()}),"4px")));var e=t.results;if(null==e||0==e.length)mxUtils.write(d,mxResources.get("noFiles"));else{for(var o=!0,i=0;i<e.length;i++)mxUtils.bind(this,function(t,e){var i=h.cloneNode();i.style.backgroundColor=o?Editor.isDarkMode()?"#000000":"#eeeeee":"",o=!o;var n=document.createElement("img");n.src=IMAGE_PATH+"/file.png",n.setAttribute("align","absmiddle"),n.style.marginRight="4px",n.style.marginTop="-4px",n.width=20,i.appendChild(n),i.appendChild(p(this.getTitle(t.properties).title,mxUtils.bind(this,function(){this.ui.hideDialog(),u(t.id)}))),d.appendChild(i)})(e[i],i);t.has_more&&(n=t.next_cursor,d.appendChild(m),x=function(){d.scrollTop>=d.scrollHeight-d.offsetHeight&&s()},mxEvent.addListener(d,"scroll",x))}}),o,!0)}),f=mxUtils.bind(this,function(s){null==s&&(d.innerHTML=""),i.okButton.setAttribute("disabled","disabled"),this.ui.spinner.spin(d,mxResources.get("loading")),null!=x&&mxEvent.removeListener(d,"scroll",x),null!=m&&null!=m.parentNode&&m.parentNode.removeChild(m),(m=document.createElement("a")).style.display="block",m.style.cursor="pointer",mxUtils.write(m,mxResources.get("more")+"...");var l=mxUtils.bind(this,function(){f(s)});mxEvent.addListener(m,"click",l),this.executeRequest("/v1/databases?page_size=100"+(null!=s?"&start_cursor="+s:""),null,"GET",mxUtils.bind(this,function(t){this.ui.spinner.stop();var e=t.results,i=0;if(null==e||0==e.length)mxUtils.write(d,mxResources.get("noDBs"));else for(var n=0;n<e.length;n++){var o=e[n].properties[this.xmlField]&&"rich_text"==e[n].properties[this.xmlField].type;r&&!o||(mxUtils.bind(this,function(t,e,i){var n=h.cloneNode();n.style.backgroundColor=e%2==0?Editor.isDarkMode()?"#000000":"#eeeeee":"",n.appendChild(p(this.getTitleVal(t),mxUtils.bind(this,function(){a=t.id,c=this.getTitleVal(t),r?g():(this.ui.hideDialog(),u({id:a,drawioReady:i,schema:t}))}))),d.appendChild(n)})(e[n],n,o),i++)}t.has_more?(s=t.next_cursor,0!=i?(d.appendChild(m),x=function(){d.scrollTop>=d.scrollHeight-d.offsetHeight&&l()},mxEvent.addListener(d,"scroll",x)):l()):0==i&&""==d.innerHTML&&mxUtils.write(d,mxResources.get("noDBs"))}),o)});f()},NotionClient.prototype.logout=function(){this.executeRequest("/removeToken",null,"GET",function(){},function(){}),this.setUser(null),c=null}}();