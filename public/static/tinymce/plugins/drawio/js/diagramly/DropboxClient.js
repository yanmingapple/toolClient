!function(){var a=null;window.DropboxClient=function(t){DrawioClient.call(this,t,"dbauth"),this.client=new Dropbox({clientId:this.clientId})},mxUtils.extend(DropboxClient,DrawioClient),DropboxClient.prototype.appPath="/drawio/",DropboxClient.prototype.extension=".drawio",DropboxClient.prototype.writingFile=!1,DropboxClient.prototype.maxRetries=4,DropboxClient.prototype.clientId=window.DRAWIO_DROPBOX_ID,DropboxClient.prototype.redirectUri=window.location.protocol+"//"+window.location.host+"/dropbox",DropboxClient.prototype.logout=function(){this.ui.editor.loadUrl(this.redirectUri+"?doLogout=1&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname)),this.clearPersistentToken(),this.setUser(null),a=null,this.client.authTokenRevoke().then(mxUtils.bind(this,function(){this.client.setAccessToken(null)}))},DropboxClient.prototype.updateUser=function(i,e,n){var s=!0,o=window.setTimeout(mxUtils.bind(this,function(){s=!1,e({code:App.ERROR_TIMEOUT})}),this.ui.timeout),t=this.client.usersGetCurrentAccount();t.then(mxUtils.bind(this,function(t){window.clearTimeout(o),s&&(this.setUser(new DrawioUser(t.account_id,t.email,t.name.display_name)),i())})),t.catch(mxUtils.bind(this,function(t){window.clearTimeout(o),s&&(null==t||401!==t.status||n?e({message:mxResources.get("accessDenied")}):(this.setUser(null),this.client.setAccessToken(null),a=null,this.authenticate(mxUtils.bind(this,function(){this.updateUser(i,e,!0)}),e)))}))},DropboxClient.prototype.authenticate=function(i,e){new mxXmlRequest(this.redirectUri+"?getState=1",null,"GET").send(mxUtils.bind(this,function(t){200<=t.getStatus()&&t.getStatus()<=299?this.authenticateStep2(t.getText(),i,e):null!=e&&e(t)}),e)},DropboxClient.prototype.authenticateStep2=function(t,o,l){var r;null==window.onDropboxCallback?(r=mxUtils.bind(this,function(){var s=!0;null!=this.getPersistentToken(!0)?new mxXmlRequest(this.redirectUri+"?state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+t),null,"GET").send(mxUtils.bind(this,function(t){200<=t.getStatus()&&t.getStatus()<=299?(a=JSON.parse(t.getText()).access_token,this.client.setAccessToken(a),this.setUser(null),o()):(this.clearPersistentToken(),this.setUser(null),a=null,this.client.setAccessToken(null),401==t.getStatus()?r():l({message:mxResources.get("accessDenied"),retry:r}))}),l):this.ui.showAuthDialog(this,!0,mxUtils.bind(this,function(e,n){null!=window.open("https://www.dropbox.com/oauth2/authorize?client_id="+this.clientId+(e?"&token_access_type=offline":"")+"&redirect_uri="+encodeURIComponent(this.redirectUri)+"&response_type=code&state="+encodeURIComponent("cId="+this.clientId+"&domain="+window.location.hostname+"&token="+t),"dbauth")?window.onDropboxCallback=mxUtils.bind(this,function(t,i){if(s){window.onDropboxCallback=null,s=!1;try{null==t?l({message:mxResources.get("accessDenied"),retry:r}):(null!=n&&n(),a=t.access_token,this.client.setAccessToken(a),this.setUser(null),e&&this.setPersistentToken("remembered"),o())}catch(t){l(t)}finally{null!=i&&i.close()}}else null!=i&&i.close()}):l({message:mxResources.get("serviceUnavailableOrBlocked"),retry:r})}),mxUtils.bind(this,function(){s&&(window.onDropboxCallback=null,s=!1,l({message:mxResources.get("accessDenied"),retry:r}))}))}))():l({code:App.ERROR_BUSY})},DropboxClient.prototype.executePromise=function(s,o,l){var r=mxUtils.bind(this,function(i){var e=!0,n=window.setTimeout(mxUtils.bind(this,function(){e=!1,l({code:App.ERROR_TIMEOUT,retry:u})}),this.ui.timeout),t=s();t.then(mxUtils.bind(this,function(t){window.clearTimeout(n),e&&null!=o&&o(t)})),t.catch(mxUtils.bind(this,function(t){window.clearTimeout(n),e&&(null==t||500!=t.status&&400!=t.status&&401!=t.status?l({message:mxResources.get("error")+" "+t.status}):(this.setUser(null),this.client.setAccessToken(null),a=null,i?l({message:mxResources.get("accessDenied"),retry:mxUtils.bind(this,function(){this.authenticate(function(){u(!0)},l)})}):this.authenticate(function(){r(!0)},l)))}))}),u=mxUtils.bind(this,function(t){null==this.user?this.updateUser(function(){u(!0)},l,t):r(t)});null==a?this.authenticate(function(){u(!0)},l):u(!1)},DropboxClient.prototype.getLibrary=function(t,i,e){this.getFile(t,i,e,!0)},DropboxClient.prototype.getFile=function(s,o,i,l){l=null!=l&&l;var t,r=/\.png$/i.test(s);/^https:\/\//i.test(s)||/\.v(dx|sdx?)$/i.test(s)||/\.gliffy$/i.test(s)||/\.pdf$/i.test(s)||!this.ui.useCanvasForExport&&r?(t=mxUtils.bind(this,function(){var t=s.split("/"),t=0<t.length?t[t.length-1]:s;this.ui.convertFile(s,t,null,this.extension,o,i)}),null!=a?t():this.authenticate(t,i)):(t={path:"/"+s},null!=urlParams.rev&&(t.rev=urlParams.rev),this.readFile(t,mxUtils.bind(this,function(t,i){var e,n=null;0<(r?t.lastIndexOf(","):-1)&&(null!=(e=this.ui.extractGraphModelFromPng(t))&&0<e.length?t=e:n=new LocalFile(this,t,s,!0)),o(null!=n?n:new(l?DropboxLibrary:DropboxFile)(this.ui,t,i))}),i,r))},DropboxClient.prototype.readFile=function(e,o,l,r){var u=mxUtils.bind(this,function(i){var n=!0,s=window.setTimeout(mxUtils.bind(this,function(){n=!1,l({code:App.ERROR_TIMEOUT})}),this.ui.timeout),t=this.client.filesGetMetadata({path:"/"+e.path.substring(1),include_deleted:!1});t.then(mxUtils.bind(this,function(t){})),t.catch(function(t){window.clearTimeout(s),n&&null!=t&&409==t.status&&(n=!1,l({message:mxResources.get("fileNotFound")}))});t=this.client.filesDownload(e);t.then(mxUtils.bind(this,function(i){if(window.clearTimeout(s),n){n=!1;try{var e=new FileReader;e.onload=mxUtils.bind(this,function(t){o(e.result,i)}),r?e.readAsDataURL(i.fileBlob):e.readAsText(i.fileBlob)}catch(t){l(t)}}})),t.catch(mxUtils.bind(this,function(t){window.clearTimeout(s),n&&(n=!1,null==t||500!=t.status&&400!=t.status&&401!=t.status?l({message:mxResources.get("error")+" "+t.status}):(this.client.setAccessToken(null),this.setUser(null),a=null,i?l({message:mxResources.get("accessDenied"),retry:mxUtils.bind(this,function(){this.authenticate(function(){c(!0)},l)})}):this.authenticate(function(){u(!0)},l)))}))}),c=mxUtils.bind(this,function(t){null==this.user?this.updateUser(function(){c(!0)},l,t):u(t)});null==a?this.authenticate(function(){c(!0)},l):c(!1)},DropboxClient.prototype.checkExists=function(i,e,n){var t=mxUtils.bind(this,function(){return this.client.filesGetMetadata({path:"/"+i.toLowerCase(),include_deleted:!1})});this.executePromise(t,mxUtils.bind(this,function(t){n?e(!1,!0,t):this.ui.confirm(mxResources.get("replaceIt",[i]),function(){e(!0,!0,t)},function(){e(!1,!0,t)})}),function(t){e(!0,!1)})},DropboxClient.prototype.renameFile=function(n,s,o,l){var t,i;/[\\\/:\?\*"\|]/.test(s)?l({message:mxResources.get("dropboxCharsNotAllowed")}):(null==n||null==s||0<(i=(t=n.stat.path_display.substring(1)).lastIndexOf("/"))&&(s=t.substring(0,i+1)+s),null!=n&&null!=s&&n.stat.path_lower.substring(1)!==s.toLowerCase()?this.checkExists(s,mxUtils.bind(this,function(t,i,e){t?(t=mxUtils.bind(this,function(t){var i=mxUtils.bind(this,function(){return this.client.filesMove({from_path:n.stat.path_display,to_path:"/"+s,autorename:!1})});this.executePromise(i,o,l)}),i&&e.path_lower.substring(1)!==s.toLowerCase()?(e=mxUtils.bind(this,function(){return this.client.filesDelete({path:"/"+s.toLowerCase()})}),this.executePromise(e,t,l)):t()):l()})):l({message:mxResources.get("invalidName")}))},DropboxClient.prototype.insertLibrary=function(t,i,e,n){this.insertFile(t,i,e,n,!0)},DropboxClient.prototype.insertFile=function(i,e,n,s,o){o=null!=o&&o,this.checkExists(i,mxUtils.bind(this,function(t){t?this.saveFile(i,e,mxUtils.bind(this,function(t){n(new(o?DropboxLibrary:DropboxFile)(this.ui,e,t))}),s):s()}))},DropboxClient.prototype.saveFile=function(t,i,e,n,s){var o;/[\\\/:\?\*"\|]/.test(t)?n({message:mxResources.get("dropboxCharsNotAllowed")}):15e7<=i.length?n({message:mxResources.get("drawingTooLarge")+" ("+this.ui.formatFileSize(i.length)+" / 150 MB)"}):(s=null!=s?s:"",o=mxUtils.bind(this,function(){return this.client.filesUpload({path:"/"+s+t,mode:{".tag":"overwrite"},mute:!0,contents:new Blob([i],{type:"text/plain"})})}),this.executePromise(o,e,n))},DropboxClient.prototype.pickLibrary=function(o){Dropbox.choose({linkType:"direct",cancel:mxUtils.bind(this,function(){}),success:mxUtils.bind(this,function(e){var n,t,s;this.ui.spinner.spin(document.body,mxResources.get("loading"))&&(n=mxUtils.bind(this,function(t){this.ui.spinner.stop(),this.ui.handleError(t)}),0<(t=e[0].link.indexOf(this.appPath))?(s=decodeURIComponent(e[0].link.substring(t+this.appPath.length-1)),this.readFile({path:s},mxUtils.bind(this,function(t,i){if(null!=i&&i.id==e[0].id)try{this.ui.spinner.stop(),o(s.substring(1),new DropboxLibrary(this.ui,t,i))}catch(t){this.ui.handleError(t)}else this.createLibrary(e[0],o,n)}),n)):this.createLibrary(e[0],o,n))})})},DropboxClient.prototype.createLibrary=function(i,e,n){this.ui.confirm(mxResources.get("note")+": "+mxResources.get("fileWillBeSavedInAppFolder",[i.name]),mxUtils.bind(this,function(){this.ui.editor.loadUrl(i.link,mxUtils.bind(this,function(t){this.insertFile(i.name,t,mxUtils.bind(this,function(t){try{this.ui.spinner.stop(),e(t.getHash().substring(1),t)}catch(t){n(t)}}),n,!0)}),n)}),mxUtils.bind(this,function(){this.ui.spinner.stop()}))},DropboxClient.prototype.pickFile=function(c,i){null!=Dropbox.choose?(c=null!=c?c:mxUtils.bind(this,function(t,i){this.ui.loadFile(null!=t?"D"+encodeURIComponent(t):i.getHash(),null,i)}),Dropbox.choose({linkType:"direct",cancel:mxUtils.bind(this,function(){}),success:mxUtils.bind(this,function(s){var o,l,r,t,u;this.ui.spinner.spin(document.body,mxResources.get("loading"))&&(i?(this.ui.spinner.stop(),c(s[0].link)):(o=mxUtils.bind(this,function(t){this.ui.spinner.stop(),this.ui.handleError(t)}),l=mxUtils.bind(this,function(t,i){this.ui.spinner.stop(),c(t,i)}),r=/\.png$/i.test(s[0].name),/\.vsdx$/i.test(s[0].name)||/\.gliffy$/i.test(s[0].name)||!this.ui.useCanvasForExport&&r?l(s[0].link):0<(t=s[0].link.indexOf(this.appPath))?(u=decodeURIComponent(s[0].link.substring(t+this.appPath.length-1)),this.readFile({path:u},mxUtils.bind(this,function(t,i){var e,n;null!=i&&i.id==s[0].id?(n=r?t.lastIndexOf(","):-1,this.ui.spinner.stop(),e=null,0<n&&(null!=(n=this.ui.extractGraphModelFromPng(t))&&0<n.length?t=n:e=new LocalFile(this,t,u,!0)),c(u.substring(1),null!=e?e:new DropboxFile(this.ui,t,i))):this.createFile(s[0],l,o)}),o,r)):this.createFile(s[0],l,o)))})})):this.ui.handleError({message:mxResources.get("serviceUnavailableOrBlocked")})},DropboxClient.prototype.createFile=function(e,n,s){var o=/(\.png)$/i.test(e.name);this.ui.editor.loadUrl(e.link,mxUtils.bind(this,function(i){null!=i&&0<i.length?this.ui.confirm(mxResources.get("note")+": "+mxResources.get("fileWillBeSavedInAppFolder",[e.name]),mxUtils.bind(this,function(){var t=o?i.lastIndexOf(","):-1;0<t&&(null!=(t=this.ui.extractGraphModelFromPng(i.substring(t+1)))&&0<t.length&&(i=t)),this.insertFile(e.name,i,mxUtils.bind(this,function(t){n(e.name,t)}),s)}),mxUtils.bind(this,function(){this.ui.spinner.stop()})):(this.ui.spinner.stop(),s({message:mxResources.get("errorLoadingFile")}))}),s,o)}}();