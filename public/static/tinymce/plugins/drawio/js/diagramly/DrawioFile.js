DrawioFile=function(t,e){mxEventSource.call(this),this.ui=t,this.data=e||"",this.shadowData=this.data,this.shadowPages=null,this.created=(new Date).getTime(),this.stats={opened:0,merged:0,fileMerged:0,fileReloaded:0,conflicts:0,timeouts:0,saved:0,closed:0,destroyed:0,joined:0,checksumErrors:0,bytesSent:0,bytesReceived:0,msgSent:0,msgReceived:0,cacheHits:0,cacheMiss:0,cacheFail:0}},DrawioFile.SYNC=urlParams.sync||"auto",DrawioFile.LAST_WRITE_WINS=!0,mxUtils.extend(DrawioFile,mxEventSource),DrawioFile.prototype.allChangesSavedKey="allChangesSaved",DrawioFile.prototype.savingSpinnerKey="saving",DrawioFile.prototype.savingStatusKey="saving",DrawioFile.prototype.autosaveDelay=1500,DrawioFile.prototype.maxAutosaveDelay=3e4,DrawioFile.prototype.optimisticSyncDelay=300,DrawioFile.prototype.autosaveThread=null,DrawioFile.prototype.lastAutosave=null,DrawioFile.prototype.lastSaved=null,DrawioFile.prototype.lastChanged=null,DrawioFile.prototype.opened=null,DrawioFile.prototype.modified=!1,DrawioFile.prototype.shadowModified=!1,DrawioFile.prototype.data=null,DrawioFile.prototype.shadowData=null,DrawioFile.prototype.shadowPages=null,DrawioFile.prototype.changeListenerEnabled=!0,DrawioFile.prototype.lastAutosaveRevision=null,DrawioFile.prototype.maxAutosaveRevisionDelay=3e5,DrawioFile.prototype.inConflictState=!1,DrawioFile.prototype.invalidChecksum=!1,DrawioFile.prototype.errorReportsEnabled=!1,DrawioFile.prototype.ageStart=null,DrawioFile.prototype.getSize=function(){return null!=this.data?this.data.length:0},DrawioFile.prototype.synchronizeFile=function(t,e){this.savingFile?null!=e&&e({message:mxResources.get("busy")}):null!=this.sync?this.sync.fileChanged(t,e):this.updateFile(t,e)},DrawioFile.prototype.updateFile=function(e,i,s,n){null!=s&&s()||(this.ui.getCurrentFile()!=this||this.invalidChecksum?null!=i&&i():this.getLatestVersion(mxUtils.bind(this,function(t){try{null!=s&&s()||(this.ui.getCurrentFile()!=this||this.invalidChecksum?null!=i&&i():null!=t?this.mergeFile(t,e,i,n):this.reloadFile(e,i))}catch(t){null!=i&&i(t)}}),i))},DrawioFile.prototype.mergeFile=function(t,e,i,s){var n,o,r=!0;try{this.stats.fileMerged++;var a=null!=this.shadowPages?this.shadowPages:this.ui.getPagesForNode(mxUtils.parseXml(this.shadowData).documentElement),l=this.ui.getPagesForNode(mxUtils.parseXml(t.data).documentElement);if(!(null!=l&&0<l.length))throw r=!1,new Error(mxResources.get("notADiagramFile"));this.shadowPages=l,this.backupPatch=this.isModified()?this.ui.diffPages(a,this.ui.pages):null;var h=[this.ui.diffPages(null!=s?s:a,this.shadowPages)];if(!this.ignorePatches(h)){var u=this.ui.patchPages(a,h[0]),d={},c=this.ui.getHashValueForPages(u,d),g={},p=this.ui.getHashValueForPages(this.shadowPages,g);if("1"==urlParams.test&&EditorUi.debug("File.mergeFile",[this],"backup",this.backupPatch,"patches",h,"checksum",p==c,c),null!=c&&c!=p){var m=this.compressReportData(this.getAnonymizedXmlForPages(l)),f=this.compressReportData(this.getAnonymizedXmlForPages(u)),y=this.ui.hashValue(t.getCurrentEtag()),w=this.ui.hashValue(this.getCurrentEtag());return void this.checksumError(i,h,"Shadow Details: "+JSON.stringify(d)+"\nChecksum: "+c+"\nCurrent: "+p+"\nCurrent Details: "+JSON.stringify(g)+"\nFrom: "+y+"\nTo: "+w+"\n\nFile Data:\n"+m+"\nPatched Shadow:\n"+f,null,"mergeFile")}this.patch(h,DrawioFile.LAST_WRITE_WINS?this.backupPatch:null)}this.invalidChecksum=!1,this.inConflictState=!1,this.setDescriptor(t.getDescriptor()),this.descriptorChanged(),(this.backupPatch=null)!=e&&e()}catch(t){this.inConflictState=!0,this.invalidChecksum=!0,this.descriptorChanged(),null!=i&&i(t);try{r&&(this.errorReportsEnabled?this.sendErrorReport("Error in mergeFile",null,t):(o=null!=(n=this.getCurrentUser())?n.id:"unknown",EditorUi.logError("Error in mergeFile",null,this.getMode()+"."+this.getId(),o,t)))}catch(t){}}},DrawioFile.prototype.getAnonymizedXmlForPages=function(t){var e=new mxCodec(mxUtils.createXmlDocument()),i=e.document.createElement("mxfile");if(null!=t)for(var s=0;s<t.length;s++){var n=e.encode(new mxGraphModel(t[s].root));(n="1"!=urlParams.dev?this.ui.anonymizeNode(n,!0):n).setAttribute("id",t[s].getId()),t[s].viewState&&this.ui.editor.graph.saveViewState(t[s].viewState,n,!0),i.appendChild(n)}return mxUtils.getPrettyXml(i)},DrawioFile.prototype.compressReportData=function(t,e,i){return e=null!=e?e:1e4,null!=i&&null!=t&&t.length>i?t=t.substring(0,i)+"[...]":null!=t&&t.length>e&&(t=Graph.compress(t)+"\n"),t},DrawioFile.prototype.checksumError=function(t,i,s,e,n){this.stats.checksumErrors++,this.inConflictState=!0,this.invalidChecksum=!0,this.descriptorChanged(),null!=this.sync&&this.sync.updateOnlineState(),null!=t&&t();try{if(this.errorReportsEnabled){if(null!=i)for(var o=0;o<i.length;o++)this.ui.anonymizePatch(i[o]);var r=mxUtils.bind(this,function(t){var e=this.compressReportData(JSON.stringify(i,null,2)),t=null!=t?this.compressReportData(this.getAnonymizedXmlForPages(this.ui.getPagesForNode(mxUtils.parseXml(t.data).documentElement)),25e3):"n/a";this.sendErrorReport("Checksum Error in "+n+" "+this.getHash(),(null!=s?s:"")+"\n\nPatches:\n"+e+(null!=t?"\n\nRemote:\n"+t:""),null,7e4)});null==e?r(null):this.getLatestVersion(mxUtils.bind(this,function(t){null!=t&&t.getCurrentEtag()==e?r(t):r(null)}),function(){})}else{var a=this.getCurrentUser(),l=null!=a?a.id:"unknown";EditorUi.logError("Checksum Error in "+n+" "+this.getId(),null,this.getMode()+"."+this.getId(),"user_"+l+(null!=this.sync?"-client_"+this.sync.clientId:"-nosync"));try{EditorUi.logEvent({category:"CHECKSUM-ERROR-SYNC-FILE-"+this.getHash(),action:n,label:"user_"+l+(null!=this.sync?"-client_"+this.sync.clientId:"-nosync")})}catch(t){}}}catch(t){}},DrawioFile.prototype.sendErrorReport=function(t,e,i,s){try{var n=this.compressReportData(this.getAnonymizedXmlForPages(this.shadowPages),25e3),o=this.compressReportData(this.getAnonymizedXmlForPages(this.ui.pages),25e3),r=this.getCurrentUser(),a=null!=r?this.ui.hashValue(r.id):"unknown",l=null!=this.sync?"-client_"+this.sync.clientId:"-nosync",h=this.getTitle(),u=h.lastIndexOf("."),d="xml";0<u&&(d=h.substring(u));var c=(null!=i?i:new Error).stack;EditorUi.sendReport(t+" "+(new Date).toISOString()+":\n\nAppVersion="+navigator.appVersion+"\nFile="+this.ui.hashValue(this.getId())+" ("+this.getMode()+")"+(this.isModified()?" modified":"")+"\nSize/Type="+this.getSize()+" ("+d+")\nUser="+a+l+"\nPrefix="+this.ui.editor.graph.model.prefix+"\nSync="+DrawioFile.SYNC+(null!=this.sync?(this.sync.enabled?" enabled":"")+(this.sync.isConnected()?" connected":""):"")+"\nPlugins="+(null!=mxSettings.settings?mxSettings.getPlugins():"null")+"\n\nStats:\n"+JSON.stringify(this.stats,null,2)+(null!=e?"\n\n"+e:"")+(null!=i?"\n\nError: "+i.message:"")+"\n\nStack:\n"+c+"\n\nShadow:\n"+n+"\n\nData:\n"+o,s)}catch(t){}},DrawioFile.prototype.reloadFile=function(n,e){try{this.ui.spinner.stop();var t=mxUtils.bind(this,function(){this.stats.fileReloaded++;var e=this.ui.editor.graph.getViewState(),i=this.ui.editor.graph.getSelectionCells(),s=this.ui.currentPage;this.ui.loadFile(this.getHash(),!0,null,mxUtils.bind(this,function(){var t;null==this.ui.fileLoadedError&&(this.ui.restoreViewState(s,e,i),null!=this.backupPatch&&this.patch([this.backupPatch]),null!=(t=this.ui.getCurrentFile())&&(t.stats=this.stats),null!=n&&n())}),!0)});this.isModified()&&null==this.backupPatch?this.ui.confirm(mxResources.get("allChangesLost"),mxUtils.bind(this,function(){this.handleFileSuccess("manual"==DrawioFile.SYNC)}),t,mxResources.get("cancel"),mxResources.get("discardChanges")):t()}catch(t){null!=e&&e(t)}},DrawioFile.prototype.copyFile=function(t,e){this.ui.editor.editAsNew(this.ui.getFileData(!0),this.ui.getCopyFilename(this))},DrawioFile.prototype.ignorePatches=function(t){for(var e=!0,i=0;i<t.length&&e;i++)e=e&&0==Object.keys(t[i]).length;return e},DrawioFile.prototype.patch=function(t,e,i){var s=this.ui.editor.undoManager,n=s.history.slice(),o=s.indexOfNextAdd,r=this.ui.editor.graph;r.container.style.visibility="hidden";var a=this.changeListenerEnabled;this.changeListenerEnabled=i;var l=r.foldingEnabled,h=r.mathEnabled,u=r.cellRenderer.redraw;r.cellRenderer.redraw=function(t){t.view.graph.isEditing(t.cell)&&(t.view.graph.scrollCellToVisible(t.cell),t.view.graph.cellEditor.resize()),u.apply(this,arguments)},r.model.beginUpdate();try{for(var d=0;d<t.length;d++)this.ui.pages=this.ui.patchPages(this.ui.pages,t[d],!0,e,this.isModified());0==this.ui.pages.length&&this.ui.pages.push(this.ui.createPage()),mxUtils.indexOf(this.ui.pages,this.ui.currentPage)<0&&this.ui.selectPage(this.ui.pages[0],!0)}finally{r.container.style.visibility="",r.model.endUpdate(),r.cellRenderer.redraw=u,this.changeListenerEnabled=a,i||(s.history=n,s.indexOfNextAdd=o,s.fireEvent(new mxEventObject(mxEvent.CLEAR))),null!=this.ui.currentPage&&!this.ui.currentPage.needsUpdate||(h!=r.mathEnabled?(this.ui.editor.updateGraphComponents(),r.refresh()):(l!=r.foldingEnabled?r.view.revalidate():r.view.validate(),r.sizeDidChange())),this.ui.updateTabContainer(),this.ui.editor.fireEvent(new mxEventObject("pagesPatched","patches",t))}},DrawioFile.prototype.save=function(t,e,i,s,n,o){try{if(this.isEditable())if(!n&&this.invalidChecksum){if(null==i)throw new Error(mxResources.get("checksum"));i({message:mxResources.get("checksum")})}else this.updateFileData(),this.clearAutosave(),null!=e&&e();else{if(null==i)throw new Error(mxResources.get("readOnly"));i({message:mxResources.get("readOnly")})}}catch(t){if(null==i)throw t;i(t)}},DrawioFile.prototype.updateFileData=function(){this.setData(this.ui.getFileData(null,null,null,null,null,null,null,null,this,!this.isCompressed()))},DrawioFile.prototype.isCompressedStorage=function(){return!0},DrawioFile.prototype.isCompressed=function(){var t=null!=this.ui.fileNode?this.ui.fileNode.getAttribute("compressed"):null;return null!=t?"false"!=t:this.isCompressedStorage()&&Editor.compressXml},DrawioFile.prototype.saveAs=function(t,e,i){},DrawioFile.prototype.saveFile=function(t,e,i,s){},DrawioFile.prototype.getPublicUrl=function(t){t(null)},DrawioFile.prototype.isRestricted=function(){return!1},DrawioFile.prototype.isModified=function(){return this.modified},DrawioFile.prototype.getShadowModified=function(){return this.shadowModified},DrawioFile.prototype.setShadowModified=function(t){this.shadowModified=t},DrawioFile.prototype.setModified=function(t){console.log("DrawioFile.setModified():"+t),this.modified=t,this.shadowModified=t},DrawioFile.prototype.isAutosaveOptional=function(){return!1},DrawioFile.prototype.isAutosave=function(){return!this.inConflictState&&this.ui.editor.autosave},DrawioFile.prototype.isRenamable=function(){return!1},DrawioFile.prototype.rename=function(t,e,i){},DrawioFile.prototype.isMovable=function(){return!1},DrawioFile.prototype.isTrashed=function(){return!1},DrawioFile.prototype.move=function(t,e,i){},DrawioFile.prototype.share=function(){this.ui.alert(mxResources.get("sharingAvailable"),null,380)},DrawioFile.prototype.getHash=function(){return""},DrawioFile.prototype.getId=function(){return""},DrawioFile.prototype.isEditable=function(){return!this.ui.editor.isChromelessView()||this.ui.editor.editable},DrawioFile.prototype.getUi=function(){return this.ui},DrawioFile.prototype.getTitle=function(){return""},DrawioFile.prototype.setData=function(t){this.data=t},DrawioFile.prototype.getData=function(){return this.data},DrawioFile.prototype.open=function(){this.stats.opened++;var t=this.getData();function e(t){for(var e=0;null!=t&&e<t.length;e++){var i=t[e];null!=i.id&&0==i.id.indexOf("extFont_")&&i.parentNode.removeChild(i)}}null!=t&&(e(document.querySelectorAll("head > style[id]")),e(document.querySelectorAll("head > link[id]")),this.ui.setFileData(t),this.isModified()||(this.shadowData=mxUtils.getXml(this.ui.getXmlFileData()),this.shadowPages=null)),this.installListeners(),this.isSyncSupported()&&this.startSync()},DrawioFile.prototype.isSyncSupported=function(){return!1},DrawioFile.prototype.isRevisionHistorySupported=function(){return!1},DrawioFile.prototype.getRevisions=function(t,e){t(null)},DrawioFile.prototype.loadDescriptor=function(t,e){t(null)},DrawioFile.prototype.loadPatchDescriptor=function(e,t){this.loadDescriptor(mxUtils.bind(this,function(t){e(t)}),t)},DrawioFile.prototype.patchDescriptor=function(t,e){this.setDescriptorEtag(t,this.getDescriptorEtag(e)),this.descriptorChanged()},DrawioFile.prototype.startSync=function(){"auto"!=DrawioFile.SYNC||"1"==urlParams.stealth||"1"!=urlParams.rt&&this.ui.editor.chromeless&&!this.ui.editor.editable||(null==this.sync&&(this.sync=new DrawioFileSync(this)),this.sync.start())},DrawioFile.prototype.isConflict=function(){return!1},DrawioFile.prototype.getChannelId=function(){return Graph.compress(this.getHash()).replace(/[\/ +]/g,"_")},DrawioFile.prototype.getChannelKey=function(t){return null},DrawioFile.prototype.getCurrentUser=function(){return null},DrawioFile.prototype.getLatestVersion=function(t,e){t(null)},DrawioFile.prototype.getLastModifiedDate=function(){return new Date},DrawioFile.prototype.setCurrentRevisionId=function(t){this.setDescriptorRevisionId(this.getDescriptor(),t)},DrawioFile.prototype.getCurrentRevisionId=function(){return this.getDescriptorRevisionId(this.getDescriptor())},DrawioFile.prototype.setCurrentEtag=function(t){this.setDescriptorEtag(this.getDescriptor(),t)},DrawioFile.prototype.getCurrentEtag=function(){return this.getDescriptorEtag(this.getDescriptor())},DrawioFile.prototype.getDescriptor=function(){return null},DrawioFile.prototype.setDescriptor=function(){},DrawioFile.prototype.setDescriptorRevisionId=function(t,e){this.setDescriptorEtag(t,e)},DrawioFile.prototype.getDescriptorRevisionId=function(t){return this.getDescriptorEtag(t)},DrawioFile.prototype.setDescriptorEtag=function(t,e){},DrawioFile.prototype.getDescriptorEtag=function(t){return null},DrawioFile.prototype.getDescriptorSecret=function(t){return null},DrawioFile.prototype.installListeners=function(){console.log("DrawioFile-installListeners()"),null==this.changeListener&&(this.changeListener=mxUtils.bind(this,function(t,e){e=null!=e?e.getProperty("edit"):null;!this.changeListenerEnabled||!this.isEditable()||null!=e&&e.ignoreEdit||(console.log("DrawioFile-installListeners-changeListener(), changeListenerEnabled:"+this.changeListenerEnabled+", isEditable:"+this.isEditable()),this.fileChanged())}),this.ui.editor.graph.model.addListener(mxEvent.CHANGE,this.changeListener),this.ui.editor.graph.addListener("gridSizeChanged",this.changeListener),this.ui.editor.graph.addListener("shadowVisibleChanged",this.changeListener),this.ui.addListener("pageFormatChanged",this.changeListener),this.ui.addListener("pageScaleChanged",this.changeListener),this.ui.addListener("backgroundColorChanged",this.changeListener),this.ui.addListener("backgroundImageChanged",this.changeListener),this.ui.addListener("foldingEnabledChanged",this.changeListener),this.ui.addListener("mathEnabledChanged",this.changeListener),this.ui.addListener("gridEnabledChanged",this.changeListener),this.ui.addListener("guidesEnabledChanged",this.changeListener),this.ui.addListener("tooltipsEnabledChanged",this.changeListener),this.ui.addListener("pageViewChanged",this.changeListener),this.ui.addListener("connectionPointsChanged",this.changeListener),this.ui.addListener("connectionArrowsChanged",this.changeListener))},DrawioFile.prototype.addAllSavedStatus=function(t){null!=this.ui.statusContainer&&this.ui.getCurrentFile()==this&&(t=null!=t?t:mxUtils.htmlEntities(mxResources.get(this.allChangesSavedKey)),this.ui.editor.setStatus('<div title="'+t+'">'+t+"</div>",this.allChangesSavedKey),0<(t=this.ui.statusContainer.getElementsByTagName("div")).length&&this.isRevisionHistorySupported()&&(t[0].style.cursor="pointer",t[0].style.textDecoration="underline",mxEvent.addListener(t[0],"click",mxUtils.bind(this,function(){this.ui.actions.get("revisionHistory").funct()}))))},DrawioFile.prototype.saveDraft=function(){try{null==this.draftId&&(this.draftId=Editor.guid());var t={type:"draft",created:this.created,modified:(new Date).getTime(),data:this.ui.getFileData(),title:this.getTitle(),aliveCheck:this.ui.draftAliveCheck};this.ui.setDatabaseItem(".draft_"+this.draftId,JSON.stringify(t)),EditorUi.debug("draft saved",this.draftId,t)}catch(t){this.removeDraft()}},DrawioFile.prototype.removeDraft=function(){try{null!=this.draftId&&(this.ui.removeDatabaseItem(".draft_"+this.draftId),EditorUi.debug("draft deleted",".draft_"+this.draftId))}catch(t){}},DrawioFile.prototype.addUnsavedStatus=function(t){var e,i,s;console.log("DrawioFile-addUnsavedStatus()"),this.inConflictState||null==this.ui.statusContainer||this.ui.getCurrentFile()!=this||(t instanceof Error&&null!=t.message&&""!=t.message?(s=mxUtils.htmlEntities(mxResources.get("unsavedChanges")),this.ui.editor.setStatus('<div title="'+s+'" class="geStatusAlert">'+s+" ("+mxUtils.htmlEntities(t.message)+")</div>")):(null!=(i=this.getErrorMessage(t))||null==this.lastSaved||null!=(e=this.ui.timeSince(new Date(this.lastSaved)))&&(i=mxResources.get("lastSaved",[e])),null!=i&&60<i.length&&(i=i.substring(0,60)+"..."),i='<div title="'+(s=mxUtils.htmlEntities(mxResources.get("unsavedChangesClickHereToSave"))+(null!=i&&""!=i?" ("+mxUtils.htmlEntities(i)+")":""))+'" class="geStatusAlertOrange">'+s+' <img src="'+Editor.saveImage+'"/></div>',this.ui.editor.setStatus(i,"unsavedChangesClickHereToSave"),null!=(i=this.ui.statusContainer.getElementsByTagName("div"))&&0<i.length?(i[0].style.cursor="pointer",mxEvent.addListener(i[0],"click",mxUtils.bind(this,function(){this.ui.actions.get(null!=this.ui.mode&&this.isEditable()?"save":"saveAs").funct()}))):(s=mxUtils.htmlEntities(mxResources.get("unsavedChanges")),this.ui.editor.setStatus('<div title="'+s+'" class="geStatusAlert">'+s+" ("+mxUtils.htmlEntities(t.message)+")</div>")),EditorUi.enableDrafts&&(null==this.getMode()||EditorUi.isElectronApp)&&(null!=this.saveDraftThread&&window.clearTimeout(this.saveDraftThread),this.saveDraftThread=window.setTimeout(mxUtils.bind(this,function(){this.saveDraft()}),0))))},DrawioFile.prototype.addConflictStatus=function(e,t){this.invalidChecksum&&null==t&&(t=mxResources.get("checksum")),this.setConflictStatus(mxUtils.htmlEntities(mxResources.get("fileChangedSync"))+(null!=t&&""!=t?" ("+mxUtils.htmlEntities(t)+")":"")),this.ui.spinner.stop(),this.clearAutosave();t=null!=this.ui.statusContainer?this.ui.statusContainer.getElementsByTagName("div"):null;null!=t&&0<t.length?(t[0].style.cursor="pointer",mxEvent.addListener(t[0],"click",mxUtils.bind(this,function(t){"IMG"!=mxEvent.getSource(t).nodeName&&e()}))):this.ui.alert(mxUtils.htmlEntities(mxResources.get("fileChangedSync")),e)},DrawioFile.prototype.setConflictStatus=function(t){"1"!=urlParams.customMenu&&this.ui.editor.setStatus('<div title="'+t+'" class="geStatusAlert">'+t+' <a href="https://www.diagrams.net/doc/faq/synchronize" title="'+mxResources.get("help")+'" target="_blank"><img src="'+Editor.helpImage+'"/></a></div>')},DrawioFile.prototype.showRefreshDialog=function(t,e,i){null==i&&(i=mxResources.get("checksum")),this.ui.editor.isChromelessView()&&!this.ui.editor.editable?this.ui.alert(mxResources.get("fileChangedSync"),mxUtils.bind(this,function(){this.reloadFile(t,e)})):(this.addConflictStatus(mxUtils.bind(this,function(){this.showRefreshDialog(t,e)}),i),this.ui.showError(mxResources.get("error")+" ("+i+")",mxResources.get("fileChangedSyncDialog"),mxResources.get("makeCopy"),mxUtils.bind(this,function(){this.copyFile(t,e)}),null,mxResources.get("synchronize"),mxUtils.bind(this,function(){this.reloadFile(t,e)}),mxResources.get("cancel"),mxUtils.bind(this,function(){this.ui.hideDialog()}),360,150))},DrawioFile.prototype.showCopyDialog=function(t,e,i){this.inConflictState=!1,this.invalidChecksum=!1,this.addUnsavedStatus(),this.ui.showError(mxResources.get("externalChanges"),mxResources.get("fileChangedOverwriteDialog"),mxResources.get("makeCopy"),mxUtils.bind(this,function(){this.copyFile(t,e)}),null,mxResources.get("overwrite"),i,mxResources.get("cancel"),mxUtils.bind(this,function(){this.ui.hideDialog()}),360,150)},DrawioFile.prototype.showConflictDialog=function(t,e){this.ui.showError(mxResources.get("externalChanges"),mxResources.get("fileChangedSyncDialog"),mxResources.get("overwrite"),t,null,mxResources.get("synchronize"),e,mxResources.get("cancel"),mxUtils.bind(this,function(){this.ui.hideDialog(),this.handleFileError(null,!1)}),340,150)},DrawioFile.prototype.redirectToNewApp=function(e,t){var i,s;this.ui.spinner.stop(),this.redirectDialogShowing||(this.redirectDialogShowing=!0,i=window.location.protocol+"//"+window.location.host+"/"+this.ui.getSearch(["create","title","mode","url","drive","splash","state"])+"#"+this.getHash(),s=mxResources.get("redirectToNewApp"),null!=t&&(s+=" ("+t+")"),t=mxUtils.bind(this,function(){var t=mxUtils.bind(this,function(){this.redirectDialogShowing=!1,window.location.href==i?window.location.reload():window.location.href=i});null==e&&this.isModified()?this.ui.confirm(mxResources.get("allChangesLost"),mxUtils.bind(this,function(){this.redirectDialogShowing=!1}),t,mxResources.get("cancel"),mxResources.get("discardChanges")):t()}),null!=e?this.isModified()?this.ui.confirm(s,mxUtils.bind(this,function(){this.redirectDialogShowing=!1,e()}),t,mxResources.get("cancel"),mxResources.get("discardChanges")):this.ui.confirm(s,t,mxUtils.bind(this,function(){this.redirectDialogShowing=!1,e()})):this.ui.alert(mxResources.get("redirectToNewApp"),t))},DrawioFile.prototype.handleFileSuccess=function(t){this.ui.spinner.stop(),this.ui.getCurrentFile()==this&&(this.isModified()?this.fileChanged():t?(this.isTrashed()?this.addAllSavedStatus(mxUtils.htmlEntities(mxResources.get(this.allChangesSavedKey))+" ("+mxUtils.htmlEntities(mxResources.get("fileMovedToTrash"))+")"):this.addAllSavedStatus(),null!=this.sync&&(this.sync.resetUpdateStatusThread(),this.sync.remoteFileChanged&&(this.sync.remoteFileChanged=!1,this.sync.fileChangedNotify()))):this.ui.editor.setStatus(""))},DrawioFile.prototype.handleFileError=function(t,e){this.ui.spinner.stop(),this.ui.getCurrentFile()==this&&(this.inConflictState?this.handleConflictError(t,e):(this.isModified()&&this.addUnsavedStatus(t),e?this.ui.handleError(t,null!=t?mxResources.get("errorSavingFile"):null):this.isModified()||(null!=(t=this.getErrorMessage(t))&&60<t.length&&(t=t.substring(0,60)+"..."),this.ui.editor.setStatus('<div class="geStatusAlert">'+mxUtils.htmlEntities(mxResources.get("error"))+(null!=t?" ("+mxUtils.htmlEntities(t)+")":"")+"</div>"))))},DrawioFile.prototype.handleConflictError=function(e,t){var i=mxUtils.bind(this,function(){this.handleFileSuccess(!0)}),s=mxUtils.bind(this,function(t){this.handleFileError(t,!0)}),n=mxUtils.bind(this,function(){var t;this.ui.spinner.spin(document.body,mxResources.get(this.savingSpinnerKey))&&(this.ui.editor.setStatus(""),t=this.constructor==GitHubFile||this.constructor==GitLabFile,this.save(!0,i,s,null,!0,t&&null!=e?e.commitMessage:null))}),o=mxUtils.bind(this,function(){this.ui.spinner.spin(document.body,mxResources.get("updatingDocument"))&&this.synchronizeFile(mxUtils.bind(this,function(){var t;this.ui.spinner.stop(),this.ui.spinner.spin(document.body,mxResources.get(this.savingSpinnerKey))&&(t=this.constructor==GitHubFile||this.constructor==GitLabFile,this.save(!0,i,s,null,null,t&&null!=e?e.commitMessage:null))}),s)});"none"==DrawioFile.SYNC?this.showCopyDialog(i,s,n):this.invalidChecksum?this.showRefreshDialog(i,s,this.getErrorMessage(e)):t?this.showConflictDialog(n,o):this.addConflictStatus(mxUtils.bind(this,function(){this.ui.editor.setStatus(mxUtils.htmlEntities(mxResources.get("updatingDocument"))),this.synchronizeFile(i,s)}),this.getErrorMessage(e))},DrawioFile.prototype.getErrorMessage=function(t){var e=null!=t?(null!=t.error?t.error:t).message:null;return e=null==e&&null!=t&&t.code==App.ERROR_TIMEOUT?mxResources.get("timeout"):e},DrawioFile.prototype.isOverdue=function(){return null!=this.ageStart&&Date.now()-this.ageStart.getTime()>=this.ui.warnInterval},DrawioFile.prototype.fileChanged=function(){console.log("DrawioFile.fileChanged()"),this.lastChanged=new Date,this.setModified(!0),this.isAutosave()?(null!=this.savingStatusKey&&this.addAllSavedStatus(mxUtils.htmlEntities(mxResources.get(this.savingStatusKey))+"..."),this.ui.scheduleSanityCheck(),null==this.ageStart&&(this.ageStart=new Date),this.sendFileChanges(),this.autosave(this.autosaveDelay,this.maxAutosaveDelay,mxUtils.bind(this,function(t){this.ui.stopSanityCheck(),null==this.autosaveThread?(this.handleFileSuccess(!0),this.ageStart=null):this.isModified()&&(this.ui.scheduleSanityCheck(),this.ageStart=this.lastChanged)}),mxUtils.bind(this,function(t){this.handleFileError(t)}))):(this.ageStart=null,this.isAutosaveOptional()&&this.ui.editor.autosave||this.inConflictState||this.addUnsavedStatus())},DrawioFile.prototype.isOptimisticSync=function(){return!1},DrawioFile.prototype.createSecret=function(e){var i=Editor.guid(32);null==this.sync||this.isOptimisticSync()?e(i):this.sync.createToken(i,mxUtils.bind(this,function(t){e(i,t)}),mxUtils.bind(this,function(){e(i)}))},DrawioFile.prototype.fileSaving=function(){null!=this.sync&&this.isOptimisticSync()&&this.sync.fileSaving(),"1"==urlParams.test&&EditorUi.debug("DrawioFile.fileSaving",[this])},DrawioFile.prototype.sendFileChanges=function(){try{null!=this.p2pCollab&&null!=this.sync&&(this.updateFileData(),this.sync.sendFileChanges(this.ui.getPagesForNode(mxUtils.parseXml(this.getData()).documentElement),this.desc),"1"==urlParams.test&&EditorUi.debug("DrawioFile.sendFileChanges",[this]))}catch(t){console.log(t)}},DrawioFile.prototype.fileSaved=function(t,e,i,s,n){this.lastSaved=new Date,this.ageStart=null;try{this.stats.saved++,this.inConflictState=!1,this.invalidChecksum=!1,null==this.sync||this.isOptimisticSync()?(this.shadowData=t,(this.shadowPages=null)!=this.sync&&(this.sync.lastModified=this.getLastModifiedDate(),this.sync.resetUpdateStatusThread()),null!=i&&i()):this.sync.fileSaved(this.ui.getPagesForNode(mxUtils.parseXml(t).documentElement),e,i,s,n)}catch(t){this.inConflictState=!0,this.invalidChecksum=!0,this.descriptorChanged(),null!=s&&s(t);try{var o,r;this.errorReportsEnabled?this.sendErrorReport("Error in fileSaved",null,t):(r=null!=(o=this.getCurrentUser())?o.id:"unknown",EditorUi.logError("Error in fileSaved",null,this.getMode()+"."+this.getId(),r,t))}catch(t){}}"1"==urlParams.test&&EditorUi.debug("DrawioFile.fileSaved",[this])},DrawioFile.prototype.autosave=function(t,e,i,s){null==this.lastAutosave&&(this.lastAutosave=Date.now());t=Date.now()-this.lastAutosave<e?t:0;this.clearAutosave();var n=window.setTimeout(mxUtils.bind(this,function(){var t;this.lastAutosave=null,this.autosaveThread==n&&(this.autosaveThread=null),this.isModified()&&this.isAutosaveNow()?((t=this.isAutosaveRevision())&&(this.lastAutosaveRevision=(new Date).getTime()),this.save(t,mxUtils.bind(this,function(t){this.autosaveCompleted(),null!=i&&i(t)}),mxUtils.bind(this,function(t){null!=s&&s(t)}))):(this.isModified()||this.ui.editor.setStatus(""),null!=i&&i(null))}),t);this.autosaveThread=n},DrawioFile.prototype.isAutosaveNow=function(){return!0},DrawioFile.prototype.autosaveCompleted=function(){},DrawioFile.prototype.clearAutosave=function(){null!=this.autosaveThread&&(window.clearTimeout(this.autosaveThread),this.autosaveThread=null)},DrawioFile.prototype.isAutosaveRevision=function(){var t=(new Date).getTime();return null==this.lastAutosaveRevision||t-this.lastAutosaveRevision>this.maxAutosaveRevisionDelay},DrawioFile.prototype.descriptorChanged=function(){console.log("DrawioFile.descriptorChanged()"),this.fireEvent(new mxEventObject("descriptorChanged"))},DrawioFile.prototype.contentChanged=function(){console.log("DrawioFile.contentChanged()"),this.fireEvent(new mxEventObject("contentChanged"))},DrawioFile.prototype.close=function(t){this.updateFileData(),this.stats.closed++,this.isAutosave()&&this.isModified()&&this.save(this.isAutosaveRevision(),null,null,t),this.destroy()},DrawioFile.prototype.hasSameExtension=function(t,e){if(null==t||null==e)return t==e;var i=t.lastIndexOf(".");return(0<i?t.substring(i):"")===(0<(i=e.lastIndexOf("."))?e.substring(i):"")},DrawioFile.prototype.removeListeners=function(){null!=this.changeListener&&(this.ui.editor.graph.model.removeListener(this.changeListener),this.ui.editor.graph.removeListener(this.changeListener),this.ui.removeListener(this.changeListener),this.changeListener=null)},DrawioFile.prototype.destroy=function(){this.clearAutosave(),this.removeListeners(),this.stats.destroyed++,null!=this.sync&&(this.sync.destroy(),this.sync=null)},DrawioFile.prototype.commentsSupported=function(){return!1},DrawioFile.prototype.commentsRefreshNeeded=function(){return!0},DrawioFile.prototype.commentsSaveNeeded=function(){return!1},DrawioFile.prototype.getComments=function(t,e){t([])},DrawioFile.prototype.addComment=function(t,e,i){e(Date.now())},DrawioFile.prototype.canReplyToReplies=function(){return!0},DrawioFile.prototype.canComment=function(){return!0},DrawioFile.prototype.newComment=function(t,e){return new DrawioComment(this,null,t,Date.now(),Date.now(),!1,e)};