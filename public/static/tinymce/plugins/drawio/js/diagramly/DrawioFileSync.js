DrawioFileSync=function(t){mxEventSource.call(this),this.lastActivity=new Date,this.clientId=Editor.guid(),this.ui=t.ui,this.file=t,this.onlineListener=mxUtils.bind(this,function(){this.updateOnlineState(),this.isConnected()&&this.fileChangedNotify()}),mxEvent.addListener(window,"online",this.onlineListener),this.visibleListener=mxUtils.bind(this,function(){"hidden"==document.visibilityState?this.isConnected()&&this.stop():this.start()}),mxEvent.addListener(document,"visibilitychange",this.visibleListener),this.activityListener=mxUtils.bind(this,function(t){this.lastActivity=new Date,this.start()}),mxEvent.addListener(document,mxClient.IS_POINTER?"pointermove":"mousemove",this.activityListener),mxEvent.addListener(document,"keypress",this.activityListener),mxEvent.addListener(window,"focus",this.activityListener),!mxClient.IS_POINTER&&mxClient.IS_TOUCH&&(mxEvent.addListener(document,"touchstart",this.activityListener),mxEvent.addListener(document,"touchmove",this.activityListener)),this.pusherErrorListener=mxUtils.bind(this,function(t){null!=t.error&&null!=t.error.data&&4004===t.error.data.code&&EditorUi.logError("Error: Pusher Limit",null,this.file.getId())}),this.connectionListener=mxUtils.bind(this,function(){var t,e;this.updateOnlineState(),this.updateStatus(),this.isConnected()&&(this.announced?this.fileChangedNotify():(e={a:"join"},null!=(t=this.file.getCurrentUser())&&(e.name=encodeURIComponent(t.displayName),e.uid=t.id),mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&msg="+encodeURIComponent(this.objectToString(this.createMessage(e)))),this.file.stats.msgSent++,this.announced=!0))}),this.changeListener=mxUtils.bind(this,function(t){if(this.file.stats.msgReceived++,this.lastActivity=new Date,this.enabled&&!this.file.inConflictState&&!this.file.redirectDialogShowing)try{var e=this.stringToObject(t);null!=e&&(EditorUi.debug("Sync.message",[this],e,t.length,"bytes"),e.v>DrawioFileSync.PROTOCOL?this.file.redirectToNewApp(mxUtils.bind(this,function(){})):e.v===DrawioFileSync.PROTOCOL&&null!=e.d&&this.handleMessageData(e.d))}catch(t){this.isConnected()&&this.fileChangedNotify()}})},DrawioFileSync.PROTOCOL=6,mxUtils.extend(DrawioFileSync,mxEventSource),DrawioFileSync.prototype.maxCacheEntrySize=1e6,DrawioFileSync.prototype.enabled=!0,DrawioFileSync.prototype.updateStatusInterval=1e4,DrawioFileSync.prototype.channelId=null,DrawioFileSync.prototype.channel=null,DrawioFileSync.prototype.catchupRetryCount=0,DrawioFileSync.prototype.maxCatchupRetries=15,DrawioFileSync.prototype.maxCacheReadyRetries=1,DrawioFileSync.prototype.cacheReadyDelay=700,DrawioFileSync.prototype.maxOptimisticReloadRetries=6,DrawioFileSync.prototype.inactivityTimeoutSeconds=1800,DrawioFileSync.prototype.lastActivity=null,DrawioFileSync.prototype.start=function(){if(null==this.channelId&&(this.channelId=this.file.getChannelId()),null==this.key&&(this.key=this.file.getChannelKey()),null==this.pusher&&null!=this.channelId&&"hidden"!=document.visibilityState){if(this.pusher=this.ui.getPusher(),null!=this.pusher){try{null!=this.pusher.connection&&this.pusher.connection.bind("error",this.pusherErrorListener)}catch(t){}try{this.pusher.connect(),this.channel=this.pusher.subscribe(this.channelId),EditorUi.debug("Sync.start",[this,"v"+DrawioFileSync.PROTOCOL],"rev",this.file.getCurrentRevisionId())}catch(t){}this.installListeners()}window.setTimeout(mxUtils.bind(this,function(){this.lastModified=this.file.getLastModifiedDate(),this.lastActivity=new Date,this.resetUpdateStatusThread(),this.updateOnlineState(),this.updateStatus()},0))}},DrawioFileSync.prototype.isConnected=function(){return null!=this.pusher&&null!=this.pusher.connection&&"connected"==this.pusher.connection.state},DrawioFileSync.prototype.updateOnlineState=function(){var t,e;"1"!=urlParams.embedRT&&(t=mxUtils.bind(this,function(t){mxEvent.addListener(t,"click",mxUtils.bind(this,function(t){this.enabled=!this.enabled,this.ui.updateButtonContainer(),this.resetUpdateStatusThread(),this.updateOnlineState(),this.updateStatus(),!this.file.inConflictState&&this.enabled&&this.fileChangedNotify()}))}),"min"==uiTheme&&null!=this.ui.buttonContainer&&"1"!=urlParams.sketch?null==this.collaboratorsElement&&((e=document.createElement("a")).className="geToolbarButton",e.style.cssText="display:inline-block;position:relative;box-sizing:border-box;margin-right:4px;cursor:pointer;float:left;",e.style.backgroundPosition="center center",e.style.backgroundRepeat="no-repeat",e.style.backgroundSize="24px 24px",e.style.height="24px",e.style.width="24px",t(e),this.ui.buttonContainer.appendChild(e),this.collaboratorsElement=e):null!=this.ui.toolbarContainer&&null==this.collaboratorsElement&&((e=document.createElement("a")).className="geButton",e.style.position="absolute",e.style.display="inline-block",e.style.verticalAlign="bottom",e.style.color="#666",e.style.top="6px",e.style.right="atlas"!=uiTheme?"70px":"50px",e.style.padding="2px",e.style.fontSize="8pt",e.style.verticalAlign="middle",e.style.textDecoration="none",e.style.backgroundPosition="center center",e.style.backgroundRepeat="no-repeat",e.style.backgroundSize="16px 16px",e.style.width="16px",e.style.height="16px",mxUtils.setOpacity(e,60),"dark"==uiTheme&&(e.style.filter="invert(100%)"),mxEvent.addListener(e,mxClient.IS_POINTER?"pointerdown":"mousedown",mxUtils.bind(this,function(t){t.preventDefault()})),t(e),this.ui.toolbarContainer.appendChild(e),this.collaboratorsElement=e),null!=this.collaboratorsElement&&(e="",e=this.enabled?this.file.invalidChecksum?mxResources.get("error")+": "+mxResources.get("checksum"):this.ui.isOffline(!0)||!this.isConnected()?mxResources.get("offline"):mxResources.get("online"):mxResources.get("disconnected"),this.collaboratorsElement.setAttribute("title",e),this.collaboratorsElement.style.backgroundImage="url("+(this.enabled?this.ui.isOffline(!0)||!this.isConnected()||this.file.invalidChecksum?Editor.syncProblemImage:Editor.syncImage:Editor.syncDisabledImage)+")"))},DrawioFileSync.prototype.updateStatus=function(){var t,e,i,s;this.isConnected()&&null!=this.lastActivity&&((new Date).getTime()-this.lastActivity.getTime())/1e3>this.inactivityTimeoutSeconds&&this.stop(),this.file.isModified()||this.file.inConflictState||null!=this.file.autosaveThread||this.file.savingFile||this.file.redirectDialogShowing||(this.enabled&&null!=this.ui.statusContainer?(null==(e=this.ui.timeSince(new Date(this.lastModified)))&&(e=mxResources.get("lessThanAMinute")),t=this.file.isRevisionHistorySupported(),i=this.lastMessage,(this.lastMessage=null)!=i&&40<i.length&&(i=i.substring(0,40)+"..."),e=mxResources.get("lastChange",[e]),this.ui.editor.setStatus('<div title="'+mxUtils.htmlEntities(e)+'">'+mxUtils.htmlEntities(e)+"</div>"+(this.file.isEditable()?"":'<div class="geStatusAlert">'+mxUtils.htmlEntities(mxResources.get("readOnly"))+"</div>")+(this.isConnected()?"":'<div class="geStatusAlert">'+mxUtils.htmlEntities(mxResources.get("disconnected"))+"</div>")+(null!=i?' <span title="'+mxUtils.htmlEntities(i)+'">('+mxUtils.htmlEntities(i)+")</span>":"")),0<(i=this.ui.statusContainer.getElementsByTagName("div")).length&&t&&(i[0].style.display="inline-block",t&&(i[0].style.cursor="pointer",i[0].style.textDecoration="underline",mxEvent.addListener(i[0],"click",mxUtils.bind(this,function(){this.ui.actions.get("revisionHistory").funct()})))),0<(i=this.ui.statusContainer.getElementsByTagName("span")).length&&((s=i[0]).style.opacity="0",mxUtils.setPrefixedStyle(s.style,"transition","all 0.2s ease"),window.setTimeout(mxUtils.bind(this,function(){mxUtils.setOpacity(s,100),mxUtils.setPrefixedStyle(s.style,"transition","all 1s ease"),window.setTimeout(mxUtils.bind(this,function(){mxUtils.setOpacity(s,0)}),this.updateStatusInterval/2)}),0)),this.resetUpdateStatusThread()):this.file.addAllSavedStatus())},DrawioFileSync.prototype.resetUpdateStatusThread=function(){null!=this.updateStatusThread&&window.clearInterval(this.updateStatusThread),null!=this.channel&&(this.updateStatusThread=window.setInterval(mxUtils.bind(this,function(){this.updateStatus()}),this.updateStatusInterval))},DrawioFileSync.prototype.installListeners=function(){null!=this.pusher&&null!=this.pusher.connection&&this.pusher.connection.bind("state_change",this.connectionListener),null!=this.channel&&this.channel.bind("changed",this.changeListener)},DrawioFileSync.prototype.handleMessageData=function(t){var e;"desc"==t.a?this.file.savingFile||this.reloadDescriptor():"join"==t.a||"leave"==t.a?("join"==t.a&&this.file.stats.joined++,null!=t.name&&(this.lastMessage=mxResources.get("join"==t.a?"userJoined":"userLeft",[decodeURIComponent(t.name)]),this.resetUpdateStatusThread(),this.updateStatus())):null!=t.m&&(e=new Date(t.m),(null==this.lastMessageModified||this.lastMessageModified<e)&&(this.lastMessageModified=e,this.fileChangedNotify(t)))},DrawioFileSync.prototype.isValidState=function(){return this.ui.getCurrentFile()==this.file&&this.file.sync==this&&!this.file.invalidChecksum&&!this.file.redirectDialogShowing},DrawioFileSync.prototype.optimisticSync=function(i){null==this.reloadThread&&((i=null!=i?i:0)<this.maxOptimisticReloadRetries&&(this.reloadThread=window.setTimeout(mxUtils.bind(this,function(){this.file.getLatestVersion(mxUtils.bind(this,function(t){var e;(this.reloadThread=null)!=t&&(e=t.getCurrentRevisionId(),this.file.getCurrentRevisionId()==e?this.optimisticSync(i+1):this.file.mergeFile(t,mxUtils.bind(this,function(){this.lastModified=this.file.getLastModifiedDate(),this.updateStatus()})))}),mxUtils.bind(this,function(){this.reloadThread=null}))}),(i+1)*this.file.optimisticSyncDelay)),"1"==urlParams.test&&EditorUi.debug("Sync.optimisticSync",[this],"retryCount",i))},DrawioFileSync.prototype.fileChangedNotify=function(t){var e;this.isValidState()&&(this.file.savingFile?this.remoteFileChanged=!0:null!=t&&"optimistic"==t.type?this.optimisticSync():e=this.fileChanged(mxUtils.bind(this,function(t){this.updateStatus()}),mxUtils.bind(this,function(t){this.file.handleFileError(t)}),mxUtils.bind(this,function(){return!this.file.savingFile&&this.notifyThread!=e}),!0))},DrawioFileSync.prototype.fileChanged=function(e,i,s,t){t=window.setTimeout(mxUtils.bind(this,function(){null!=s&&s()||(this.isValidState()?this.file.loadPatchDescriptor(mxUtils.bind(this,function(t){null!=s&&s()||(this.isValidState()?this.catchup(t,e,i,s):null!=i&&i())}),i):null!=i&&i())}),t?this.cacheReadyDelay:0);return this.notifyThread=t},DrawioFileSync.prototype.reloadDescriptor=function(){this.file.loadDescriptor(mxUtils.bind(this,function(t){null!=t?(this.file.setDescriptorRevisionId(t,this.file.getCurrentRevisionId()),this.updateDescriptor(t),this.fileChangedNotify()):(this.file.inConflictState=!0,this.file.handleFileError())}),mxUtils.bind(this,function(t){this.file.inConflictState=!0,this.file.handleFileError(t)}))},DrawioFileSync.prototype.updateDescriptor=function(t){this.file.setDescriptor(t),this.file.descriptorChanged(),this.start()},DrawioFileSync.prototype.p2pCatchup=function(t,e,i,s,n,l,o,a){if(null!=n&&(null==a||!a())){this.file.getDescriptorRevisionId(n),this.file.getCurrentRevisionId();if(this.isValidState()){this.file.getDescriptorSecret(n);if(null==a||!a()){this.file.stats.bytesReceived+=t.length;var r=null,h=[];try{var c=[t];if(null!=c&&0<c.length)for(var u=0;u<c.length;u++){var d=this.stringToObject(c[u]);if(d.v>DrawioFileSync.PROTOCOL){failed=!0,h=[];break}if(d.v!==DrawioFileSync.PROTOCOL||null==d.d){failed=!0,h=[];break}r=d.d.checksum,h.push(d.d.patch)}}catch(t){h=[],null!=window.console&&"1"==urlParams.test&&console.log(t)}try{0<h.length?(this.file.stats.cacheHits++,this.merge(h,r,n,l,o,a)):(this.file.stats.cacheFail++,this.reload(l,o,a))}catch(t){null!=o&&o(t)}}}else null!=o&&o()}},DrawioFileSync.prototype.catchup=function(r,h,c,u){var t,d,e,m,p,f;null==r||null!=u&&u()||(t=this.file.getDescriptorRevisionId(r),(d=this.file.getCurrentRevisionId())==t?(this.file.patchDescriptor(this.file.getDescriptor(),r),null!=h&&h()):this.isValidState()?null==(e=this.file.getDescriptorSecret(r))||"1"==urlParams.lockdown?this.reload(h,c,u):(m=0,p=!1,f=mxUtils.bind(this,function(){var o,a;null!=u&&u()||(d!=this.file.getCurrentRevisionId()?null!=h&&h():this.isValidState()?(o=!0,a=window.setTimeout(mxUtils.bind(this,function(){o=!1,this.reload(h,c,u)}),this.ui.timeout),mxUtils.get(EditorUi.cacheUrl+"?id="+encodeURIComponent(this.channelId)+"&from="+encodeURIComponent(d)+"&to="+encodeURIComponent(t)+(null!=e?"&secret="+encodeURIComponent(e):""),mxUtils.bind(this,function(t){if(this.file.stats.bytesReceived+=t.getText().length,window.clearTimeout(a),o&&(null==u||!u()))if(d!=this.file.getCurrentRevisionId())null!=h&&h();else if(this.isValidState()){var e=null,i=[];if(200<=t.getStatus()&&t.getStatus()<=299&&0<t.getText().length)try{var s=JSON.parse(t.getText());if(null!=s&&0<s.length)for(var n=0;n<s.length;n++){var l=this.stringToObject(s[n]);if(l.v>DrawioFileSync.PROTOCOL){p=!0,i=[];break}if(l.v!==DrawioFileSync.PROTOCOL||null==l.d){p=!0,i=[];break}e=l.d.checksum,i.push(l.d.patch)}}catch(t){i=[],null!=window.console&&"1"==urlParams.test&&console.log(t)}try{0<i.length?(this.file.stats.cacheHits++,this.merge(i,e,r,h,c,u)):m<=this.maxCacheReadyRetries-1&&!p&&401!=t.getStatus()&&503!=t.getStatus()?(m++,this.file.stats.cacheMiss++,window.setTimeout(f,(m+1)*this.cacheReadyDelay)):(this.file.stats.cacheFail++,this.reload(h,c,u))}catch(t){null!=c&&c(t)}}else null!=c&&c()}))):null!=c&&c())}),window.setTimeout(f,this.cacheReadyDelay)):null!=c&&c())},DrawioFileSync.prototype.reload=function(t,e,i,s){this.file.updateFile(mxUtils.bind(this,function(){this.lastModified=this.file.getLastModifiedDate(),this.updateStatus(),this.start(),null!=t&&t()}),mxUtils.bind(this,function(t){null!=e&&e(t)}),i,s)},DrawioFileSync.prototype.merge=function(e,i,t,s,n,l){try{this.file.stats.merged++,this.lastModified=new Date,this.file.shadowPages=null!=this.file.shadowPages?this.file.shadowPages:this.ui.getPagesForNode(mxUtils.parseXml(this.file.shadowData).documentElement),this.file.backupPatch=this.file.isModified()?this.ui.diffPages(this.file.shadowPages,this.ui.pages):null;var o=this.file.ignorePatches(e),a=this.file.getDescriptorRevisionId(t);if(!o){for(var r=0;r<e.length;r++)this.file.shadowPages=this.ui.patchPages(this.file.shadowPages,e[r]);var h=null!=i?this.ui.getHashValueForPages(this.file.shadowPages):null;if("1"==urlParams.test&&EditorUi.debug("Sync.merge",[this],"from",this.file.getCurrentRevisionId(),"to",a,"etag",this.file.getDescriptorEtag(t),"backup",this.file.backupPatch,"attempt",this.catchupRetryCount,"patches",e,"checksum",i==h,i),null!=i&&i!=h){var c=this.ui.hashValue(this.file.getCurrentRevisionId()),u=this.ui.hashValue(a);return void this.file.checksumError(n,e,"From: "+c+"\nTo: "+u+"\nChecksum: "+i+"\nCurrent: "+h,a,"merge")}this.file.patch(e,DrawioFile.LAST_WRITE_WINS?this.file.backupPatch:null)}this.file.invalidChecksum=!1,this.file.inConflictState=!1,this.file.patchDescriptor(this.file.getDescriptor(),t),(this.file.backupPatch=null)!=s&&s()}catch(t){this.file.inConflictState=!0,this.file.invalidChecksum=!0,this.file.descriptorChanged(),null!=n&&n(t);try{var d,m;this.file.errorReportsEnabled?(c=this.ui.hashValue(this.file.getCurrentRevisionId()),u=this.ui.hashValue(a),this.file.sendErrorReport("Error in merge","From: "+c+"\nTo: "+u+"\nChecksum: "+i+"\nPatches:\n"+this.file.compressReportData(JSON.stringify(e,null,2)),t)):(m=null!=(d=this.file.getCurrentUser())?d.id:"unknown",EditorUi.logError("Error in merge",null,this.file.getMode()+"."+this.file.getId(),m,t))}catch(t){}}},DrawioFileSync.prototype.descriptorChanged=function(t){var e,i,s;this.lastModified=this.file.getLastModifiedDate(),null!=this.channelId&&(e=this.objectToString(this.createMessage({a:"desc",m:this.lastModified.getTime()})),i=this.file.getCurrentRevisionId(),s=this.objectToString({}),mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&from="+encodeURIComponent(t)+"&to="+encodeURIComponent(i)+"&msg="+encodeURIComponent(e)+"&data="+encodeURIComponent(s)),this.file.stats.bytesSent+=s.length,this.file.stats.msgSent++),this.updateStatus()},DrawioFileSync.prototype.objectToString=function(t){t=Graph.compress(JSON.stringify(t));return t=null!=this.key&&"undefined"!=typeof CryptoJS?CryptoJS.AES.encrypt(t,this.key).toString():t},DrawioFileSync.prototype.stringToObject=function(t){return null!=this.key&&"undefined"!=typeof CryptoJS&&(t=CryptoJS.AES.decrypt(t,this.key).toString(CryptoJS.enc.Utf8)),JSON.parse(Graph.decompress(t))},DrawioFileSync.prototype.createToken=function(t,e,i){var s=!0,n=window.setTimeout(mxUtils.bind(this,function(){s=!1,i({code:App.ERROR_TIMEOUT,message:mxResources.get("timeout")})}),this.ui.timeout);mxUtils.get(EditorUi.cacheUrl+"?id="+encodeURIComponent(this.channelId)+"&secret="+encodeURIComponent(t),mxUtils.bind(this,function(t){window.clearTimeout(n),s&&(200<=t.getStatus()&&t.getStatus()<=299?e(t.getText()):i({code:t.getStatus(),message:"Token Error "+t.getStatus()}))}))},DrawioFileSync.prototype.fileSaving=function(){var t=this.objectToString(this.createMessage({m:(new Date).getTime(),type:"optimistic"}));mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&msg="+encodeURIComponent(t),function(){})},DrawioFileSync.prototype.sendFileChanges=function(t,e){this.lastModified=this.file.getLastModifiedDate();var i=this.objectToString(this.createMessage({m:this.lastModified.getTime()})),s=this.file.getDescriptorSecret(this.file.getDescriptor()),n=this.file.getDescriptorRevisionId(e),l=this.file.getCurrentRevisionId(),o=null!=this.file.shadowPages?this.file.shadowPages:this.ui.getPagesForNode(mxUtils.parseXml(this.file.shadowData).documentElement),a=this.file.getDescriptorSecret(e),e=this.ui.getHashValueForPages(t),t=this.ui.diffPages(o,t),e=this.objectToString(this.createMessage({patch:t,checksum:e}));this.file.p2pCollab.sendMessage("diff",{id:this.channelId,from:n,to:l,msg:i,secret:s,lastSecret:a,data:e})},DrawioFileSync.prototype.fileSaved=function(t,e,i,s,n){var l,o,a,r,h,c,u,d,m;this.lastModified=this.file.getLastModifiedDate(),this.resetUpdateStatusThread(),this.catchupRetryCount=0,this.ui.isOffline(!0)||this.file.inConflictState||this.file.redirectDialogShowing||(this.start(),null!=this.channelId&&(l=this.objectToString(this.createMessage({m:this.lastModified.getTime()})),o=this.file.getDescriptorSecret(this.file.getDescriptor()),a=this.file.getDescriptorRevisionId(e),r=this.file.getCurrentRevisionId(),null==o||"1"==urlParams.lockdown?(this.file.stats.msgSent++,mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&msg="+encodeURIComponent(l),function(){}),null!=i&&i(),"1"==urlParams.test&&EditorUi.debug("Sync.fileSaved",[this],"from",a,"to",r,"etag",this.file.getCurrentEtag(),"notify")):(u=null!=this.file.shadowPages?this.file.shadowPages:this.ui.getPagesForNode(mxUtils.parseXml(this.file.shadowData).documentElement),h=this.file.getDescriptorSecret(e),c=this.ui.getHashValueForPages(t),e=this.ui.diffPages(u,t),u=this.objectToString(this.createMessage({patch:e,checksum:c})),this.file.stats.bytesSent+=u.length,this.file.stats.msgSent++,d=!0,m=window.setTimeout(mxUtils.bind(this,function(){d=!1,s({code:App.ERROR_TIMEOUT,message:mxResources.get("timeout")})}),this.ui.timeout),mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&from="+encodeURIComponent(a)+"&to="+encodeURIComponent(r)+"&msg="+encodeURIComponent(l)+(null!=o?"&secret="+encodeURIComponent(o):"")+(null!=h?"&last-secret="+encodeURIComponent(h):"")+(u.length<this.maxCacheEntrySize?"&data="+encodeURIComponent(u):"")+(null!=n?"&token="+encodeURIComponent(n):""),mxUtils.bind(this,function(t){window.clearTimeout(m),d&&(200<=t.getStatus()&&t.getStatus()<=299?null!=i&&i():s({code:t.getStatus(),message:t.getStatus()}))})),"1"==urlParams.test&&EditorUi.debug("Sync.fileSaved",[this],"from",a,"to",r,"etag",this.file.getCurrentEtag(),u.length,"bytes","diff",e,"checksum",c)))),this.file.shadowPages=t},DrawioFileSync.prototype.getIdParameters=function(){var t="id="+this.channelId;return null!=this.pusher&&null!=this.pusher.connection&&null!=this.pusher.connection.socket_id&&(t+="&sid="+this.pusher.connection.socket_id),t},DrawioFileSync.prototype.createMessage=function(t){return{v:DrawioFileSync.PROTOCOL,d:t,c:this.clientId}},DrawioFileSync.prototype.fileConflict=function(t,e,i){this.catchupRetryCount++,this.catchupRetryCount<this.maxCatchupRetries?(this.file.stats.conflicts++,null!=t?this.catchup(t,e,i):this.fileChanged(e,i)):(this.file.stats.timeouts++,this.catchupRetryCount=0,null!=i&&i({code:App.ERROR_TIMEOUT,message:mxResources.get("timeout")}))},DrawioFileSync.prototype.stop=function(){null!=this.pusher&&(EditorUi.debug("Sync.stop",[this]),null!=this.pusher.connection&&(this.pusher.connection.unbind("state_change",this.connectionListener),this.pusher.connection.unbind("error",this.pusherErrorListener)),null!=this.channel&&(this.channel.unbind("changed",this.changeListener),this.channel=null),this.pusher.disconnect(),this.pusher=null),this.updateOnlineState(),this.updateStatus()},DrawioFileSync.prototype.destroy=function(){var t,e;null!=this.channelId&&(e={a:"leave"},null!=(t=this.file.getCurrentUser())&&(e.name=encodeURIComponent(t.displayName),e.uid=t.id),mxUtils.post(EditorUi.cacheUrl,this.getIdParameters()+"&msg="+encodeURIComponent(this.objectToString(this.createMessage(e)))),this.file.stats.msgSent++),this.stop(),null!=this.updateStatusThread&&(window.clearInterval(this.updateStatusThread),this.updateStatusThread=null),null!=this.onlineListener&&(mxEvent.removeListener(window,"online",this.onlineListener),this.onlineListener=null),null!=this.visibleListener&&(mxEvent.removeListener(document,"visibilitychange",this.visibleListener),this.visibleListener=null),null!=this.activityListener&&(mxEvent.removeListener(document,mxClient.IS_POINTER?"pointermove":"mousemove",this.activityListener),mxEvent.removeListener(document,"keypress",this.activityListener),mxEvent.removeListener(window,"focus",this.activityListener),!mxClient.IS_POINTER&&mxClient.IS_TOUCH&&(mxEvent.removeListener(document,"touchstart",this.activityListener),mxEvent.removeListener(document,"touchmove",this.activityListener)),this.activityListener=null),null!=this.collaboratorsElement&&(this.collaboratorsElement.parentNode.removeChild(this.collaboratorsElement),this.collaboratorsElement=null)};