# DbGate 打包后一闪退出问题解决方案

## 问题现象

打包后的 exe 文件运行后一闪就退出，无法正常启动。

## 问题原因

**核心问题**：打包后的 `win-unpacked` 目录中缺少 `packages` 目录。

检查结果：
- ✅ 源目录 `app/packages` 存在
- ❌ 打包后 `app/dist/win-unpacked/packages` **不存在**
- ✅ 只有 `resources/app.asar` 文件

**原因分析**：
1. `packages` 目录被打包进了 `app.asar` 文件
2. 但 Electron 代码中使用 `__dirname` 路径可能无法正确访问 asar 中的文件
3. 或者 `files` 配置有问题，`packages` 没有被正确包含

## 解决方案

### 方案一：将 packages 目录排除 asar 打包（推荐）

修改 `app/package.json` 的 `build` 配置：

```json
{
  "build": {
    "asarUnpack": [
      "**/*.node",
      "packages/**/*"  // 将 packages 目录排除 asar
    ],
    "files": [
      "packages",
      "src",
      "icon.png",
      "!node_modules/cpu-features/build/**"
    ]
  }
}
```

### 方案二：修改代码以支持 asar 路径

如果 packages 在 asar 中，需要修改路径解析方式。

### 方案三：检查 predist 是否正确执行

确保打包前执行了 `predist`：

```bash
cd app
yarn predist  # 确保 packages 目录存在
yarn dist
```

## 验证步骤

### 1. 检查源目录

```bash
cd app
# 应该能看到这些文件
Test-Path packages/api/dist/bundle.js
Test-Path packages/web/public/index.html
```

### 2. 检查打包后目录

```bash
cd app/dist/win-unpacked
# 应该能看到 packages 目录
Test-Path packages
Test-Path packages/api/dist/bundle.js
Test-Path packages/web/public/index.html
```

### 3. 查看错误日志

如果应用崩溃，查看日志：

**Windows 日志位置**：
- `%APPDATA%\dbgate\logs\`
- 或运行：`DbGate.exe --debug` 查看控制台输出

## 快速修复

### 步骤 1：修改配置

在 `app/package.json` 中添加 `asarUnpack`：

```json
"build": {
  "asarUnpack": [
    "**/*.node",
    "packages/**/*"
  ],
  ...
}
```

### 步骤 2：重新打包

```bash
cd app
yarn predist  # 确保文件存在
yarn dist
```

### 步骤 3：验证

```bash
cd app/dist/win-unpacked
# 检查 packages 目录是否存在
dir packages
```

## 调试方法

### 方法 1：命令行运行查看错误

```bash
cd app/dist/win-unpacked
DbGate.exe --debug
```

### 方法 2：检查 asar 内容

```bash
# 安装 asar 工具
npm install -g asar

# 解压查看内容
cd app/dist/win-unpacked/resources
asar list app.asar | findstr packages
```

### 方法 3：临时禁用 asar 测试

在 `app/package.json` 中：

```json
"build": {
  "asar": false,  // 临时禁用 asar
  ...
}
```

重新打包后测试是否能正常运行。

## 常见问题

### Q: 为什么 packages 没有被打包？

A: 可能原因：
1. `files` 配置不正确
2. `predist` 没有执行
3. `packages` 目录在打包时不存在

### Q: asar 中的文件如何访问？

A: Electron 可以访问 asar 中的文件，但需要注意：
- 使用 `require()` 可以访问
- 使用 `fs.readFile()` 需要特殊处理
- 某些原生模块可能无法从 asar 中加载

### Q: 如何确认问题？

A: 
1. 检查 `win-unpacked` 目录结构
2. 查看错误日志
3. 使用 `--debug` 参数运行
4. 检查 `app.asar` 内容

## 推荐配置

```json
{
  "build": {
    "asar": true,
    "asarUnpack": [
      "**/*.node",
      "packages/**/*"
    ],
    "files": [
      "packages",
      "src",
      "icon.png",
      "!node_modules/cpu-features/build/**"
    ]
  }
}
```

这样配置后：
- `packages` 目录会被解压到 `resources/app.asar.unpacked/`
- 代码可以通过 `__dirname` 访问
- 原生模块可以正常工作

