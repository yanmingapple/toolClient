# DbGate 打包问题解决方案

## 问题描述

打包成功后生成了多个 exe 文件，但安装后无法运行。

## 问题原因

1. **多个 exe 文件的原因**：
   - 配置中指定了多个架构（x64 和 arm64）
   - 每个架构都会生成独立的安装程序

2. **无法运行的原因**：
   - `build` 脚本缺少 `predist` 步骤
   - 打包时 `packages` 目录可能缺少必要的文件

## 解决方案

### ✅ 已修复：build 脚本

已修改 `app/package.json` 中的 `build` 脚本，添加了 `predist` 步骤：

```json
"build": "cd ../packages/api && yarn build && cd ../web && yarn build && cd ../../app && yarn predist && yarn dist"
```

### 使用正确的安装程序

**重要**：根据你的系统架构选择正确的 exe 文件：

- **x64 系统（大多数 Windows 电脑）**：
  - 使用：`dbgate-7.0.0-alpha.1-win_x64.exe`
  - **不要使用** `dbgate-7.0.0-alpha.1-win.exe`

- **ARM64 系统（Surface Pro X 等）**：
  - 使用：`dbgate-7.0.0-alpha.1-win_arm64.exe`

### 正确的打包流程

```bash
# 在项目根目录
cd F:\workspace\toolClient\dbgate-master

# 方法一：使用修复后的 build 脚本（推荐）
yarn build:app

# 方法二：手动分步执行
# 1. 构建依赖
yarn build:lib
yarn build:plugins:frontend
yarn build:api
yarn build:web
yarn plugins:copydist

# 2. 进入 app 目录并打包
cd app
yarn predist  # 准备文件（重要！）
yarn dist     # 打包
```

### 验证打包结果

打包前检查：

```bash
cd app
# 检查这些文件是否存在
Test-Path packages/api/dist/bundle.js
Test-Path packages/web/public/index.html
Test-Path packages/web/public/build/bundle.js
```

### 如果还是无法运行

1. **检查安装路径**：
   - 默认：`C:\Users\<用户名>\AppData\Local\Programs\dbgate\`
   - 检查该目录下是否有 `packages` 文件夹

2. **查看错误日志**：
   - 路径：`%APPDATA%\dbgate\logs\`
   - 或运行：`dbgate.exe --debug`

3. **使用便携版测试**：
   - 解压 `dbgate-7.0.0-alpha.1-win_x64.zip`
   - 直接运行 `dbgate.exe`
   - 如果便携版可以运行，说明是安装程序的问题

4. **重新打包（只打包 x64）**：
   ```bash
   cd app
   yarn predist
   yarn dist --win --x64  # 只打包 x64 架构
   ```

### 只打包单个架构（可选）

如果想只打包 x64 架构，修改 `app/package.json`：

```json
"win": {
  "target": [
    {
      "target": "nsis",
      "arch": ["x64"]  // 只打包 x64
    },
    {
      "target": "zip",
      "arch": ["x64"]
    }
  ]
}
```

这样只会生成一个 exe 文件。

## 快速修复命令

```bash
# 重新打包（使用修复后的脚本）
cd F:\workspace\toolClient\dbgate-master\app
yarn predist
yarn dist --win --x64  # 只打包 x64
```

## 总结

1. ✅ **已修复**：`build` 脚本现在包含 `predist` 步骤
2. ✅ **使用正确版本**：x64 系统使用 `win_x64.exe`
3. ✅ **验证文件**：打包前检查 `packages` 目录
4. ✅ **可选优化**：只打包需要的架构

