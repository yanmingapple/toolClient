# DbGate 打包问题排查指南

## 问题：打包成功但安装后无法运行

### 问题分析

从打包输出可以看到有多个 exe 文件：
- `dbgate-7.0.0-alpha.1-win.exe` (201MB) - **通用版本，可能有问题**
- `dbgate-7.0.0-alpha.1-win_x64.exe` (100MB) - **x64 架构，应该使用这个**
- `dbgate-7.0.0-alpha.1-win_arm64.exe` (102MB) - **ARM64 架构**

### 解决方案

#### 1. 使用正确的安装程序

**对于大多数 Windows 电脑（x64 架构）：**
- 使用：`dbgate-7.0.0-alpha.1-win_x64.exe`
- **不要使用** `dbgate-7.0.0-alpha.1-win.exe`（这个文件可能有问题）

**对于 ARM64 架构的 Windows 电脑：**
- 使用：`dbgate-7.0.0-alpha.1-win_arm64.exe`

#### 2. 检查打包流程

当前的 `build` 脚本可能缺少 `predist` 步骤：

```json
"build": "cd ../packages/api && yarn build && cd ../web && yarn build && cd ../../app && yarn dist"
```

**问题**：这个脚本没有执行 `predist`，导致 `packages` 目录可能缺少文件。

#### 3. 正确的打包流程

应该先执行 `predist` 准备文件，然后再打包：

```bash
# 方法一：使用修复后的脚本
cd app
yarn build:fixed

# 方法二：手动执行
cd app
yarn predist  # 复制文件到 packages 目录
yarn dist     # 打包
```

### 修复打包脚本

#### 方案一：修改 build 脚本（推荐）

在 `app/package.json` 中修改：

```json
"build": "cd ../packages/api && yarn build && cd ../web && yarn build && cd ../../app && yarn predist && yarn dist"
```

#### 方案二：使用 build:local + dist

```bash
# 1. 准备文件
yarn build:local

# 2. 打包
cd app
yarn dist
```

### 验证打包文件

打包前检查 `app/packages` 目录是否包含：

```
app/packages/
├── api/
│   └── dist/
│       └── bundle.js          # ✅ 必须存在
├── web/
│   └── public/
│       ├── index.html         # ✅ 必须存在
│       ├── build/
│       │   ├── bundle.js       # ✅ 必须存在
│       │   └── bundle.css     # ✅ 必须存在
│       └── ...
└── plugins/
    └── ...                    # ✅ 插件文件
```

### 常见问题

#### Q1: 安装后点击没反应？

**可能原因：**
1. 使用了错误的 exe 文件（应该用 `win_x64.exe`）
2. `packages` 目录缺少文件
3. 防病毒软件拦截

**解决：**
1. 使用正确的架构版本
2. 检查打包前是否执行了 `predist`
3. 临时关闭防病毒软件测试

#### Q2: 为什么有多个 exe 文件？

**原因：**
- electron-builder 配置了多个架构（x64 和 arm64）
- 每个架构都会生成独立的安装程序

**建议：**
- 只打包当前需要的架构，修改配置：

```json
"win": {
  "target": [
    {
      "target": "nsis",
      "arch": ["x64"]  // 只打包 x64
    }
  ]
}
```

#### Q3: 打包后文件太大？

**原因：**
- 包含了多个架构的版本
- 包含了开发依赖

**优化：**
1. 只打包需要的架构
2. 检查 `files` 配置，排除不必要的文件

### 调试步骤

1. **检查打包前的文件：**
   ```bash
   cd app
   ls packages/api/dist/bundle.js
   ls packages/web/public/index.html
   ```

2. **检查打包后的文件：**
   ```bash
   # 解压或安装后检查
   # 应该能找到这些文件
   ```

3. **查看错误日志：**
   - Windows: `%APPDATA%\dbgate\logs\`
   - 或运行：`dbgate.exe --debug`

4. **测试未打包版本：**
   ```bash
   cd app
   yarn start:local  # 使用打包后的文件测试
   ```

### 推荐的打包命令

```bash
# 在项目根目录
cd F:\workspace\toolClient\dbgate-master

# 1. 构建所有依赖
yarn build:lib
yarn build:plugins:frontend
yarn build:api
yarn build:web
yarn plugins:copydist

# 2. 进入 app 目录
cd app

# 3. 准备文件（重要！）
yarn predist

# 4. 验证文件存在
# 检查 packages/api/dist/bundle.js
# 检查 packages/web/public/index.html

# 5. 打包
yarn dist

# 6. 使用正确的安装程序
# 对于 x64 系统：dbgate-7.0.0-alpha.1-win_x64.exe
```

### 快速修复

如果已经打包但无法运行，尝试：

1. **重新打包（使用正确的流程）：**
   ```bash
   cd app
   yarn predist  # 确保文件已复制
   yarn dist --win --x64  # 只打包 x64
   ```

2. **使用便携版测试：**
   - 解压 `dbgate-7.0.0-alpha.1-win_x64.zip`
   - 运行 `dbgate.exe`
   - 如果便携版可以运行，说明是安装程序的问题

3. **检查安装路径：**
   - 默认安装路径：`C:\Users\<用户名>\AppData\Local\Programs\dbgate\`
   - 检查该目录下是否有 `packages` 文件夹

