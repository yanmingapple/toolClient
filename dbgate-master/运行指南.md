# DbGate 项目运行指南

## ⚠️ 已修复的问题

1. ✅ 修复了 TypeScript 编译错误（缺少 @types/ms）
2. ✅ 修复了 TypeScript 配置问题（target 和 lib 版本）
3. ✅ 修复了 JWT token 验证错误（开发环境使用固定 secret）
4. ✅ 修复了插件文件缺失问题（构建了所有插件的 frontend.js）

## 一、环境要求

### 1. Node.js 版本
- 推荐版本：**v16.14.2** 或 **v24.4.1**
- 当前检测到：v22.18.0（已测试可用，但建议使用推荐版本）

### 2. 包管理器
- 使用 **Yarn**（推荐）或 npm
- 项目使用 Yarn Workspaces

### 3. Windows 系统要求
- 可选：Visual Studio Build Tools（用于编译原生模块，可选依赖失败不影响运行）

## 二、安装步骤

### 方式一：简单启动（Web 应用）

```bash
# 1. 安装依赖
yarn

# 2. 启动（会自动启动 API 和 Web）
yarn start
```

访问：http://localhost:5001

### 方式二：分别启动（更灵活）

```bash
# 1. 安装依赖
yarn

# 2. 在三个终端分别运行：
# 终端1：启动 API（端口 3000）
yarn start:api

# 终端2：启动 Web 前端（端口 5001）
yarn start:web

# 终端3：监听库文件变化
yarn lib
```

### 方式三：运行 Electron 应用

```bash
# 1. 安装根目录依赖
yarn

# 2. 安装 Electron 应用依赖
cd app
yarn

# 3. 在三个终端分别运行：
# 终端1：启动 Web（静态文件）
cd ..  # 回到根目录
yarn start:web

# 终端2：监听库文件
yarn lib

# 终端3：启动 Electron
cd app
yarn start
```

## 三、常见问题排查

### 问题1：Node.js 版本不匹配

**症状**：启动时出现模块加载错误

**解决**：
```bash
# 使用 nvm 切换到正确版本
nvm install 16.14.2
nvm use 16.14.2

# 或
nvm install 24.4.1
nvm use 24.4.1
```

### 问题2：依赖安装失败

**症状**：`yarn install` 报错

**解决**：
```bash
# 清理缓存
yarn cache clean

# 删除 node_modules 和 lock 文件
rm -rf node_modules yarn.lock
# Windows: rmdir /s node_modules & del yarn.lock

# 重新安装
yarn install
```

### 问题3：端口被占用

**症状**：端口 3000 或 5001 已被占用

**解决**：
```bash
# Windows 查看端口占用
netstat -ano | findstr :3000
netstat -ano | findstr :5001

# 修改端口（在 packages/api/.env 中）
PORT=3001

# 修改 Web 端口（在 packages/web/rollup.config.js 中）
```

### 问题4：构建错误

**症状**：`yarn build:lib` 失败

**解决**：
```bash
# 先构建库文件
yarn build:lib

# 再启动
yarn start
```

### 问题5：缺少 .env 文件

**症状**：API 启动失败，提示找不到配置

**解决**：
```bash
# 在 packages/api 目录下创建 .env 文件
cd packages/api
# .env 文件可以为空，或包含：
# PORT=3000
```

### 问题6：插件构建失败或插件文件缺失

**症状**：
- `ENOENT: no such file or directory, open '...plugins/dbgate-plugin-xxx/dist/frontend.js'`
- 插件加载错误

**解决**：
```bash
# 构建插件前端文件（必须）
yarn build:plugins:frontend

# 如果需要后端插件
yarn build:plugins:backend
```

### 问题7：JWT Token 验证错误

**症状**：
- `DBGM-00098 Sending invalid token error`
- `invalid signature`

**原因**：开发环境每次启动都会生成新的随机 secret，导致之前的 token 失效。

**解决**：
- ✅ **已修复**：开发环境现在使用固定 secret，重启后 token 仍然有效
- 生产环境应设置环境变量 `JWT_SECRET` 来使用固定 secret
- 如果仍有问题，清除浏览器缓存和 localStorage，重新登录

## 四、完整启动流程（推荐）

```bash
# 1. 确保 Node.js 版本正确
node --version  # 推荐 16.14.2 或 24.4.1，v22.18.0 也可用

# 2. 安装依赖
yarn

# 3. 构建库文件（首次运行必须）
yarn build:lib

# 4. 构建插件前端文件（首次运行必须，解决插件加载错误）
yarn build:plugins:frontend

# 5. 启动开发环境
yarn start
```

**注意**：
- 如果看到 Visual Studio 相关的错误，这些是可选依赖的编译错误，可以安全忽略，不影响项目运行。
- 首次运行必须执行步骤 3 和 4，否则会出现插件加载错误。

## 五、验证运行

启动成功后：
- API 服务：http://localhost:3000
- Web 前端：http://localhost:5001
- 打开浏览器访问 http://localhost:5001

## 六、调试模式

```bash
# 调试 API
yarn start:api:debug

# 调试 Electron
yarn start:app:debug
```

## 七、如果还是无法运行

请提供以下信息：
1. Node.js 版本：`node --version`
2. Yarn 版本：`yarn --version`
3. 操作系统：Windows/Linux/Mac
4. 具体错误信息（完整的错误日志）
5. 执行的命令

